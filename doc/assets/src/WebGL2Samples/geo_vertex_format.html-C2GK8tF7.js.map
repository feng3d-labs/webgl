{"version":3,"file":"geo_vertex_format.html-C2GK8tF7.js","sources":["../../../../examples/src/WebGL2Samples/third-party/HalfFloatUtility.ts","../../../../examples/src/WebGL2Samples/geo_vertex_format.ts"],"sourcesContent":["// @ts-ignore\n\nexport const HalfFloat: { encodeFloat16AsInt16: (value: number) => number, Float16Array: (numArray: number[]) => Int16Array } = {};\n\n(function ()\n{\n    let exponent = 0;\n    let mantissa = 0;\n\n    let bits = 0;\n\n    const data64 = new DataView(new ArrayBuffer(8));\n    const data16 = new DataView(new ArrayBuffer(2));\n\n    const UNIT_VALUE = 1 / 1024;\n\n    // http://stackoverflow.com/questions/28688838/convert-a-number-into-a-16-bit-float-stored-as-bytes-and-back\n    // http://croquetweak.blogspot.de/2014/08/deconstructing-floats-frexp-and-ldexp.html\n    function frexp(value)\n    {\n        if (value === 0)\n        {\n            mantissa = 0;\n            exponent = 0;\n\n            return;\n        }\n        data64.setFloat64(0, value);\n        bits = (data64.getUint32(0) >>> 20) & 0x7FF;\n        if (bits === 0)\n        {\n            data64.setFloat64(0, value * Math.pow(2, 64));\n            bits = ((data64.getUint32(0) >>> 20) & 0x7FF) - 64;\n        }\n        exponent = bits - 1022;\n        mantissa = ldexp(value, -exponent);\n    }\n\n    function ldexp(f, e)\n    {\n        // avoid multiplying by infinity and zero\n        return e > 1023 ? f * Math.pow(2, 1023) * Math.pow(2, e - 1023)\n            : e < -1074 ? f * Math.pow(2, -1074) * Math.pow(2, e + 1074) : f * Math.pow(2, e);\n    }\n\n    let signBit;\n    let sign;\n    let exp;\n    let frac;\n\n    HalfFloat.encodeFloat16AsInt16 = function (value: number): number\n    {\n        // Inf unhandled here\n\n        // https://en.wikipedia.org/wiki/Half-precision_floating-point_format\n        frexp(value);\n\n        if (mantissa === 0)\n        {\n            // zero\n            data16.setInt16(0, 0);\n\n            return data16.getInt16(0);\n        }\n\n        signBit = mantissa < 0 ? 1 : 0;\n        sign = signBit << 15;\n        exp = 0;\n        frac = 0;\n\n        if (exponent <= -14)\n        {\n            // subnormal value\n            frac = Math.abs(mantissa * Math.pow(2, exponent + 14)) / UNIT_VALUE;\n            data16.setInt16(0, sign + exp + frac);\n\n            return data16.getInt16(0);\n        }\n\n        // normalized value\n        if (mantissa < 1.0)\n        {\n            mantissa = mantissa * 2 - 1;\n            exponent = exponent - 1;\n        }\n\n        exp = (exponent + 15) << 10;\n        frac = Math.abs(mantissa) / UNIT_VALUE;\n\n        data16.setInt16(0, sign + exp + frac);\n\n        return data16.getInt16(0);\n    };\n\n    /**\n     * Returns a float 16 array buffer which is actually encoded as Int16Array\n     * @param numArray: javaScript number Array\n     */\n    let i;\n\n    HalfFloat.Float16Array = function (numArray: number[]): Int16Array\n    {\n        const float16Array = new Int16Array(new ArrayBuffer(2 * numArray.length));\n        const tmpArray = new Array(numArray.length);\n\n        for (i = 0; i < numArray.length; ++i)\n        {\n            tmpArray[i] = HalfFloat.encodeFloat16AsInt16(numArray[i]);\n        }\n        float16Array.set(tmpArray, 0);\n\n        return float16Array;\n    };\n})();","import { reactive } from '@feng3d/reactivity';\nimport { CanvasContext, RenderObject, RenderPass, RenderPipeline, Sampler, Texture, VertexAttributes } from '@feng3d/render-api';\nimport { WebGL } from '@feng3d/webgl';\nimport { mat4, vec3 } from 'gl-matrix';\nimport { HalfFloat } from './third-party/HalfFloatUtility';\nimport { getShaderSource, loadImage } from './utility';\n\n(function ()\n{\n    const canvas = document.createElement('canvas');\n\n    canvas.id = 'glcanvas';\n    canvas.width = Math.min(window.innerWidth, window.innerHeight);\n    canvas.height = canvas.width;\n    document.body.appendChild(canvas);\n\n    const rc: CanvasContext = { canvasId: 'glcanvas', webGLcontextId: 'webgl2', webGLContextAttributes: { antialias: false } };\n    const webgl = new WebGL(rc);\n\n    // -- Init program\n    const program: RenderPipeline = {\n        vertex: { code: getShaderSource('vs') }, fragment: { code: getShaderSource('fs') },\n        depthStencil: {},\n        primitive: { topology: 'triangle-list', cullFace: 'back' },\n    };\n\n    // -- Init geometries\n    const positions = new Float32Array([\n        // Front face\n        -1.0, -1.0, 1.0,\n        1.0, -1.0, 1.0,\n        1.0, 1.0, 1.0,\n        -1.0, 1.0, 1.0,\n\n        // Back face\n        -1.0, -1.0, -1.0,\n        -1.0, 1.0, -1.0,\n        1.0, 1.0, -1.0,\n        1.0, -1.0, -1.0,\n\n        // Top face\n        -1.0, 1.0, -1.0,\n        -1.0, 1.0, 1.0,\n        1.0, 1.0, 1.0,\n        1.0, 1.0, -1.0,\n\n        // Bottom face\n        -1.0, -1.0, -1.0,\n        1.0, -1.0, -1.0,\n        1.0, -1.0, 1.0,\n        -1.0, -1.0, 1.0,\n\n        // Right face\n        1.0, -1.0, -1.0,\n        1.0, 1.0, -1.0,\n        1.0, 1.0, 1.0,\n        1.0, -1.0, 1.0,\n\n        // Left face\n        -1.0, -1.0, -1.0,\n        -1.0, -1.0, 1.0,\n        -1.0, 1.0, 1.0,\n        -1.0, 1.0, -1.0,\n    ]);\n\n    const normals = HalfFloat.Float16Array([\n        // Front face\n        0, 0, -1,\n        0, 0, -1,\n        0, 0, -1,\n        0, 0, -1,\n\n        // Back face\n        0, 0, 1,\n        0, 0, 1,\n        0, 0, 1,\n        0, 0, 1,\n\n        // Top face\n        0, 1, 0,\n        0, 1, 0,\n        0, 1, 0,\n        0, 1, 0,\n\n        // Bottom face\n        0, -1, 0,\n        0, -1, 0,\n        0, -1, 0,\n        0, -1, 0,\n\n        // Right face\n        -1, 0, 0,\n        -1, 0, 0,\n        -1, 0, 0,\n        -1, 0, 0,\n\n        // Left face\n        1, 0, 0,\n        1, 0, 0,\n        1, 0, 0,\n        1, 0, 0,\n    ]);\n\n    const texCoords = HalfFloat.Float16Array([\n        // Front face\n        0.0, 0.0,\n        0.0, 1.0,\n        1.0, 1.0,\n        1.0, 0.0,\n\n        // Back face\n        1.0, 1.0,\n        1.0, 0.0,\n        0.0, 0.0,\n        0.0, 1.0,\n\n        // Top face\n        0.0, 0.0,\n        0.0, 1.0,\n        1.0, 1.0,\n        1.0, 0.0,\n\n        // Bottom face\n        0.0, 0.0,\n        0.0, 1.0,\n        1.0, 1.0,\n        1.0, 0.0,\n\n        // Right face\n        0.0, 0.0,\n        0.0, 1.0,\n        1.0, 1.0,\n        1.0, 0.0,\n\n        // Left face\n        0.0, 0.0,\n        0.0, 1.0,\n        1.0, 1.0,\n        1.0, 0.0,\n    ]);\n\n    // Element buffer\n\n    const cubeVertexIndices = [\n        0, 1, 2, 0, 2, 3, // front\n        4, 5, 6, 4, 6, 7, // back\n        8, 9, 10, 8, 10, 11, // top\n        12, 13, 14, 12, 14, 15, // bottom\n        16, 17, 18, 16, 18, 19, // right\n        20, 21, 22, 20, 22, 23, // left\n    ];\n\n    // -- Init VertexArray\n\n    const vertexArray: { vertices?: VertexAttributes } = {\n        vertices: {\n            a_position: { data: positions, format: 'float32x3' },\n            a_normal: { data: normals, format: 'float16x4', arrayStride: 6 }, // 由于不支持类型 \"float16x3\"，则需要设置 arrayStride 为6，表示每次间隔3个半浮点数。\n            a_texCoord: { data: texCoords, format: 'float16x2' },\n        },\n    };\n\n    // -- Init Texture\n\n    const imageUrl = '../../assets/img/Di-3d.png';\n    let texture: Texture;\n    let sampler: Sampler;\n\n    loadImage(imageUrl, function (image)\n    {\n        // -- Init 2D Texture\n        texture = {\n            descriptor: {\n                format: 'rgba8unorm',\n                mipLevelCount: 1,\n                size: [512, 512],\n            },\n            sources: [{ image, flipY: false }],\n        };\n        sampler = {\n            minFilter: 'nearest',\n            magFilter: 'nearest',\n            addressModeU: 'clamp-to-edge',\n            addressModeV: 'clamp-to-edge',\n        };\n\n        requestAnimationFrame(render);\n    });\n\n    // -- Initialize render variables\n    const orientation = [0.0, 0.0, 0.0];\n\n    const modelMatrix = mat4.create();\n\n    const viewMatrix = mat4.create();\n    const translate = vec3.create();\n\n    vec3.set(translate, 0, 0, -10);\n    mat4.translate(viewMatrix, modelMatrix, translate);\n    const perspectiveMatrix = mat4.create();\n\n    mat4.perspective(perspectiveMatrix, 0.785, 1, 1, 1000);\n    const viewProj = mat4.create();\n\n    const modelInvTrans = mat4.create();\n\n    mat4.transpose(modelInvTrans, modelMatrix);\n    mat4.invert(modelInvTrans, modelInvTrans);\n\n    const lightPosition = [0.0, 0.0, 5.0];\n\n    const ro: RenderObject = {\n        pipeline: program,\n        bindingResources: {\n            u_model: { value: modelMatrix as Float32Array },\n            u_modelInvTrans: { value: modelInvTrans as Float32Array },\n            u_lightPosition: { value: lightPosition },\n            u_ambient: { value: 0.1 },\n        },\n        vertices: vertexArray.vertices,\n        indices: new Uint16Array(cubeVertexIndices),\n        draw: { __type__: 'DrawIndexed', indexCount: 36 },\n    };\n\n    const rp: RenderPass = {\n        descriptor: { colorAttachments: [{ clearValue: [0.0, 0.0, 0.0, 1.0], loadOp: 'clear' }] },\n        renderPassObjects: [ro],\n    };\n\n    function render()\n    {\n        // -- Render\n        orientation[0] = 0.0050; // yaw\n        orientation[1] = 0.0030; // pitch\n        orientation[2] = 0.0009; // roll\n\n        mat4.rotateX(viewMatrix, viewMatrix, orientation[0] * Math.PI);\n        mat4.rotateY(viewMatrix, viewMatrix, orientation[1] * Math.PI);\n        mat4.rotateZ(viewMatrix, viewMatrix, orientation[2] * Math.PI);\n        mat4.multiply(viewProj, perspectiveMatrix, viewMatrix);\n\n        //\n        reactive(ro.bindingResources).u_viewProj = { value: viewProj as Float32Array };\n        reactive(ro.bindingResources).s_tex2D = { texture, sampler };\n\n        webgl.submit({ commandEncoders: [{ passEncoders: [rp] }] });\n\n        requestAnimationFrame(render);\n\n        // If you have a long-running page, and need to delete WebGL resources, use:\n        //\n        // gl.deleteBuffer(vertexPosBuffer);\n        // gl.deleteBuffer(vertexTexBuffer);\n        // gl.deleteBuffer(indexBuffer);\n        // gl.deleteTexture(texture);\n        // gl.deleteProgram(program);\n        // gl.deleteVertexArray(vertexArray);\n    }\n})();\n"],"names":["HalfFloat","exponent","mantissa","bits","data64","data16","UNIT_VALUE","frexp","value","ldexp","f","signBit","sign","exp","frac","i","numArray","float16Array","tmpArray","canvas","rc","webgl","WebGL","program","getShaderSource","positions","normals","texCoords","cubeVertexIndices","vertexArray","imageUrl","texture","sampler","loadImage","image","render","orientation","modelMatrix","mat4.create","viewMatrix","translate","vec3.create","vec3.set","mat4.translate","perspectiveMatrix","mat4.perspective","viewProj","modelInvTrans","mat4.transpose","mat4.invert","ro","rp","mat4.rotateX","mat4.rotateY","mat4.rotateZ","mat4.multiply","reactive"],"mappings":"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"}