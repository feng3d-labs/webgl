{"version":3,"file":"buffer_uniform.html-n7CnLeCA.js","sources":["../../../../examples/src/WebGL2Samples/buffer_uniform.ts"],"sourcesContent":["import { CanvasContext, RenderObject, RenderPass, RenderPipeline, Submit, VertexAttributes } from '@feng3d/render-api';\nimport { WebGL } from '@feng3d/webgl';\nimport { getShaderSource } from './utility';\n\n(function ()\n{\n    // --Init Canvas\n    const canvas = document.createElement('canvas');\n\n    canvas.id = 'glcanvas';\n    canvas.width = window.innerWidth;\n    canvas.height = window.innerHeight;\n    document.body.appendChild(canvas);\n\n    // --Init WebGL Context\n    const rc: CanvasContext = { canvasId: 'glcanvas', webGLcontextId: 'webgl2' };\n    const webgl = new WebGL(rc);\n\n    // -- Init Program\n    const program: RenderPipeline = {\n        vertex: { code: getShaderSource('vs') }, fragment: { code: getShaderSource('fs') },\n    };\n\n    // -- Init Buffer\n    let elementData = new Uint16Array([\n        0, 1, 2,\n        2, 3, 0,\n    ]);\n\n    const useSharedElementBuffer = true;\n\n    if (useSharedElementBuffer)\n    {\n        // 共享元素缓冲区。模拟与其他模型的不同顶点索引数据公用一个大缓冲区。\n        const elementBuffer = new ArrayBuffer(elementData.byteLength * 2);\n        // 模拟随机偏移。\n        const randomOffset = Math.ceil(Math.random() * (elementBuffer.byteLength - elementData.byteLength) / Uint16Array.BYTES_PER_ELEMENT) * Uint16Array.BYTES_PER_ELEMENT;\n        const elementData1 = new Uint16Array(elementBuffer, randomOffset, elementData.length);\n\n        elementData1.set(elementData);\n        elementData = elementData1;\n    }\n\n    // vec3 position, vec3 normal, vec4 color\n    let vertices = new Float32Array([\n        -1.0, -1.0, -0.5, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0,\n        1.0, -1.0, -0.5, 0.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0,\n        1.0, 1.0, -0.5, 0.0, 0.0, 1.0, 0.0, 0.0, 1.0, 1.0,\n        -1.0, 1.0, -0.5, 0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 1.0,\n    ]);\n\n    const useSharedVertexBuffer = true;\n\n    if (useSharedVertexBuffer)\n    {\n        // 共享顶点缓冲区。模拟与其他模型的不同顶点数据公用一个大缓冲区。\n        const vertexBuffer = new ArrayBuffer(vertices.byteLength * 2);\n        // 模拟随机偏移。\n        const randomOffset = Math.ceil(Math.random() * (vertexBuffer.byteLength - vertices.byteLength) / Float32Array.BYTES_PER_ELEMENT) * Float32Array.BYTES_PER_ELEMENT;\n        const vertices1 = new Float32Array(vertexBuffer, randomOffset, vertices.length);\n\n        vertices1.set(vertices);\n        vertices = vertices1;\n    }\n\n    // mat4 P, mat4 MV, mat3 Mnormal\n    const transforms = {\n        transform: {\n            P: [1.0, 0.0, 0.0, 0.0,\n                0.0, 1.0, 0.0, 0.0,\n                0.0, 0.0, 1.0, 0.0,\n                0.0, 0.0, 0.0, 1.0,\n            ],\n            MV: [0.5, 0.0, 0.0, 0.0,\n                0.0, 0.5, 0.0, 0.0,\n                0.0, 0.0, 0.5, 0.0,\n                0.0, 0.0, 0.0, 1.0,\n            ],\n            Mnormal: [\n                1.0, 0.0, 0.0, 0.0,\n                0.0, 1.0, 0.0, 0.0,\n                0.0, 0.0, 1.0, 0.0,\n                0.0, 0.0, 0.0, 1.0,\n            ],\n        },\n    };\n\n    const lightPos = {\n        light: {\n            position: [0.0, 0.0, 0.0],\n        },\n    };\n\n    // vec3 ambient, diffuse, specular, float shininess\n    const material = {\n        material: {\n            ambient: [0.1, 0.0, 0.0],\n            diffuse: [0.5, 0.0, 0.0],\n            specular: [1.0, 1.0, 1.0],\n            shininess: 4.0,\n        },\n    };\n\n    // -- Init Vertex Array\n    const vertexArray: { vertices?: VertexAttributes } = {\n        vertices: {\n            position: { data: vertices, format: 'float32x3', arrayStride: 40, offset: 0 },\n            normal: { data: vertices, format: 'float32x3', arrayStride: 40, offset: 12 },\n            color: { data: vertices, format: 'float32x4', arrayStride: 40, offset: 24 },\n        },\n    };\n\n    const bindingResources = {\n        PerDraw: { value: transforms, bufferView: undefined },\n        PerPass: { value: lightPos, bufferView: undefined },\n        PerScene: { value: material, bufferView: undefined },\n    };\n\n    // 是否使用共用缓冲区。\n    let useSharedBuffer = true;\n\n    if (useSharedBuffer)\n    {\n        // 3 个统一块共用一个缓冲区。256字节对齐。\n        // PerDraw 192字节\n        // PerPass 16字节\n        // PerScene 64字节\n        const bufferViews = ((sizes: number[]) =>\n        {\n            const result = sizes.reduce((result, b) =>\n            {\n                const start = Math.ceil(result.total / 256) * 256;\n\n                result.ranges.push({ offset: start, size: b });\n                result.total = start + b;\n\n                return result;\n            }, { total: 0, ranges: [] as { offset: number, size: number }[] });\n\n            const arrayBuffer = new ArrayBuffer(result.total);\n            const bufferViews = result.ranges.map((v) =>\n            {\n                return new Uint8Array(arrayBuffer, v.offset, v.size);\n            });\n\n            return bufferViews;\n\n        })([192, 16, 48]);\n\n        bindingResources.PerDraw.bufferView = bufferViews[0];\n        bindingResources.PerPass.bufferView = bufferViews[1];\n        bindingResources.PerScene.bufferView = bufferViews[2];\n    }\n\n    const ro: RenderObject = {\n        pipeline: program,\n        bindingResources: bindingResources,\n        vertices: vertexArray.vertices,\n        indices: elementData,\n        draw: { __type__: 'DrawIndexed', indexCount: 6, firstIndex: 0 },\n    };\n\n    const rp: RenderPass = {\n        descriptor: { colorAttachments: [{ clearValue: [0.0, 0.0, 0.0, 1.0], loadOp: 'clear' }] },\n        renderPassObjects: [ro],\n    };\n\n    const submit: Submit = { commandEncoders: [{ passEncoders: [rp] }] };\n\n    let uTime = 0;\n\n    function render()\n    {\n        uTime += 0.01;\n\n        // -- update uniform buffer\n        transforms.transform.MV[0] = 0.1 * Math.cos(uTime) + 0.4;\n        transforms.transform.MV = transforms.transform.MV.concat(); // 强制更新\n\n        lightPos.light.position[0] = Math.cos(3 * uTime);\n        lightPos.light.position[1] = Math.sin(6 * uTime);\n        lightPos.light.position = lightPos.light.position.concat(); // 强制更新\n\n        webgl.submit(submit);\n\n        requestAnimationFrame(render);\n    }\n\n    render();\n})();\n"],"names":["canvas","rc","webgl","WebGL","program","getShaderSource","elementData","elementBuffer","randomOffset","elementData1","vertices","vertexBuffer","vertices1","transforms","lightPos","material","vertexArray","bindingResources","bufferViews","sizes","result","b","start","arrayBuffer","v","ro","submit","uTime","render"],"mappings":"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"}