{"version":3,"file":"fbo_blit.html-DPTpMIaj.js","sources":["../../../../examples/src/WebGL2Samples/fbo_blit.ts"],"sourcesContent":["import { CanvasContext, RenderObject, RenderPass, RenderPassDescriptor, RenderPipeline, Sampler, Texture, TextureView, VertexAttributes } from '@feng3d/render-api';\nimport { BlitFramebuffer, BlitFramebufferItem, WebGL } from '@feng3d/webgl';\nimport { getShaderSource, loadImage } from './utility';\n\nconst canvas = document.createElement('canvas');\n\ncanvas.id = 'glcanvas';\ncanvas.width = Math.min(window.innerWidth, window.innerHeight);\ncanvas.height = canvas.width;\ndocument.body.appendChild(canvas);\n\nconst renderingContext: CanvasContext = { canvasId: 'glcanvas' };\nconst webgl = new WebGL(renderingContext);\n\nconst program: RenderPipeline = {\n    vertex: {\n        code: getShaderSource('vs'),\n    },\n    fragment: {\n        code: getShaderSource('fs'),\n        targets: [{ blend: {} }],\n    },\n    primitive: { topology: 'triangle-list' },\n};\n\nconst vertexPosBuffer = new Float32Array([\n    -1.0, -1.0,\n    1.0, -1.0,\n    1.0, 1.0,\n    1.0, 1.0,\n    -1.0, 1.0,\n    -1.0, -1.0,\n]);\nconst vertexTexBuffer = new Float32Array([\n    0.0, 1.0,\n    1.0, 1.0,\n    1.0, 0.0,\n    1.0, 0.0,\n    0.0, 0.0,\n    0.0, 1.0,\n]);\n\nconst vertices: VertexAttributes = {\n    position: { data: vertexPosBuffer, format: 'float32x2' },\n    texcoord: { data: vertexTexBuffer, format: 'float32x2' },\n};\n\nloadImage('../../assets/img/Di-3d.png', (image) =>\n{\n    const FRAMEBUFFER_SIZE = {\n        x: image.width,\n        y: image.height,\n    };\n\n    const textureDiffuse: Texture = {\n        descriptor: {\n            size: [image.width, image.height],\n            format: 'rgba8unorm',\n        },\n        sources: [{\n            image, flipY: true,\n        }],\n    };\n    const samplerDiffuse: Sampler = {\n        minFilter: 'linear',\n        magFilter: 'linear',\n    };\n\n    const textureColorBuffer: Texture = {\n        descriptor: {\n            format: 'rgba8unorm',\n            size: [FRAMEBUFFER_SIZE.x, FRAMEBUFFER_SIZE.y],\n        },\n    };\n    const samplerColorBuffer: Sampler = {\n        minFilter: 'linear',\n        magFilter: 'linear',\n    };\n\n    // 此处 Renderbuffer 直接使用 IGLTextureView 替代。\n    const colorRenderbuffer: TextureView = { texture: { descriptor: { format: 'rgba8unorm', size: [FRAMEBUFFER_SIZE.x, FRAMEBUFFER_SIZE.y] } } };\n\n    const vertexArray: { vertices?: VertexAttributes } = {\n        vertices,\n    };\n\n    const renderObject: RenderObject = {\n        viewport: { x: 0, y: 0, width: FRAMEBUFFER_SIZE.x, height: FRAMEBUFFER_SIZE.y },\n        pipeline: program,\n        bindingResources: {\n            MVP: {\n                value: new Float32Array([\n                    0.8, 0.0, 0.0, 0.0,\n                    0.0, 0.8, 0.0, 0.0,\n                    0.0, 0.0, 0.8, 0.0,\n                    0.0, 0.0, 0.0, 1.0,\n                ]),\n            },\n            diffuse: { texture: textureDiffuse, sampler: samplerDiffuse },\n        },\n        vertices: vertexArray.vertices,\n        draw: { __type__: 'DrawVertex', firstVertex: 0, vertexCount: 6 },\n    };\n\n    // Render FBO\n    const fboRenderPass: RenderPass = {\n        descriptor: {\n            colorAttachments: [{\n                view: colorRenderbuffer,\n                clearValue: [0.3, 0.3, 0.3, 1.0],\n            }],\n        },\n        renderPassObjects: [renderObject],\n    };\n\n    const framebufferResolve: RenderPassDescriptor = {\n        colorAttachments: [{\n            view: { texture: textureColorBuffer, baseMipLevel: 0 },\n            clearValue: [0.7, 0.0, 0.0, 1.0],\n        }],\n    };\n\n    //\n    const renderPassResolve: RenderPass = {\n        descriptor: framebufferResolve,\n    };\n\n    const blitFramebuffers: BlitFramebufferItem[] = [];\n    const TILE = 4;\n    const BORDER = 2;\n\n    for (let j = 0; j < TILE; j++)\n    {\n        for (let i = 0; i < TILE; i++)\n        {\n            if ((i + j) % 2)\n            {\n                continue;\n            }\n\n            blitFramebuffers.push(\n                [0, 0, FRAMEBUFFER_SIZE.x, FRAMEBUFFER_SIZE.y,\n                    FRAMEBUFFER_SIZE.x / TILE * (i + 0) + BORDER,\n                    FRAMEBUFFER_SIZE.x / TILE * (j + 0) + BORDER,\n                    FRAMEBUFFER_SIZE.y / TILE * (i + 1) - BORDER,\n                    FRAMEBUFFER_SIZE.y / TILE * (j + 1) - BORDER,\n                    'COLOR_BUFFER_BIT', 'LINEAR'],\n            );\n        }\n    }\n\n    const blitFramebuffer: BlitFramebuffer = {\n        __type__: 'BlitFramebuffer',\n        read: fboRenderPass.descriptor,\n        draw: renderPassResolve.descriptor,\n        blitFramebuffers,\n    };\n\n    const renderObject2: RenderObject = {\n        viewport: { x: 0, y: 0, width: canvas.width, height: canvas.height },\n        bindingResources: {\n            MVP: {\n                value: new Float32Array([\n                    1.0, 0.0, 0.0, 0.0,\n                    0.0, 1.0, 0.0, 0.0,\n                    0.0, 0.0, 1.0, 0.0,\n                    0.0, 0.0, 0.0, 1.0,\n                ]),\n            },\n            diffuse: { texture: textureColorBuffer, sampler: samplerColorBuffer },\n        },\n        vertices: vertexArray.vertices,\n        draw: { __type__: 'DrawVertex', firstVertex: 0, vertexCount: 6 },\n        pipeline: program,\n    };\n\n    const renderPass2: RenderPass = {\n        descriptor: {\n            colorAttachments: [{\n                clearValue: [0.0, 0.0, 0.0, 1.0],\n                loadOp: 'clear',\n            }],\n        },\n        renderPassObjects: [renderObject2],\n    };\n\n    // 执行\n    webgl.submit({\n        commandEncoders: [{\n            passEncoders: [\n                fboRenderPass,\n                blitFramebuffer,\n                renderPass2,\n            ],\n        }],\n    });\n\n    // Delete WebGL resources\n    webgl.deleteFramebuffer(fboRenderPass.descriptor);\n    webgl.deleteFramebuffer(framebufferResolve);\n    webgl.deleteTexture(textureDiffuse);\n    webgl.deleteTexture(textureColorBuffer);\n    webgl.deleteProgram(program);\n});\n"],"names":["canvas","renderingContext","webgl","WebGL","program","getShaderSource","vertexPosBuffer","vertexTexBuffer","vertices","loadImage","image","FRAMEBUFFER_SIZE","textureDiffuse","samplerDiffuse","textureColorBuffer","samplerColorBuffer","colorRenderbuffer","vertexArray","renderObject","fboRenderPass","framebufferResolve","renderPassResolve","blitFramebuffers","TILE","BORDER","j","i","blitFramebuffer","renderObject2","renderPass2"],"mappings":"kJAIA,MAAMA,EAAS,SAAS,cAAc,QAAQ,EAE9CA,EAAO,GAAK,WACZA,EAAO,MAAQ,KAAK,IAAI,OAAO,WAAY,OAAO,WAAW,EAC7DA,EAAO,OAASA,EAAO,MACvB,SAAS,KAAK,YAAYA,CAAM,EAEhC,MAAMC,EAAkC,CAAE,SAAU,UAAA,EAC9CC,EAAQ,IAAIC,EAAMF,CAAgB,EAElCG,EAA0B,CAC5B,OAAQ,CACJ,KAAMC,EAAgB,IAAI,CAAA,EAE9B,SAAU,CACN,KAAMA,EAAgB,IAAI,EAC1B,QAAS,CAAC,CAAE,MAAO,GAAI,CAAA,EAE3B,UAAW,CAAE,SAAU,eAAA,CAC3B,EAEMC,EAAkB,IAAI,aAAa,CACrC,GAAM,GACN,EAAK,GACL,EAAK,EACL,EAAK,EACL,GAAM,EACN,GAAM,EACV,CAAC,EACKC,EAAkB,IAAI,aAAa,CACrC,EAAK,EACL,EAAK,EACL,EAAK,EACL,EAAK,EACL,EAAK,EACL,EAAK,CACT,CAAC,EAEKC,EAA6B,CAC/B,SAAU,CAAE,KAAMF,EAAiB,OAAQ,WAAA,EAC3C,SAAU,CAAE,KAAMC,EAAiB,OAAQ,WAAA,CAC/C,EAEAE,EAAU,6BAA+BC,GACzC,CACI,MAAMC,EAAmB,CACrB,EAAGD,EAAM,MACT,EAAGA,EAAM,MAAA,EAGPE,EAA0B,CAC5B,WAAY,CACR,KAAM,CAACF,EAAM,MAAOA,EAAM,MAAM,EAChC,OAAQ,YAAA,EAEZ,QAAS,CAAC,CACN,MAAAA,EAAO,MAAO,EAAA,CACjB,CAAA,EAECG,EAA0B,CAC5B,UAAW,SACX,UAAW,QAAA,EAGTC,EAA8B,CAChC,WAAY,CACR,OAAQ,aACR,KAAM,CAACH,EAAiB,EAAGA,EAAiB,CAAC,CAAA,CACjD,EAEEI,EAA8B,CAChC,UAAW,SACX,UAAW,QAAA,EAITC,EAAiC,CAAE,QAAS,CAAE,WAAY,CAAE,OAAQ,aAAc,KAAM,CAACL,EAAiB,EAAGA,EAAiB,CAAC,CAAA,EAAI,EAEnIM,EAA+C,CACjD,SAAAT,CAAA,EAGEU,EAA6B,CAC/B,SAAU,CAAE,EAAG,EAAG,EAAG,EAAG,MAAOP,EAAiB,EAAG,OAAQA,EAAiB,CAAA,EAC5E,SAAUP,EACV,iBAAkB,CACd,IAAK,CACD,MAAO,IAAI,aAAa,CACpB,GAAK,EAAK,EAAK,EACf,EAAK,GAAK,EAAK,EACf,EAAK,EAAK,GAAK,EACf,EAAK,EAAK,EAAK,CAAA,CAClB,CAAA,EAEL,QAAS,CAAE,QAASQ,EAAgB,QAASC,CAAA,CAAe,EAEhE,SAAUI,EAAY,SACtB,KAAM,CAAE,SAAU,aAAc,YAAa,EAAG,YAAa,CAAA,CAAE,EAI7DE,EAA4B,CAC9B,WAAY,CACR,iBAAkB,CAAC,CACf,KAAMH,EACN,WAAY,CAAC,GAAK,GAAK,GAAK,CAAG,CAAA,CAClC,CAAA,EAEL,kBAAmB,CAACE,CAAY,CAAA,EAG9BE,EAA2C,CAC7C,iBAAkB,CAAC,CACf,KAAM,CAAE,QAASN,EAAoB,aAAc,CAAA,EACnD,WAAY,CAAC,GAAK,EAAK,EAAK,CAAG,CAAA,CAClC,CAAA,EAICO,EAAgC,CAClC,WAAYD,CAAA,EAGVE,EAA0C,CAAA,EAC1CC,EAAO,EACPC,EAAS,EAEf,QAASC,EAAI,EAAGA,EAAIF,EAAME,IAEtB,QAASC,EAAI,EAAGA,EAAIH,EAAMG,KAEjBA,EAAID,GAAK,GAKdH,EAAiB,KACb,CAAC,EAAG,EAAGX,EAAiB,EAAGA,EAAiB,EACxCA,EAAiB,EAAIY,GAAQG,EAAI,GAAKF,EACtCb,EAAiB,EAAIY,GAAQE,EAAI,GAAKD,EACtCb,EAAiB,EAAIY,GAAQG,EAAI,GAAKF,EACtCb,EAAiB,EAAIY,GAAQE,EAAI,GAAKD,EACtC,mBAAoB,QAAA,CAAQ,EAK5C,MAAMG,EAAmC,CACrC,SAAU,kBACV,KAAMR,EAAc,WACpB,KAAME,EAAkB,WACxB,iBAAAC,CAAA,EAGEM,EAA8B,CAChC,SAAU,CAAE,EAAG,EAAG,EAAG,EAAG,MAAO5B,EAAO,MAAO,OAAQA,EAAO,MAAA,EAC5D,iBAAkB,CACd,IAAK,CACD,MAAO,IAAI,aAAa,CACpB,EAAK,EAAK,EAAK,EACf,EAAK,EAAK,EAAK,EACf,EAAK,EAAK,EAAK,EACf,EAAK,EAAK,EAAK,CAAA,CAClB,CAAA,EAEL,QAAS,CAAE,QAASc,EAAoB,QAASC,CAAA,CAAmB,EAExE,SAAUE,EAAY,SACtB,KAAM,CAAE,SAAU,aAAc,YAAa,EAAG,YAAa,CAAA,EAC7D,SAAUb,CAAA,EAGRyB,EAA0B,CAC5B,WAAY,CACR,iBAAkB,CAAC,CACf,WAAY,CAAC,EAAK,EAAK,EAAK,CAAG,EAC/B,OAAQ,OAAA,CACX,CAAA,EAEL,kBAAmB,CAACD,CAAa,CAAA,EAIrC1B,EAAM,OAAO,CACT,gBAAiB,CAAC,CACd,aAAc,CACViB,EACAQ,EACAE,CAAA,CACJ,CACH,CAAA,CACJ,EAGD3B,EAAM,kBAAkBiB,EAAc,UAAU,EAChDjB,EAAM,kBAAkBkB,CAAkB,EAC1ClB,EAAM,cAAcU,CAAc,EAClCV,EAAM,cAAcY,CAAkB,EACtCZ,EAAM,cAAcE,CAAO,CAC/B,CAAC"}