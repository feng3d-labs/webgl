import{c as M,f as N,d as R,e as v,l as $,n as G,s as V}from"./vec3-BLfYq55O.js";import{A as y,E as O}from"./common-C8IKy_GC.js";import{c as T,m as L,f as I,s as z,e as U}from"./mat4-BHCnbM9z.js";function q(){var e=new y(9);return y!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function P(){var e=new y(4);return y!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function H(e,s,t,n,i){return e[0]=s,e[1]=t,e[2]=n,e[3]=i,e}function Y(e,s){var t=s[0],n=s[1],i=s[2],r=s[3],a=t*t+n*n+i*i+r*r;return a>0&&(a=1/Math.sqrt(a)),e[0]=t*a,e[1]=n*a,e[2]=i*a,e[3]=r*a,e}(function(){var e=P();return function(s,t,n,i,r,a){var f,o;for(t||(t=4),n||(n=0),i?o=Math.min(i*t+n,s.length):o=s.length,f=n;f<o;f+=t)e[0]=s[f],e[1]=s[f+1],e[2]=s[f+2],e[3]=s[f+3],r(e,e,a),s[f]=e[0],s[f+1]=e[1],s[f+2]=e[2],s[f+3]=e[3];return s}})();function A(){var e=new y(4);return y!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function J(e,s,t){t=t*.5;var n=Math.sin(t);return e[0]=n*s[0],e[1]=n*s[1],e[2]=n*s[2],e[3]=Math.cos(t),e}function w(e,s,t,n){var i=s[0],r=s[1],a=s[2],f=s[3],o=t[0],c=t[1],l=t[2],u=t[3],d,h,_,b,p;return h=i*o+r*c+a*l+f*u,h<0&&(h=-h,o=-o,c=-c,l=-l,u=-u),1-h>O?(d=Math.acos(h),_=Math.sin(d),b=Math.sin((1-n)*d)/_,p=Math.sin(n*d)/_):(b=1-n,p=n),e[0]=b*i+p*o,e[1]=b*r+p*c,e[2]=b*a+p*l,e[3]=b*f+p*u,e}function X(e,s){var t=s[0]+s[4]+s[8],n;if(t>0)n=Math.sqrt(t+1),e[3]=.5*n,n=.5/n,e[0]=(s[5]-s[7])*n,e[1]=(s[6]-s[2])*n,e[2]=(s[1]-s[3])*n;else{var i=0;s[4]>s[0]&&(i=1),s[8]>s[i*3+i]&&(i=2);var r=(i+1)%3,a=(i+2)%3;n=Math.sqrt(s[i*3+i]-s[r*3+r]-s[a*3+a]+1),e[i]=.5*n,n=.5/n,e[3]=(s[r*3+a]-s[a*3+r])*n,e[r]=(s[r*3+i]+s[i*3+r])*n,e[a]=(s[a*3+i]+s[i*3+a])*n}return e}var Q=H,E=Y;(function(){var e=M(),s=N(1,0,0),t=N(0,1,0);return function(n,i,r){var a=R(i,r);return a<-.999999?(v(e,s,i),$(e)<1e-6&&v(e,t,i),G(e,e),J(n,e,Math.PI),n):a>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(v(e,i,r),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=1+a,E(n,n))}})();(function(){var e=A(),s=A();return function(t,n,i,r,a,f){return w(e,n,a,f),w(s,i,r,f),w(t,e,s,2*f*(1-f)),t}})();(function(){var e=q();return function(s,t,n,i){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-t[0],e[5]=-t[1],e[8]=-t[2],E(s,X(s,e))}})();class K{constructor(){this.meshes=[]}}class W{constructor(){this.meshID="",this.primitives=[]}}class Z{constructor(){this.mode=4,this.indices=null,this.indicesComponentType=5123,this.vertexBuffer=null,this.matrix=T(),this.attributes={}}}class j{constructor(){this.defaultScene="",this.scenes={},this.json=null}}class ce{constructor(){this._init(),this.glTF=null}_init(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._bufferViews={},this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null}_getBufferViewData(s,t,n){const i=this._bufferViews[t];if(i)n(i);else{const r=s.bufferViews[t],a=this._buffers[r.buffer];if(a)this._bufferViews[t]=a.slice(r.byteOffset,r.byteOffset+r.byteLength),n(i);else{this._pendingTasks++;let f=this._bufferTasks[r.buffer];f||(this._bufferTasks[r.buffer]=[],f=this._bufferTasks[r.buffer]);const o=this;f.push(function(c){let l=o._bufferViews[t];l||(console.log(`create new BufferView Data for ${t}`),l=o._bufferViews[t]=c.slice(r.byteOffset,r.byteOffset+r.byteLength)),o._finishedPendingTasks++,n(l)})}}}_checkComplete(){this._bufferRequested===this._bufferLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks===this._finishedPendingTasks&&this.onload(this.glTF)}_parseGLTF(s){this.glTF.json=s,this.glTF.defaultScene=s.scene;for(const t in s.scenes){const n=new K;this.glTF.scenes[t]=n;const r=s.scenes[t].nodes,a=r.length;for(let f=0;f<a;++f){const o=r[f],c=s.nodes[o];this._parseNode(s,c,n)}}this._parseDone=!0,this._checkComplete()}_parseNode(s,t,n,i){i===void 0&&(i=T());const r=T();if(t.hasOwnProperty("matrix")){for(let c=0;c<16;++c)r[c]=t.matrix[c];L(r,i,r)}else V(S,t.translation[0],t.translation[1],t.translation[2]),Q(D,t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]),I(F,D,S),L(r,r,F),V(B,t.scale[0],t.scale[1],t.scale[2]),z(r,r,B);const a=t.meshes;if(a){const c=a.length;for(let l=0;l<c;++l){const u=new W;n.meshes.push(u);const d=a[l],h=s.meshes[d];u.meshID=d;const _=h.primitives,b=_.length;for(let p=0;p<b;++p){const m=new Z;u.primitives.push(m);const g=_[p];g.indices&&this._parseIndices(s,g,m),this._parseAttributes(s,g,m,r)}}}const f=t.children,o=f.length;for(let c=0;c<o;++c){const l=f[c],u=s.nodes[l];this._parseNode(s,u,n,r)}}_parseIndices(s,t,n){const i=t.indices,r=s.accessors[i];n.mode=t.mode||4,n.indicesComponentType=ee[r.componentType];const a=this;this._getBufferViewData(s,r.bufferView,function(f){n.indices=se(f,r),a._checkComplete()})}_parseAttributes(s,t,n,i){const r=Object.keys(t.attributes)[0],a=s.accessors[t.attributes[r]],f=a.bufferView,o=s.bufferViews[f],c=this;this._getBufferViewData(s,f,function(l){n.vertexBuffer=C(l,0,o.byteLength/x[a.componentType],a.componentType);for(const u in t.attributes){const d=t.attributes[u],h=s.accessors[d],_=x[h.componentType];h.byteStride/_,h.byteOffset/_,h.count,U(n.matrix,i),n.attributes[u]={size:k[h.type],type:h.componentType,stride:h.byteStride,offset:h.byteOffset}}c._checkComplete()})}loadGLTF(s,t){this._init(),this.onload=t||(i=>{console.log("glTF model loaded."),console.log(i)}),this.glTF=new j,this.baseUri=te(s);const n=this;ne(s,function(i){const r=JSON.parse(i);let a;const f=o=>{if(n._buffers[a]=o,n._bufferLoaded++,n._bufferTasks[a]){let c,l;for(c=0,l=n._bufferTasks[a].length;c<l;++c)n._bufferTasks[a][c](o)}n._checkComplete()};if(r.buffers)for(a in r.buffers)n._bufferRequested++,re(`${n.baseUri}/${r.buffers[a].uri}`,f);n._parseGLTF(r)})}}const S=M(),D=A(),B=M(),F=T(),x={5120:1,5121:1,5122:2,5123:2,5126:4},k={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ee={5121:"UNSIGNED_BYTE",5123:"UNSIGNED_SHORT",5124:"UNSIGNED_INT"};function C(e,s,t,n){switch(n){case 5122:return new Int16Array(e,s,t);case 5123:return new Uint16Array(e,s,t);case 5126:return new Float32Array(e,s,t);default:return null}}function se(e,s){return C(e,s.byteOffset,s.count*k[s.type],s.componentType)}function te(e){let s="";const t=e.lastIndexOf("/");return t!==-1&&(s=e.substring(0,t+1)),s}function ne(e,s){const t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",e,!0),t.onreadystatechange=function(){t.readyState===4&&t.status===200&&s(t.responseText,this)},t.send(null)}function re(e,s){const t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",e,!0),t.onreadystatechange=function(){if(t.readyState===4&&t.status===200){const n=t.response;n&&s&&s(n)}},t.send(null)}export{ce as G};
//# sourceMappingURL=gltf-loader-CDzcHVJC.js.map
