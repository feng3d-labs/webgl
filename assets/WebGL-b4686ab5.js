const ve={depth:!0,stencil:!0,antialias:!1,premultipliedAlpha:!0,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};function W(t,e,r="STATIC_DRAW"){if(t[j])return t[j];const n={size:Math.ceil(t.byteLength/4)*4,target:e,usage:r,data:t};return t[j]=n,n}const j="_IGLBuffer";function oe(t){if(!t)return;const e=ie[t];return console.assert(!!e,`接收到错误值，请从 ${Object.keys(ie).toString()} 中取值！`),e}const ie={add:"FUNC_ADD",subtract:"FUNC_SUBTRACT","reverse-subtract":"FUNC_REVERSE_SUBTRACT",min:"MIN",max:"MAX"};function $(t,e){if(!t)return;(e==="max"||e==="min")&&(t="one");const r=ae[t];return console.assert(!!r,`接收到错误值，请从 ${Object.keys(ae).toString()} 中取值！`),r}const ae={zero:"ZERO",one:"ONE",src:"SRC_COLOR","one-minus-src":"ONE_MINUS_SRC_COLOR","src-alpha":"SRC_ALPHA","one-minus-src-alpha":"ONE_MINUS_SRC_ALPHA",dst:"DST_COLOR","one-minus-dst":"ONE_MINUS_DST_COLOR","dst-alpha":"DST_ALPHA","one-minus-dst-alpha":"ONE_MINUS_DST_ALPHA","src-alpha-saturated":"SRC_ALPHA_SATURATE",constant:"CONSTANT_COLOR","one-minus-constant":"ONE_MINUS_CONSTANT_COLOR"},Ie={uint8x2:{numComponents:2,type:"UNSIGNED_BYTE",normalized:!1,dataType:"unsigned int",byteSize:2,wgslType:"vec2<u32>",typedArrayConstructor:Uint8Array},uint8x4:{numComponents:4,type:"UNSIGNED_BYTE",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"vec4<u32>",typedArrayConstructor:Uint8Array},sint8x2:{numComponents:2,type:"BYTE",normalized:!1,dataType:"signed int",byteSize:2,wgslType:"vec2<i32>",typedArrayConstructor:Int8Array},sint8x4:{numComponents:4,type:"BYTE",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"vec4<i32>",typedArrayConstructor:Int8Array},unorm8x2:{numComponents:2,type:"UNSIGNED_BYTE",normalized:!0,dataType:"unsigned normalized",byteSize:2,wgslType:"vec2<f32>",typedArrayConstructor:Uint8Array},unorm8x4:{numComponents:4,type:"UNSIGNED_BYTE",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Uint8Array},snorm8x2:{numComponents:2,type:"BYTE",normalized:!0,dataType:"signed normalized",byteSize:2,wgslType:"vec2<f32>",typedArrayConstructor:Int8Array},snorm8x4:{numComponents:4,type:"BYTE",normalized:!0,dataType:"signed normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Int8Array},uint16x2:{numComponents:2,type:"UNSIGNED_SHORT",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"vec2<u32>",typedArrayConstructor:Uint16Array},uint16x4:{numComponents:4,type:"UNSIGNED_SHORT",normalized:!1,dataType:"unsigned int",byteSize:8,wgslType:"vec4<u32>",typedArrayConstructor:Uint16Array},sint16x2:{numComponents:2,type:"SHORT",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"vec2<i32>",typedArrayConstructor:Int16Array},sint16x4:{numComponents:4,type:"SHORT",normalized:!1,dataType:"signed int",byteSize:8,wgslType:"vec4<i32>",typedArrayConstructor:Int16Array},unorm16x2:{numComponents:2,type:"UNSIGNED_SHORT",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec2<f32>",typedArrayConstructor:Uint16Array},unorm16x4:{numComponents:4,type:"UNSIGNED_SHORT",normalized:!0,dataType:"unsigned normalized",byteSize:8,wgslType:"vec4<f32>",typedArrayConstructor:Uint16Array},snorm16x2:{numComponents:2,type:"SHORT",normalized:!0,dataType:"signed normalized",byteSize:4,wgslType:"vec2<f32>",typedArrayConstructor:Int16Array},snorm16x4:{numComponents:4,type:"SHORT",normalized:!0,dataType:"signed normalized",byteSize:8,wgslType:"vec4<f32>",typedArrayConstructor:Int16Array},float16x2:{numComponents:2,type:"HALF_FLOAT",normalized:!1,dataType:"float",byteSize:4,wgslType:"vec2<f16>",typedArrayConstructor:void 0},float16x4:{numComponents:4,type:"HALF_FLOAT",normalized:!1,dataType:"float",byteSize:8,wgslType:"vec4<f16>",typedArrayConstructor:void 0},float32:{numComponents:1,type:"FLOAT",normalized:!1,dataType:"float",byteSize:4,wgslType:"f32",typedArrayConstructor:Float32Array},float32x2:{numComponents:2,type:"FLOAT",normalized:!1,dataType:"float",byteSize:8,wgslType:"vec2<f32>",typedArrayConstructor:Float32Array},float32x3:{numComponents:3,type:"FLOAT",normalized:!1,dataType:"float",byteSize:12,wgslType:"vec3<f32>",typedArrayConstructor:Float32Array},float32x4:{numComponents:4,type:"FLOAT",normalized:!1,dataType:"float",byteSize:16,wgslType:"vec4<f32>",typedArrayConstructor:Float32Array},uint32:{numComponents:1,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"u32",typedArrayConstructor:Uint32Array},uint32x2:{numComponents:2,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:8,wgslType:"vec2<u32>",typedArrayConstructor:Uint32Array},uint32x3:{numComponents:3,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:12,wgslType:"vec3<u32>",typedArrayConstructor:Uint32Array},uint32x4:{numComponents:4,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:16,wgslType:"vec4<u32>",typedArrayConstructor:Uint32Array},sint32:{numComponents:1,type:"INT",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"i32",typedArrayConstructor:Int32Array},sint32x2:{numComponents:2,type:"INT",normalized:!1,dataType:"signed int",byteSize:8,wgslType:"vec2<i32>",typedArrayConstructor:Int32Array},sint32x3:{numComponents:3,type:"INT",normalized:!1,dataType:"signed int",byteSize:12,wgslType:"vec3<i32>",typedArrayConstructor:Int32Array},sint32x4:{numComponents:4,type:"INT",normalized:!1,dataType:"signed int",byteSize:16,wgslType:"vec4<i32>",typedArrayConstructor:Int32Array},"unorm10-10-10-2":{numComponents:4,type:"UNSIGNED_INT_2_10_10_10_REV",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Int32Array}};class Ne{static getBlendConstantColor(e){if(!e)return;const{color:r,alpha:n,constantColor:s}=e;if((r==null?void 0:r.srcFactor)==="constant"||(r==null?void 0:r.srcFactor)==="one-minus-constant"||(r==null?void 0:r.dstFactor)==="constant"||(r==null?void 0:r.dstFactor)==="one-minus-constant"||(n==null?void 0:n.srcFactor)==="constant"||(n==null?void 0:n.srcFactor)==="one-minus-constant"||(n==null?void 0:n.dstFactor)==="constant"||(n==null?void 0:n.dstFactor)==="one-minus-constant")return s??[0,0,0,0]}}class ce{static getTextureBytesPerPixel(e="rgba8unorm"){var r;const n=(r=ue[e])==null?void 0:r.bytesPerPixel;return console.assert(!!n,`未处理格式 ${e} ，无法查询到该格式中每个像素占用的字节数量！`),n}static getTextureDataConstructor(e="rgba8unorm"){var r;const n=(r=ue[e])==null?void 0:r.dataConstructor;return console.assert(!!n,`未处理格式 ${e} ，无法查询到该格式的纹理数据构造函数！`),n}}const ue={r8unorm:{bytesPerPixel:1,dataConstructor:Uint8Array},r8snorm:{bytesPerPixel:1,dataConstructor:Int8Array},r8uint:{bytesPerPixel:1,dataConstructor:Uint8Array},r8sint:{bytesPerPixel:1,dataConstructor:Int8Array},r16uint:{bytesPerPixel:2,dataConstructor:Uint16Array},r16sint:{bytesPerPixel:2,dataConstructor:Int16Array},r16float:{bytesPerPixel:2,dataConstructor:Uint16Array},rg8unorm:{bytesPerPixel:2,dataConstructor:Uint8Array},rg8snorm:{bytesPerPixel:2,dataConstructor:Int8Array},rg8uint:{bytesPerPixel:2,dataConstructor:Uint8Array},rg8sint:{bytesPerPixel:2,dataConstructor:Int8Array},r32uint:{bytesPerPixel:4,dataConstructor:Uint32Array},r32sint:{bytesPerPixel:4,dataConstructor:Int32Array},r32float:{bytesPerPixel:4,dataConstructor:Float32Array},rg16uint:{bytesPerPixel:4,dataConstructor:Uint16Array},rg16sint:{bytesPerPixel:4,dataConstructor:Int16Array},rg16float:{bytesPerPixel:4,dataConstructor:Uint16Array},rgba8unorm:{bytesPerPixel:4,dataConstructor:Uint8Array},"rgba8unorm-srgb":{bytesPerPixel:4,dataConstructor:Uint8Array},rgba8snorm:{bytesPerPixel:4,dataConstructor:Int8Array},rgba8uint:{bytesPerPixel:4,dataConstructor:Uint8Array},rgba8sint:{bytesPerPixel:4,dataConstructor:Int8Array},bgra8unorm:{bytesPerPixel:4,dataConstructor:Uint8Array},"bgra8unorm-srgb":{bytesPerPixel:4,dataConstructor:Uint8Array},rgb9e5ufloat:{bytesPerPixel:4,dataConstructor:Uint32Array},rgb10a2uint:{bytesPerPixel:4,dataConstructor:Uint32Array},rgb10a2unorm:{bytesPerPixel:4,dataConstructor:Uint32Array},rg11b10ufloat:{bytesPerPixel:4,dataConstructor:Uint32Array},rg32uint:{bytesPerPixel:8,dataConstructor:Uint32Array},rg32sint:{bytesPerPixel:8,dataConstructor:Int32Array},rg32float:{bytesPerPixel:8,dataConstructor:Float32Array},rgba16uint:{bytesPerPixel:8,dataConstructor:Uint16Array},rgba16sint:{bytesPerPixel:8,dataConstructor:Int16Array},rgba16float:{bytesPerPixel:8,dataConstructor:Uint16Array},rgba32uint:{bytesPerPixel:16,dataConstructor:Uint32Array},rgba32sint:{bytesPerPixel:16,dataConstructor:Int32Array},rgba32float:{bytesPerPixel:16,dataConstructor:Float32Array},stencil8:{bytesPerPixel:1,dataConstructor:Uint8Array},depth16unorm:{bytesPerPixel:2,dataConstructor:Uint16Array},depth24plus:{bytesPerPixel:3,dataConstructor:Uint8Array},"depth24plus-stencil8":{bytesPerPixel:4},depth32float:{bytesPerPixel:4},"depth32float-stencil8":{bytesPerPixel:5},"bc1-rgba-unorm":void 0,"bc1-rgba-unorm-srgb":void 0,"bc2-rgba-unorm":void 0,"bc2-rgba-unorm-srgb":void 0,"bc3-rgba-unorm":void 0,"bc3-rgba-unorm-srgb":void 0,"bc4-r-unorm":void 0,"bc4-r-snorm":void 0,"bc5-rg-unorm":void 0,"bc5-rg-snorm":void 0,"bc6h-rgb-ufloat":void 0,"bc6h-rgb-float":void 0,"bc7-rgba-unorm":void 0,"bc7-rgba-unorm-srgb":void 0,"etc2-rgb8unorm":void 0,"etc2-rgb8unorm-srgb":void 0,"etc2-rgb8a1unorm":void 0,"etc2-rgb8a1unorm-srgb":void 0,"etc2-rgba8unorm":void 0,"etc2-rgba8unorm-srgb":void 0,"eac-r11unorm":void 0,"eac-r11snorm":void 0,"eac-rg11unorm":void 0,"eac-rg11snorm":void 0,"astc-4x4-unorm":void 0,"astc-4x4-unorm-srgb":void 0,"astc-5x4-unorm":void 0,"astc-5x4-unorm-srgb":void 0,"astc-5x5-unorm":void 0,"astc-5x5-unorm-srgb":void 0,"astc-6x5-unorm":void 0,"astc-6x5-unorm-srgb":void 0,"astc-6x6-unorm":void 0,"astc-6x6-unorm-srgb":void 0,"astc-8x5-unorm":void 0,"astc-8x5-unorm-srgb":void 0,"astc-8x6-unorm":void 0,"astc-8x6-unorm-srgb":void 0,"astc-8x8-unorm":void 0,"astc-8x8-unorm-srgb":void 0,"astc-10x5-unorm":void 0,"astc-10x5-unorm-srgb":void 0,"astc-10x6-unorm":void 0,"astc-10x6-unorm-srgb":void 0,"astc-10x8-unorm":void 0,"astc-10x8-unorm-srgb":void 0,"astc-10x10-unorm":void 0,"astc-10x10-unorm-srgb":void 0,"astc-12x10-unorm":void 0,"astc-12x10-unorm-srgb":void 0,"astc-12x12-unorm":void 0,"astc-12x12-unorm-srgb":void 0};class Me{constructor(){this._根字典=new WeakMap,this._数量=0}get(e){const r=e.length;let n=this._根字典,s;for(let i=0,a=r-1;i<a;i++)if(s=M(e[i]),n=n.get(s),n===void 0)return;return s=M(e[r-1]),n.get(s)}set(e,r){const n=e.length;let s=this._根字典,i;for(let a=0;a<n-1;a++)i=M(e[a]),s.has(i)||s.set(i,new WeakMap),s=s.get(i);return i=M(e[n-1]),s.has(i)||(s.set(i,r),this._数量++),r}delete(e){const r=e.length;let n=this._根字典,s;for(let a=0;a<r-1;a++)if(s=M(e[a]),n=n.get(s),n===void 0)return!1;s=M(e[r-1]);const i=n.delete(s);return i&&this._数量--,i}}const ee=new Map;let Be=0;function M(t){if(typeof t=="object"&&t!==null)return t;if(ee.has(t))return ee.get(t);const r={__id:Be++,__value:t};return ee.set(t,r),r}function Oe(t){const{source:e,destination:r,copySize:n}=t,s=e.aspect||"all",i=r.aspect||"all";console.assert(s===i,"拷贝纹理时两个纹理的 aspect 必须相同！");const a=[];let o;const c=[];let u,f;s==="all"?(f="COLOR_BUFFER_BIT",a.push({view:B(e)}),c.push({view:B(r)})):s==="depth-only"?(f="DEPTH_BUFFER_BIT",o={view:B(e)},u={view:B(r)}):s==="stencil-only"&&(f="STENCIL_BUFFER_BIT",o={view:B(e)},u={view:B(r)});const d=e.origin||[0,0],m=r.origin||[0,0],_=[d[0],d[1],d[0]+n[0],d[1]+n[1],m[0],m[1],m[0]+n[0],m[1]+n[1],f,"NEAREST"];return{__type__:"BlitFramebuffer",read:{colorAttachments:a,depthStencilAttachment:o},draw:{colorAttachments:c,depthStencilAttachment:u},blitFramebuffers:[_]}}function B(t){var r;return t.texture?{texture:t.texture,baseMipLevel:t.mipLevel,baseArrayLayer:(r=t.origin)==null?void 0:r[2]}:void 0}class Ge{constructor(){this._binds=[]}on(){const e=[],r={watch:(n,s,i,a,o=!0,c,u)=>(this.watch(n,s,i,a,o,c,u),e.push(()=>this.unwatch(n,s,i,a)),r),watchs:(n,s,i,a,o)=>(this.watchs(n,s,i,a,o),e.push(()=>this.unwatchs(n,s,i,a)),r),bind:(n,s,i,a)=>(this.bind(n,s,i,a),e.push(()=>this.unbind(n,s,i,a)),r),watchchain:(n,s,i,a,o=!0,c,u)=>(this.watchchain(n,s,i,a,o,c,u),e.push(()=>this.unwatchchain(n,s,i,a)),r),watchobject:(n,s,i,a,o=!0)=>(this.watchobject(n,s,i,a,o),e.push(()=>this.unwatchobject(n,s,i,a)),r),off:()=>{e.forEach(n=>n()),e.length=0}};return r}watch(e,r,n,s,i=!0,a,o){a=a||e,o=o||r,Object.getOwnPropertyDescriptor(e,I)||Object.defineProperty(e,I,{value:{},enumerable:!1,configurable:!0,writable:!1});const c=r,u=e[I];if(!u[c]){const m=Object.getOwnPropertyDescriptor(e,c);u[c]={value:e[c],oldPropertyDescriptor:m,handlers:[]};let _=Re(e,c);if(_&&_.set&&_.get){_={enumerable:_.enumerable,configurable:!0,get:_.get,set:_.set};const T=_.set;_.set=function(E){const A=this[c];T&&T.call(this,E),fe(E,A,this,c,a,o)}}else if(!_||!_.get&&!_.set)_={enumerable:!0,configurable:!0},_.get=function(){return this[I][c].value},_.set=function(T){const E=this[I][c].value;this[I][c].value=T,fe(T,E,this,c,a,o)};else{console.warn("无法修改监听属性的描述，监听失败！",e,c,n,s);return}Object.defineProperty(e,c,_)}const f=u[c];f.handlers.reduce((m,_)=>m||_.handler===n&&_.thisObject===s,!1)?console.warn("重复监听， 监听失败！",e,c,n,s):f.handlers.push({handler:n,thisObject:s,onlyChanged:i})}unwatch(e,r,n,s){const i=e[I];if(!i)return;const a=r;if(i[a]){const o=i[a].handlers;n===void 0&&(o.length=0);for(let c=o.length-1;c>=0;c--)o[c].handler===n&&(o[c].thisObject===s||s===void 0)&&o.splice(c,1);if(o.length===0){const c=e[a];delete e[a],i[a].oldPropertyDescriptor&&Object.defineProperty(e,a,i[a].oldPropertyDescriptor),e[a]=c,delete i[a]}Object.keys(i).length===0&&delete e[I]}}watchs(e,r,n,s,i=!0){r.forEach(a=>{this.watch(e,a,n,s,i)})}unwatchs(e,r,n,s){r.forEach(i=>{this.unwatch(e,i,n,s)})}bind(e,r,n,s){const i=()=>{n[s]=e[r]},a=()=>{e[r]=n[s]};this.watch(e,r,i),this.watch(n,s,a),this._binds.push([e,r,i,n,s,a])}unbind(e,r,n,s){const i=this._binds;for(let a=i.length-1;a>=0;a--){const o=i[a];if((o[1]===r&&o[4]===s||o[1]===s&&o[4]===r)&&(o[0]===e&&o[3]===n||o[0]===n&&o[3]===e)){this.unwatch(o[0],o[1],o[2]),this.unwatch(o[3],o[4],o[5]),i.splice(a,1);break}}}watchchain(e,r,n,s,i=!0,a,o){a=a||e,o=o||r;const c=r.indexOf(".");if(c===-1){this.watch(e,r,n,s,i,a,o);return}Object.getOwnPropertyDescriptor(e,V)||Object.defineProperty(e,V,{value:{},enumerable:!1,writable:!1,configurable:!0});const u=e[V];u[r]||(u[r]=[]);const f=u[r];if(!f.reduce((m,_)=>m||_.handler===n&&_.thisObject===s,!1)){const m=r.substr(0,c),_=r.substr(c+1);e[m]&&this.watchchain(e[m],_,n,s,i,a,o);const T=(E,A)=>{A&&this.unwatchchain(A,_,n,s),E&&this.watchchain(E,_,n,s,i,a,o);const b=_e(A,_),h=_e(E,_);(!i||b!==h)&&n.call(s,h,b,a,o)};this.watch(e,m,T,void 0,i),f.push({handler:n,thisObject:s,watchchainFun:T})}}unwatchchain(e,r,n,s){const i=r.indexOf(".");if(i===-1){this.unwatch(e,r,n,s);return}const a=r.substr(0,i),o=r.substr(i+1),c=e[V];if(!c||!c[r])return;const u=c[r];for(let f=u.length-1;f>=0;f--){const d=u[f];(se(n)||n===d.handler&&s===d.thisObject)&&(e[a]&&this.unwatchchain(e[a],o,d.handler,d.thisObject),this.unwatch(e,a,d.watchchainFun),u.splice(f,1))}u.length===0&&delete c[r],Object.keys(c).length===0&&delete e[V]}watchobject(e,r,n,s,i=!0){de(r).forEach(o=>{this.watchchain(e,o,n,s,i)})}unwatchobject(e,r,n,s){de(r).forEach(a=>{this.unwatchchain(e,a,n,s)})}}const v=new Ge,I="__watchs__",V="__watchchains__";function fe(t,e,r,n,s,i){s=s||r,i=i||n,r[I][n].handlers.concat().forEach(c=>{(!c.onlyChanged||t!==e)&&c.handler.call(c.thisObject,t,e,s,i)})}function Re(t,e){const r=Object.getOwnPropertyDescriptor(t,e);if(r)return r;const n=Object.getPrototypeOf(t);if(n)return Re(n,e)}function se(t){return t==null}function _e(t,e){typeof e=="string"&&(e=e.split("."));let r=t;for(let n=0;n<e.length;n++){if(se(r))return;r=r[e[n]]}return r}function de(t){const e=[],r=Object.keys(t),n=new Array(r.length).fill(t),s=new Array(r.length).fill(-1);let i=0;for(;i<r.length;){const a=n[i],o=r[i],c=a[o];let u;if(se(c)||De(c)||(u=Object.keys(c)).length===0){const f=[o];let d=i;for(;(d=s[d])!==-1;)f.push(r[d]);f.reverse(),e.push(f.join("."))}else u.forEach(f=>{r.push(f),n.push(c),s.push(i)});i++}return e}function De(t){return t==null||typeof t=="boolean"||typeof t=="string"||typeof t=="number"}function D(t,e){let r=t._bufferMap.get(e);if(r)return r;r=t.createBuffer(),t._bufferMap.set(e,r);const n=e.target,s=e.size,i=e.usage||"STATIC_DRAW";t.bindBuffer(t[n],r),t.bufferData(t[n],s,t[i]);const a=()=>{const c=e.writeBuffers;c&&(t.bindBuffer(t[n],r),c.forEach(u=>{const f=u.bufferOffset??0,d=u.data,m=u.dataOffset??0;let _;"buffer"in d?_=new Uint8Array(d.buffer,d.byteOffset+m*d.BYTES_PER_ELEMENT,(d.length-m)*d.BYTES_PER_ELEMENT):_=new Uint8Array(d,m,d.byteLength-m),t.bufferSubData(t[n],f,_)}),e.writeBuffers=null)},o=()=>{if(!e.data)return;const c=e.writeBuffers||[];c.unshift({data:e.data}),e.writeBuffers=c};return o(),a(),v.watch(e,"data",o),v.watch(e,"writeBuffers",a),r.destroy=()=>{v.unwatch(e,"data",o),v.unwatch(e,"writeBuffers",a)},r}function ke(t,e){const r=t._bufferMap.get(e);r&&(t._bufferMap.delete(e),r.destroy(),delete r.destroy,t.deleteBuffer(r))}function me(t){let e=ze[t];return console.assert(!!e,`WebGL 不支持参数 IPrimitiveTopology ${t} !`),e=e||t,e}const ze={"point-list":"POINTS","line-list":"LINES","line-strip":"LINE_STRIP","triangle-list":"TRIANGLES","triangle-strip":"TRIANGLE_STRIP",LINE_LOOP:"LINE_LOOP",TRIANGLE_FAN:"TRIANGLE_FAN"};function ge(t,e,r){let n=t._renderbuffers.get(e);if(n)return n;n=t.createRenderbuffer(),t._renderbuffers.set(e,n);const{internalformat:s,width:i,height:a}=e;return t.bindRenderbuffer(t.RENDERBUFFER,n),r===4&&t instanceof WebGL2RenderingContext?t.renderbufferStorageMultisample(t.RENDERBUFFER,r,t[s],i,a):t.renderbufferStorage(t.RENDERBUFFER,t[s],i,a),n}function Se(t,e){const r=t._renderbuffers.get(e);t._renderbuffers.delete(e),t.deleteRenderbuffer(r)}function Z(t="rgba8unorm"){const e=Ve[t];return console.assert(!!e,`未处理格式 ${t}；或者WebGL不支持纹理， 该格式只在WebGPU中支持！`),e}const Ve={r8unorm:{internalformat:"R8",format:"RED",type:"UNSIGNED_BYTE"},r8snorm:void 0,r8uint:{internalformat:"R8",format:"RED",type:"UNSIGNED_BYTE"},r8sint:void 0,r16uint:void 0,r16sint:void 0,r16float:{internalformat:"R16F",format:"RED",type:"HALF_FLOAT"},rg8unorm:void 0,rg8snorm:void 0,rg8uint:void 0,rg8sint:void 0,r32uint:void 0,r32sint:void 0,r32float:void 0,rg16uint:void 0,rg16sint:void 0,rg16float:{internalformat:"RG16F",format:"RG",type:"HALF_FLOAT"},rgba8unorm:{internalformat:"RGBA8",format:"RGBA",type:"UNSIGNED_BYTE"},"rgba8unorm-srgb":{internalformat:"SRGB8",format:"RGB",type:"UNSIGNED_BYTE"},rgba8snorm:void 0,rgba8uint:{internalformat:"RGBA8UI",format:"RGBA_INTEGER",type:"UNSIGNED_BYTE"},rgba8sint:void 0,bgra8unorm:void 0,"bgra8unorm-srgb":void 0,rgb9e5ufloat:void 0,rgb10a2uint:void 0,rgb10a2unorm:void 0,rg11b10ufloat:void 0,rg32uint:void 0,rg32sint:void 0,rg32float:void 0,rgba16uint:void 0,rgba16sint:void 0,rgba16float:{internalformat:"RGB16F",format:"RGB",type:"HALF_FLOAT"},rgba32uint:void 0,rgba32sint:void 0,rgba32float:{internalformat:"RGBA32F",format:"RGBA",type:"FLOAT"},stencil8:void 0,depth16unorm:{internalformat:"DEPTH_COMPONENT16",format:"DEPTH_COMPONENT",type:"UNSIGNED_SHORT"},depth24plus:void 0,"depth24plus-stencil8":void 0,depth32float:void 0,"depth32float-stencil8":void 0,"bc1-rgba-unorm":void 0,"bc1-rgba-unorm-srgb":void 0,"bc2-rgba-unorm":void 0,"bc2-rgba-unorm-srgb":void 0,"bc3-rgba-unorm":void 0,"bc3-rgba-unorm-srgb":void 0,"bc4-r-unorm":void 0,"bc4-r-snorm":void 0,"bc5-rg-unorm":void 0,"bc5-rg-snorm":void 0,"bc6h-rgb-ufloat":void 0,"bc6h-rgb-float":void 0,"bc7-rgba-unorm":void 0,"bc7-rgba-unorm-srgb":void 0,"etc2-rgb8unorm":void 0,"etc2-rgb8unorm-srgb":void 0,"etc2-rgb8a1unorm":void 0,"etc2-rgb8a1unorm-srgb":void 0,"etc2-rgba8unorm":void 0,"etc2-rgba8unorm-srgb":void 0,"eac-r11unorm":void 0,"eac-r11snorm":void 0,"eac-rg11unorm":void 0,"eac-rg11snorm":void 0,"astc-4x4-unorm":void 0,"astc-4x4-unorm-srgb":void 0,"astc-5x4-unorm":void 0,"astc-5x4-unorm-srgb":void 0,"astc-5x5-unorm":void 0,"astc-5x5-unorm-srgb":void 0,"astc-6x5-unorm":void 0,"astc-6x5-unorm-srgb":void 0,"astc-6x6-unorm":void 0,"astc-6x6-unorm-srgb":void 0,"astc-8x5-unorm":void 0,"astc-8x5-unorm-srgb":void 0,"astc-8x6-unorm":void 0,"astc-8x6-unorm-srgb":void 0,"astc-8x8-unorm":void 0,"astc-8x8-unorm-srgb":void 0,"astc-10x5-unorm":void 0,"astc-10x5-unorm-srgb":void 0,"astc-10x6-unorm":void 0,"astc-10x6-unorm-srgb":void 0,"astc-10x8-unorm":void 0,"astc-10x8-unorm-srgb":void 0,"astc-10x10-unorm":void 0,"astc-10x10-unorm-srgb":void 0,"astc-12x10-unorm":void 0,"astc-12x10-unorm-srgb":void 0,"astc-12x12-unorm":void 0,"astc-12x12-unorm-srgb":void 0};function We(t){if(t[k])return t[k];const r=t.colorAttachments[0].view.texture.size,n=[],s={colorAttachments:t.colorAttachments.map(a=>{const o=a.view.texture,c={internalformat:Xe(o.format),width:r[0],height:r[1]};return n.push(c),{...a,view:c}}),depthStencilAttachment:t.depthStencilAttachment,sampleCount:t.sampleCount},i={__type__:"BlitFramebuffer",read:s,draw:t,blitFramebuffers:[[0,0,r[0],r[1],0,0,r[0],r[1],"COLOR_BUFFER_BIT","NEAREST"]]};return t[k]={passDescriptor:s,blitFramebuffer:i,renderbuffers:n},t[k]}function Xe(t){const{internalformat:e}=Z(t);return e}const k="_IGLRenderPassDescriptorWithMultisample";function Y(t="2d"){const e=Ye[t];return console.assert(!!e,`WebGL 不支持纹理维度 ${t} , 该维度只在WebGPU中支持！`),e}const Ye={"1d":void 0,"2d":"TEXTURE_2D","2d-array":"TEXTURE_2D_ARRAY",cube:"TEXTURE_CUBE_MAP","cube-array":void 0,"3d":"TEXTURE_3D"},He={packAlignment:4,unpackAlignment:4,unpackFlipY:!1,unpackPremulAlpha:!1,unpackColorSpaceConversion:"BROWSER_DEFAULT_WEBGL",packRowLength:0,packSkipPixels:0,packSkipRows:0,unpackRowLength:0,unpackImageHeight:0,unpackSkipPixels:0,unpackSkipRows:0,unpackSkipImages:0};function ne(t,e){let r=t._textures.get(e);if(r)return r;(()=>{const o=Y(e.dimension),{internalformat:c,format:u,type:f}=Z(e.format);r=t.createTexture(),t._textures.set(e,r),t.bindTexture(t[o],r);const{sources:d,generateMipmap:m}=e,[_,T,E]=e.size,A=e.mipLevelCount||1;if(d)d.forEach(b=>{const{textureOrigin:h,size:x}=b,L=b.mipLevel??0,U=x==null?void 0:x[0],w=x==null?void 0:x[1];x==null||x[2],h==null||h[0],h==null||h[1];const P=h==null?void 0:h[2];if(t instanceof WebGL2RenderingContext){const F=b;if(F.image){const{image:R,imageOrigin:y,flipY:p,premultipliedAlpha:l}=F,S={};if(S.unpackSkipPixels=(y==null?void 0:y[0])||0,S.unpackSkipRows=(y==null?void 0:y[1])||0,S.unpackFlipY=p||!1,S.unpackPremulAlpha=l||!1,O(t,S),o==="TEXTURE_2D"||o==="TEXTURE_CUBE_MAP"){const C=o==="TEXTURE_CUBE_MAP"?N(P):o;U&&w?t.texImage2D(t[C],L,t[c],U,w,0,t[u],t[f],R):t.texImage2D(t[C],L,t[c],t[u],t[f],R)}else o==="TEXTURE_3D"||o==="TEXTURE_2D_ARRAY"?t.texImage3D(t[o],L,t[c],U,w,E,0,t[u],t[f],R):console.error(`未处理 ${o} 纹理初始化存储！`)}else{const R=b,{data:y,dataLayout:p,dataImageOrigin:l}=R,S=(p==null?void 0:p.offset)||0,C={};if(C.unpackSkipPixels=(l==null?void 0:l[0])||0,C.unpackSkipRows=(l==null?void 0:l[1])||0,C.unpackSkipImages=(l==null?void 0:l[2])||0,C.unpackRowLength=p==null?void 0:p.width,C.unpackImageHeight=p==null?void 0:p.height,O(t,C),o==="TEXTURE_2D"||o==="TEXTURE_CUBE_MAP"){const z=o==="TEXTURE_CUBE_MAP"?N(P):o;t.texImage2D(t[z],L,t[c],U,w,0,t[u],t[f],y,S)}else o==="TEXTURE_3D"||o==="TEXTURE_2D_ARRAY"?t.texImage3D(t[o],L,t[c],U,w,E,0,t[u],t[f],y,S):console.error(`未处理 ${o} 纹理初始化存储！`)}}else{const F=b;if(F.image){const{image:R,imageOrigin:y,flipY:p,premultipliedAlpha:l}=F,S={};if(S.unpackSkipPixels=(y==null?void 0:y[0])||0,S.unpackSkipRows=(y==null?void 0:y[1])||0,S.unpackFlipY=p||!1,S.unpackPremulAlpha=l||!1,O(t,S),o==="TEXTURE_2D"||o==="TEXTURE_CUBE_MAP"){const C=o==="TEXTURE_CUBE_MAP"?N(P):o;t.texImage2D(t[C],L,t[u],t[u],t[f],R)}else console.error(`未处理 ${o} 纹理初始化存储！`)}else{const R=b,{data:y,dataLayout:p,dataImageOrigin:l}=R,S=(p==null?void 0:p.offset)||0,C={};if(C.unpackSkipPixels=(l==null?void 0:l[0])||0,C.unpackSkipRows=(l==null?void 0:l[1])||0,C.unpackSkipImages=(l==null?void 0:l[2])||0,C.unpackRowLength=p==null?void 0:p.width,C.unpackImageHeight=p==null?void 0:p.height,O(t,C),o==="TEXTURE_2D"||o==="TEXTURE_CUBE_MAP"){const z=o==="TEXTURE_CUBE_MAP"?N(P):o;console.assert(S===0,"WebGL1中ITextureDataLayout.offset必须为0"),t.texImage2D(t[z],L,t[u],U,w,0,t[u],t[f],y)}else console.error(`未处理 ${o} 纹理初始化存储！`)}}}),m&&t.generateMipmap(t[o]);else if(t instanceof WebGL2RenderingContext)o==="TEXTURE_2D"||o==="TEXTURE_CUBE_MAP"?t.texStorage2D(t[o],A,t[c],_,T):o==="TEXTURE_3D"||o==="TEXTURE_2D_ARRAY"?t.texStorage3D(t[o],A,t[c],_,T,E):console.error(`未处理 ${o} 纹理初始化存储！`);else if(o==="TEXTURE_2D"||o==="TEXTURE_CUBE_MAP")for(let b=0;b<A;b++)t.texImage2D(t[o],b,t[u],_,T,0,t[u],t[f],null);else console.error(`未处理 ${o} 纹理初始化存储！`)})();const s=()=>{r.destroy()};v.watch(e,"sources",s);const i=()=>{const{writeTextures:o}=e;if(!o||o.length===0)return;const c=Y(e.dimension),{format:u,type:f}=Z(e.format);t.bindTexture(t[c],r),o.forEach(d=>{const{mipLevel:m,textureOrigin:_,size:T}=d,E=T==null?void 0:T[0],A=T==null?void 0:T[1],b=T==null?void 0:T[2],h=_==null?void 0:_[0],x=_==null?void 0:_[1],L=_==null?void 0:_[2],U=d;if(U.image){const{image:l,imageOrigin:S,flipY:C,premultipliedAlpha:z}=U,g={};if(g.unpackSkipPixels=(S==null?void 0:S[0])||0,g.unpackSkipRows=(S==null?void 0:S[1])||0,g.unpackFlipY=C||!1,g.unpackPremulAlpha=z||!1,O(t,g),t instanceof WebGL2RenderingContext)if(c==="TEXTURE_2D"||c==="TEXTURE_CUBE_MAP"){const H=c==="TEXTURE_CUBE_MAP"?N(b):c;E&&A?t.texSubImage2D(t[H],m,h,x,E,A,t[u],t[f],l):t.texSubImage2D(t[H],m,h,x,t[u],t[f],l)}else c==="TEXTURE_3D"||c==="TEXTURE_2D_ARRAY"?t.texSubImage3D(t[c],m,h,x,L,E,A,b,t[u],t[f],l):console.error(`未处理 WebGL1 中 ${c} 纹理类型的图片资源上传！`);else if(c==="TEXTURE_2D"||c==="TEXTURE_CUBE_MAP"){const H=c==="TEXTURE_CUBE_MAP"?N(b):c;t.texSubImage2D(t[H],m,h,x,t[u],t[f],l)}else console.error(`WebGL1 中 不支持 ${c} 纹理类型！`);return}const w=d,{data:P,dataLayout:F,dataImageOrigin:R}=w,y=(F==null?void 0:F.offset)||0,p={};if(p.unpackSkipPixels=(R==null?void 0:R[0])||0,p.unpackSkipRows=(R==null?void 0:R[1])||0,p.unpackSkipImages=(R==null?void 0:R[2])||0,p.unpackRowLength=F==null?void 0:F.width,p.unpackImageHeight=F==null?void 0:F.height,O(t,p),t instanceof WebGL2RenderingContext)if(c==="TEXTURE_2D"||c==="TEXTURE_CUBE_MAP"){const l=c==="TEXTURE_CUBE_MAP"?N(b):c;t.texSubImage2D(t[l],m,h,x,E,A,t[u],t[f],P,y)}else c==="TEXTURE_3D"||c==="TEXTURE_2D_ARRAY"?t.texSubImage3D(t[c],m,h,x,L,E,A,b,t[u],t[f],P,y):console.error(`未处理 WebGL1 中 ${c} 纹理类型的像素资源上传。`);else if(c==="TEXTURE_2D"||c==="TEXTURE_CUBE_MAP"){const l=c==="TEXTURE_CUBE_MAP"?N(b):c;t.texSubImage2D(t[l],m,h,x,E,A,t[u],t[f],P),console.assert(!y,"WebGL1 不支持 IGLTextureDataSource.dataLayout.offset ！")}else console.error(`WebGL1 中 不支持 ${c} 纹理类型！`)})};i(),v.watchs(e,["generateMipmap"],i),v.watch(e,"writeTextures",i);const a=(o,c)=>{o&&c&&o[0]===c[0]&&o[1]===c[1]&&(o[2]||1)===(c[2]||1)||r.destroy()};return v.watch(e,"size",a),r.destroy=()=>{t.deleteTexture(r),t._textures.delete(e),v.unwatchs(e,["generateMipmap"],i),v.unwatch(e,"sources",s),v.unwatch(e,"writeTextures",i),v.unwatch(e,"size",a),delete r.destroy},r}function $e(t,e){const r=t._textures.get(e);r&&r.destroy()}function O(t,e){const{packAlignment:r,unpackAlignment:n,unpackFlipY:s,unpackPremulAlpha:i,unpackColorSpaceConversion:a,packRowLength:o,packSkipPixels:c,packSkipRows:u,unpackRowLength:f,unpackImageHeight:d,unpackSkipPixels:m,unpackSkipRows:_,unpackSkipImages:T}={...He,...e};t.pixelStorei(t.PACK_ALIGNMENT,r),t.pixelStorei(t.UNPACK_ALIGNMENT,n),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,s),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t[a]),t instanceof WebGL2RenderingContext&&(t.pixelStorei(t.PACK_ROW_LENGTH,o),t.pixelStorei(t.PACK_SKIP_PIXELS,c),t.pixelStorei(t.PACK_SKIP_ROWS,u),t.pixelStorei(t.UNPACK_ROW_LENGTH,f),t.pixelStorei(t.UNPACK_IMAGE_HEIGHT,d),t.pixelStorei(t.UNPACK_SKIP_PIXELS,m),t.pixelStorei(t.UNPACK_SKIP_ROWS,_),t.pixelStorei(t.UNPACK_SKIP_IMAGES,T))}function N(t){const e=Ke[t];return console.assert(!!e,"CubeMap的depthOrArrayLayers值应在[0-5]之间！"),e}const Ke=["TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z"];function q(t,e){var a,o,c,u,f;if(!(((o=(a=e==null?void 0:e.colorAttachments)==null?void 0:a[0])==null?void 0:o.view)||((c=e==null?void 0:e.depthStencilAttachment)==null?void 0:c.view)))return null;let n=t._framebuffers.get(e);if(n)return n;const s=e.sampleCount;n=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,n),t._framebuffers.set(e,n);const i=[];if((u=e.colorAttachments)==null||u.forEach((d,m)=>{const _=d.view,T=t[`COLOR_ATTACHMENT${m}`];if(i.push(T),"texture"in _){const E=_.texture,A=_.baseMipLevel||0,b=_.baseArrayLayer||0,h=ne(t,E),x=Y(E.dimension);x==="TEXTURE_2D"?t.framebufferTexture2D(t.FRAMEBUFFER,T,t[x],h,A):x==="TEXTURE_2D_ARRAY"?t instanceof WebGL2RenderingContext&&t.framebufferTextureLayer(t.DRAW_FRAMEBUFFER,T,h,A,b):console.error(`未处理 ${x} 的颜色附件纹理设置！`)}else{const E=ge(t,_,s);t.framebufferRenderbuffer(t.FRAMEBUFFER,T,t.RENDERBUFFER,E)}}),t instanceof WebGL2RenderingContext?t.drawBuffers(i):console.error("WebGL1 不支持 drawBuffers 。"),(f=e.depthStencilAttachment)!=null&&f.view){const d=e.depthStencilAttachment.view,m=d.texture,_=d.baseMipLevel||0,T=d.baseArrayLayer||0,E=ne(t,m),A=Y(m.dimension);A==="TEXTURE_2D"?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t[A],E,_):A==="TEXTURE_2D_ARRAY"?t instanceof WebGL2RenderingContext&&t.framebufferTextureLayer(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,E,_,T):console.error(`未处理 ${A} 的深度模板附件纹理设置！`)}return n}function J(t,e,r=!0){if(r&&(e!=null&&e[k])){Qe(t,e[k]);return}const n=t._framebuffers.get(e);t._framebuffers.delete(e),t.deleteFramebuffer(n)}function Qe(t,e){J(t,e.blitFramebuffer.read,!1),J(t,e.blitFramebuffer.draw,!1),e.renderbuffers.forEach(r=>{Se(t,r)})}function qe(t){const e=tt[t];return console.assert(!!e),e}function Ze(t){return et[t]!==void 0}const Je={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676},Ce={SAMPLER_2D:35678,SAMPLER_CUBE:35680},je={UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690},Fe={SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311},Te={...Je,...Ce,...je,...Fe},et={...Ce,...Fe},tt=Object.keys(Te).reduce((t,e)=>(t[Te[e]]=e,t),{});function K(t,e){var o;const r=Le(e);let n=t._programs[r];if(n)return n;const s=e.vertex.code,i=((o=e.fragment)==null?void 0:o.code)||`#version 300 es
        precision highp float;
        precision highp int;

        void main()
        {
        }
    `,a=e.transformFeedbackVaryings;return n=nt(t,s,i,a),t._programs[r]=n,n}function rt(t,e){const r=Le(e),n=t._programs[r];n&&(delete t._programs[r],t.deleteProgram(n))}function Le(t){var s;const e=t.vertex.code,r=(s=t.fragment)==null?void 0:s.code,n=t.transformFeedbackVaryings;return`---vertexShader---
${e}
---fragment---
${r}
---feedback---${n==null?void 0:n.varyings.toString()} ${n==null?void 0:n.bufferMode}`}function nt(t,e,r,n){const s=Ee(t,"VERTEX_SHADER",e),i=Ee(t,"FRAGMENT_SHADER",r),a=st(t,s,i,n),o=t.getProgramParameter(a,t.ACTIVE_ATTRIBUTES),c=[];for(let m=0;m<o;m++){const _=t.getActiveAttrib(a,m),{name:T,size:E,type:A}=_,b=t.getAttribLocation(a,T),h=at(A);c.push({name:T,size:E,type:h,location:b})}const u=t.getProgramParameter(a,t.ACTIVE_UNIFORMS),f=[];let d=0;for(let m=0;m<u;m++){const _=t.getActiveUniform(a,m),{name:T,size:E,type:A}=_,b=qe(A),h=Ze(b),x=/(\w+)/g,L=[T];if(E>1){console.assert(T.substring(T.length-3)==="[0]");const w=T.substring(0,T.length-3);for(let P=1;P<E;P++)L[P]=`${w}[${P}]`}const U=[];for(let w=0;w<L.length;w++){const P=L[w];let F=x.exec(P);const R=[];for(;F;)R.push(F[1]),F=x.exec(P);const y=t.getUniformLocation(a,P);h?(U.push({location:y,paths:R,textureID:d}),d++):U.push({location:y,paths:R,textureID:-1})}f[m]={name:T,type:b,isTexture:h,items:U}}if(t instanceof WebGL2RenderingContext){const m=t.getProgramParameter(a,t.ACTIVE_UNIFORM_BLOCKS),_=new Array(m).fill(0).map((T,E)=>{t.uniformBlockBinding(a,E,E);const A=t.getActiveUniformBlockParameter(a,E,t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),b=[];for(let L=0;L<A.length;L++){const U=f[A[L]];U.inBlock=!0,b.push(U)}const x={name:t.getActiveUniformBlockName(a,E),index:E,dataSize:t.getActiveUniformBlockParameter(a,E,t.UNIFORM_BLOCK_DATA_SIZE),uniforms:b,bufferBindingInfo:void 0};return x.bufferBindingInfo=ot(x),x});a.uniformBlocks=_}return a.vertex=e,a.fragment=r,a.attributes=c,a.uniforms=f,a}function Ee(t,e,r){let n=t._shaders[r];if(n)return n;if(n=t.createShader(t[e]),t._shaders[r]=n,t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS)){const i=t.getShaderInfoLog(n);throw t.deleteShader(n),`Failed to compile shader: ${i}`}return n}function st(t,e,r,n){const s=t.createProgram();if(t.attachShader(s,e),t.attachShader(s,r),n&&(t instanceof WebGL2RenderingContext?t.transformFeedbackVaryings(s,n.varyings,t[n.bufferMode]):console.error("WebGL1 不支持 transformFeedbackVaryings 功能！")),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS)){const a=t.getProgramInfoLog(s);throw t.deleteProgram(s),t.deleteShader(r),t.deleteShader(e),`Failed to link program: ${a}`}return s}function ot(t){const e=t.dataSize;let r=0,n;const s=[];return t.uniforms.forEach(a=>{const o=a.type,c=it[o];console.assert(c,`没有找到 ${o} 统一缓冲类型对应的对齐与尺寸。`);const u=a.name.substring(0,a.name.lastIndexOf("."));n!==u&&(r=te(16,r),n=u),a.items.forEach(f=>{r=te(c.align,r);const d=r,m=c.size;r+=c.size;const _=c.clsType,T=f.paths.slice(1);s.push({paths:T,offset:d,size:m,Cls:_})})}),r=te(16,r),console.assert(e===r,`uniformBlock映射尺寸出现错误( ${e}  ${r} )！`),{size:t.dataSize,items:s}}function te(t,e){return Math.ceil(e/t)*t}const it={FLOAT:{align:4,size:4,clsType:Float32Array},FLOAT_VEC2:{align:8,size:8,clsType:Float32Array},FLOAT_VEC3:{align:16,size:12,clsType:Float32Array},FLOAT_VEC4:{align:16,size:16,clsType:Float32Array},INT:{align:4,size:4,clsType:Int32Array},INT_VEC2:{align:8,size:8,clsType:Int32Array},INT_VEC3:{align:16,size:12,clsType:Int32Array},INT_VEC4:{align:16,size:16,clsType:Int32Array},BOOL:{align:4,size:4,clsType:Int32Array},BOOL_VEC2:{align:8,size:8,clsType:Int32Array},BOOL_VEC3:{align:16,size:12,clsType:Int32Array},BOOL_VEC4:{align:16,size:16,clsType:Int32Array},FLOAT_MAT2:{align:8,size:16,clsType:Float32Array},FLOAT_MAT3:{align:16,size:48,clsType:Float32Array},FLOAT_MAT4:{align:16,size:64,clsType:Float32Array},UNSIGNED_INT:{align:4,size:4,clsType:Uint32Array},UNSIGNED_INT_VEC2:{align:8,size:8,clsType:Uint32Array},UNSIGNED_INT_VEC3:{align:16,size:12,clsType:Uint32Array},UNSIGNED_INT_VEC4:{align:16,size:16,clsType:Uint32Array},FLOAT_MAT2x3:{align:16,size:32,clsType:Float32Array},FLOAT_MAT2x4:{align:16,size:32,clsType:Float32Array},FLOAT_MAT3x2:{align:8,size:24,clsType:Float32Array},FLOAT_MAT3x4:{align:16,size:48,clsType:Float32Array},FLOAT_MAT4x2:{align:8,size:32,clsType:Float32Array},FLOAT_MAT4x3:{align:16,size:64,clsType:Float32Array}};function at(t){return ct[t]}const ct=Object.freeze({5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5124:"INT",5125:"UNSIGNED_INT",5126:"FLOAT",5131:"HALF_FLOAT"});function ut(t,e){if(!e||!(t instanceof WebGL2RenderingContext))return Q;let r=e._GLRenderOcclusionQuery;if(r)return r;const n=e.filter(a=>a.__type__==="OcclusionQuery");if(n.length===0)return e._GLRenderOcclusionQuery=Q,Q;const s=()=>{n.forEach((a,o)=>{a._step=ft(t,a)})},i=a=>{const o=n.map(c=>c._step.resolve());Promise.all(o).then(c=>{var u;(u=a.onOcclusionQuery)==null||u.call(a,n,c)})};return e._GLRenderOcclusionQuery=r={init:s,resolve:i},r}const Q={init:()=>{},resolve:()=>{}};function ft(t,e){const r={};let n;return{begin:()=>{n=t.createQuery(),t.beginQuery(t.ANY_SAMPLES_PASSED,n)},end:()=>{t.endQuery(t.ANY_SAMPLES_PASSED)},resolve:async()=>{if(r.result!==void 0)return r.result;if(t instanceof WebGL2RenderingContext)return await new Promise((c,u)=>{(function f(){if(!t.getQueryParameter(n,t.QUERY_RESULT_AVAILABLE)){requestAnimationFrame(f);return}const d=r.result=t.getQueryParameter(n,t.QUERY_RESULT);e.onQuery(d),c(d),t.deleteQuery(n)})()})}}}function Pe(t){const e=Ae[t];return console.assert(!!e,`接收到错误值，请从 ${Object.keys(Ae).toString()} 中取值！`),e}const Ae={never:"NEVER",less:"LESS",equal:"EQUAL","less-equal":"LEQUAL",greater:"GREATER","not-equal":"NOTEQUAL","greater-equal":"GEQUAL",always:"ALWAYS"};function _t(t,e){let r=t._samplers.get(e);if(r)return r;if(t instanceof WebGL2RenderingContext){r=t.createSampler(),t._samplers.set(e,r);const n=Ue(e.minFilter,e.mipmapFilter),s=we(e.magFilter),i=X(e.addressModeU),a=X(e.addressModeV),o=X(e.addressModeW),c=e.lodMinClamp||0,u=e.lodMaxClamp||16,f=e.compare?"COMPARE_REF_TO_TEXTURE":"NONE",d=Pe(e.compare??"less-equal");t.samplerParameteri(r,t.TEXTURE_MIN_FILTER,t[n]),t.samplerParameteri(r,t.TEXTURE_MAG_FILTER,t[s]),t.samplerParameteri(r,t.TEXTURE_WRAP_S,t[i]),t.samplerParameteri(r,t.TEXTURE_WRAP_T,t[a]),t.samplerParameteri(r,t.TEXTURE_WRAP_R,t[o]),t.samplerParameterf(r,t.TEXTURE_MIN_LOD,c),t.samplerParameterf(r,t.TEXTURE_MAX_LOD,u),t.samplerParameteri(r,t.TEXTURE_COMPARE_MODE,t[f]),t.samplerParameteri(r,t.TEXTURE_COMPARE_FUNC,t[d])}return r}function dt(t,e){if(t instanceof WebGL2RenderingContext){const r=t._samplers.get(e);t._samplers.delete(e),t.deleteSampler(r)}}function X(t="repeat"){const e=be[t];return console.assert(!!e,`接收到错误值，请从 ${Object.keys(be).toString()} 中取值！`),e}const be={"clamp-to-edge":"CLAMP_TO_EDGE",repeat:"REPEAT","mirror-repeat":"MIRRORED_REPEAT"};function Ue(t="nearest",e){let r;return t==="linear"?e==="linear"?r="LINEAR_MIPMAP_LINEAR":e==="nearest"?r="LINEAR_MIPMAP_NEAREST":r="LINEAR":e==="linear"?r="NEAREST_MIPMAP_LINEAR":e==="nearest"?r="NEAREST_MIPMAP_NEAREST":r="NEAREST",r}function we(t="nearest"){const e=le[t];return console.assert(!!e,`接收到错误值，请从 ${Object.keys(le).toString()} 中取值！`),e}const le={nearest:"NEAREST",linear:"LINEAR"};function mt(t,e){let r=t._transforms.get(e);return r||(t instanceof WebGL2RenderingContext&&(r=t.createTransformFeedback(),t._transforms.set(e,r),t.bindTransformFeedback(t.TRANSFORM_FEEDBACK,r),e.bindBuffers.forEach(n=>{const{index:s,data:i}=n,a=W(i,"ARRAY_BUFFER","STREAM_COPY"),o=D(t,a);t.bindBufferBase(t.TRANSFORM_FEEDBACK_BUFFER,s,o)}),t.bindBuffer(t.ARRAY_BUFFER,null)),r)}function Tt(t,e){const r=t._transforms.get(e);r&&(t._transforms.delete(e),t instanceof WebGL2RenderingContext&&t.deleteTransformFeedback(r))}const he="_GL_Submit_Times";function pe(t){return Et[t]}const Et={never:"NEVER",less:"LESS",equal:"EQUAL","less-equal":"LEQUAL",greater:"GREATER","not-equal":"NOTEQUAL","greater-equal":"GEQUAL",always:"ALWAYS"};function G(t){return At[t]}const At={keep:"KEEP",zero:"ZERO",replace:"REPLACE",invert:"INVERT","increment-clamp":"INCR","decrement-clamp":"DECR","increment-wrap":"INCR_WRAP","decrement-wrap":"DECR_WRAP"},re=new WeakMap;function bt(t,e){if(re.has(e)){const a=re.get(e);a.size!==t.size&&console.warn("updateBufferBinding 出现一份数据对应多个 variableInfo",{uniformData:e,bufferBindingInfo:t,preVariableInfo:a});return}re.set(e,t);const r=t.size,n=!!e.bufferView;n?console.assert(e.bufferView.byteLength===r,"uniformData.bufferView 统一块数据提供数据尺寸不对！"):e.bufferView=new Uint8Array(r);const s=W(e.bufferView),i=e.bufferView.byteOffset;t.items.forEach(a=>{const{paths:o,offset:c,size:u,Cls:f}=a,d=()=>{let m=e;for(let E=0;E<o.length;E++)if(m=m[o[E]],m===void 0){n||console.warn(`没有找到 统一块变量属性 ${o.join(".")} 的值！`);return}let _;typeof m=="number"?_=new f([m]):m.constructor.name!==f.name?_=new f(m):_=m;const T=s.writeBuffers??[];T.push({data:_.buffer,bufferOffset:i+c,size:Math.min(u,_.byteLength)}),s.writeBuffers=T};d(),v.watchchain(e,o.join("."),d,void 0,!1)})}class lt{runSubmit(e,r){r.commandEncoders.map(n=>this.runCommandEncoder(e,n)),e[he]=~~e[he]+1}runCommandEncoder(e,r){r.passEncoders.forEach(n=>{n.__type__?n.__type__==="RenderPass"?this.runRenderPass(e,n):n.__type__==="TransformFeedbackPass"?this.runTransformFeedbackPass(e,n):n.__type__==="BlitFramebuffer"?this.runBlitFramebuffer(e,n):n.__type__==="CopyTextureToTexture"?this.runCopyTextureToTexture(e,n):n.__type__==="CopyBufferToBuffer"?this.runCopyBuffer(e,n):console.error(`未处理 passEncoder ${n}`):this.runRenderPass(e,n)})}runTransformFeedbackPass(e,r){e instanceof WebGL2RenderingContext&&e.enable(e.RASTERIZER_DISCARD),r.transformFeedbackObjects.forEach(n=>{this.runTransformFeedbackObject(e,n)}),e instanceof WebGL2RenderingContext&&e.disable(e.RASTERIZER_DISCARD)}runRenderPass(e,r){var i;const n=ht(e,r.descriptor),s=ut(e,r.renderPassObjects);if(s.init(),(i=r.descriptor)!=null&&i.sampleCount&&r.descriptor.colorAttachments[0].view.texture){const{passDescriptor:a,blitFramebuffer:o}=We(r.descriptor);this.runRenderPassDescriptor(e,a),this.runRenderObjects(e,n,r.renderPassObjects),this.runBlitFramebuffer(e,o)}else this.runRenderPassDescriptor(e,r.descriptor),this.runRenderObjects(e,n,r.renderPassObjects);s.resolve(r)}runRenderPassDescriptor(e,r){var m;r=r||{};const n=q(e,r);e.bindFramebuffer(e.FRAMEBUFFER,n);const s=(m=r.colorAttachments)==null?void 0:m[0],i=(s==null?void 0:s.clearValue)??[0,0,0,0],a=(s==null?void 0:s.loadOp)??"clear";e.clearColor(i[0],i[1],i[2],i[3]);const o=r.depthStencilAttachment,c=(o==null?void 0:o.depthClearValue)??1,u=(o==null?void 0:o.depthLoadOp)??"load",f=(o==null?void 0:o.stencilClearValue)??0,d=(o==null?void 0:o.stencilLoadOp)??"load";e.clearDepth(c),e.clearStencil(f),e.clear((a==="clear"?e.COLOR_BUFFER_BIT:0)|(u==="clear"?e.DEPTH_BUFFER_BIT:0)|(d==="clear"?e.STENCIL_BUFFER_BIT:0))}runRenderObjects(e,r,n){n==null||n.forEach(s=>{s.__type__==="OcclusionQuery"?this.runOcclusionQuery(e,r,s):this.runRenderObject(e,r,s)})}runRenderObject(e,r,n){const{viewport:s,scissorRect:i,pipeline:a,vertices:o,indices:c,draw:u,bindingResources:f}=n,d=a==null?void 0:a.primitive;this.runViewPort(e,r,s),this.runScissor(e,r,i),this.runRenderPipeline(e,a),this.runUniforms(e,a,f),this.runVertexArray(e,a,o,c),this.runPrimitiveState(e,d);const m=(d==null?void 0:d.topology)||"triangle-list",_=me(m);u.__type__==="DrawVertex"?this.runDrawVertex(e,_,u):this.runDrawIndexed(e,_,c,u)}runTransformFeedbackObject(e,r){const{pipeline:n,vertices:s,uniforms:i,transformFeedback:a,draw:o}=r,c=me("point-list");this.runTransformFeedbackPipeline(e,n),this.runVertexArray(e,n,s,void 0),this.runUniforms(e,n,i),this.runTransformFeedback(e,a,c),this.runDrawVertex(e,c,o),this.endTransformFeedback(e,a)}endTransformFeedback(e,r){r&&e instanceof WebGL2RenderingContext&&(e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.TRANSFORM_FEEDBACK_BUFFER,null))}runDrawIndexed(e,r,n,s){const i=n.BYTES_PER_ELEMENT===2?"UNSIGNED_SHORT":"UNSIGNED_INT",a=s.indexCount,o=s.firstIndex||0,c=s.instanceCount||1,u=o*n.BYTES_PER_ELEMENT;c>1?e instanceof WebGL2RenderingContext?e.drawElementsInstanced(e[r],a,e[i],u,c):e.getExtension("ANGLE_instanced_arrays").drawElementsInstancedANGLE(e[r],a,e[i],u,c):e.drawElements(e[r],a,e[i],u)}runDrawVertex(e,r,n){const s=n.vertexCount,i=n.firstVertex||0,a=n.instanceCount||1;a>1?e instanceof WebGL2RenderingContext?e.drawArraysInstanced(e[r],i,s,a):e.getExtension("ANGLE_instanced_arrays").drawArraysInstancedANGLE(e[r],i,s,a):e.drawArrays(e[r],i,s)}runUniforms(e,r,n){const s=K(e,r);s.uniforms.forEach(i=>{const{name:a,type:o,items:c,isTexture:u,inBlock:f}=i;f||c.forEach(d=>{const{paths:m}=d;let _=n[m[0]];for(let T=1;T<m.length;T++)_=_[m[T]];_===void 0&&console.error(`沒有找到Uniform ${a} 數據！`),u?this.runSamplerTexture(e,d,_):this.runUniform(e,o,d,_)})}),e instanceof WebGL2RenderingContext&&s.uniformBlocks.forEach(i=>{const{name:a,index:o}=i;let u=n[a];if(!(u.buffer&&u.BYTES_PER_ELEMENT)){const m=n[a];bt(i.bufferBindingInfo,m),u=m.bufferView}const f=W(u,"UNIFORM_BUFFER","DYNAMIC_DRAW");f.target??(f.target="UNIFORM_BUFFER"),f.usage??(f.usage="DYNAMIC_DRAW"),f.label=f.label||`UniformBuffer ${a}`;const d=D(e,f);e.bindBufferBase(e.UNIFORM_BUFFER,o,d)})}runSamplerTexture(e,r,n){const{texture:s,sampler:i}=n,{location:a,textureID:o}=r,c=Y(s.dimension);e.uniform1i(a,o);const u=ne(e,s);return e.activeTexture(e[`TEXTURE${o}`]),e.bindTexture(e[c],u),this.runSampler(e,c,u,i,o),u}runSampler(e,r,n,s,i){if(e instanceof WebGL2RenderingContext){const o=_t(e,s);e.bindSampler(i,o)}else{const o=Ue(s.minFilter,s.mipmapFilter),c=we(s.magFilter),u=X(s.addressModeU),f=X(s.addressModeV);n.minFilter!==o&&(e.texParameteri(e[r],e.TEXTURE_MIN_FILTER,e[o]),n.minFilter=o),n.magFilter!==c&&(e.texParameteri(e[r],e.TEXTURE_MAG_FILTER,e[c]),n.magFilter=c),n.wrapS!==u&&(e.texParameteri(e[r],e.TEXTURE_WRAP_S,e[u]),n.wrapS=u),n.wrapT!==f&&(e.texParameteri(e[r],e.TEXTURE_WRAP_T,e[f]),n.wrapT=f)}const a=(s==null?void 0:s.maxAnisotropy)||1;if(n.maxAnisotropy!==a){const o=e.getExtension("EXT_texture_filter_anisotropic");o&&e.texParameterf(e[r],o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a,e._capabilities.maxAnisotropy)),n.maxAnisotropy=a}}runUniform(e,r,n,s){typeof s=="number"&&(s=[s]),s.toArray&&(s=s.toArray());const i=n.location;switch(r){case"BOOL":case"INT":e.uniform1iv(i,s);break;case"BOOL_VEC2":case"INT_VEC2":e.uniform2iv(i,s);break;case"BOOL_VEC3":case"INT_VEC3":e.uniform3iv(i,s);break;case"BOOL_VEC4":case"INT_VEC4":e.uniform4iv(i,s);break;case"FLOAT":e.uniform1fv(i,[s]);break;case"FLOAT_VEC2":e.uniform2fv(i,s);break;case"FLOAT_VEC3":e.uniform3fv(i,s);break;case"FLOAT_VEC4":e.uniform4fv(i,s);break;case"FLOAT_MAT2":e.uniformMatrix2fv(i,!1,s);break;case"FLOAT_MAT3":e.uniformMatrix3fv(i,!1,s);break;case"FLOAT_MAT4":e.uniformMatrix4fv(i,!1,s);break;case"UNSIGNED_INT":e.uniform1uiv(i,s);break;case"UNSIGNED_INT_VEC2":e.uniform2uiv(i,s);break;case"UNSIGNED_INT_VEC3":e.uniform3uiv(i,s);break;case"UNSIGNED_INT_VEC4":e.uniform4uiv(i,s);break;case"FLOAT_MAT2x3":e.uniformMatrix2x3fv(i,!1,s);break;case"FLOAT_MAT2x4":e.uniformMatrix2x4fv(i,!1,s);break;case"FLOAT_MAT3x2":e.uniformMatrix3x2fv(i,!1,s);break;case"FLOAT_MAT3x4":e.uniformMatrix3x4fv(i,!1,s);break;case"FLOAT_MAT4x2":e.uniformMatrix4x2fv(i,!1,s);break;case"FLOAT_MAT4x3":e.uniformMatrix4x3fv(i,!1,s);break;default:console.error(`无法识别的uniform类型 ${n.paths} ${r}`)}}runVertexArray(e,r,n,s){if(!n&&!s)return;let i;if(e instanceof WebGL2RenderingContext){if(i=e._vertexArrays.get([r,n,s]),i){e.bindVertexArray(i);return}i=e.createVertexArray(),e.bindVertexArray(i),e._vertexArrays.set([r,n,s],i)}K(e,r).attributes.forEach(o=>{const{name:c,location:u}=o;if(u<0)return;const f=n[c];f||console.error(`缺少顶点 ${c} 数据！`),this.runVertexAttribute(e,u,f)}),this.runIndexBuffer(e,s)}runIndexBuffer(e,r){if(!r)return;const n=W(r,"ELEMENT_ARRAY_BUFFER");n.target??(n.target="ELEMENT_ARRAY_BUFFER"),n.usage??(n.usage="STATIC_DRAW");const s=D(e,n);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s)}runVertexAttribute(e,r,n){const{stepMode:s,format:i}=n;let{arrayStride:a,offset:o}=n;const c=Ie[i],{numComponents:u,normalized:f,type:d}=c;e.enableVertexAttribArray(r),s==="instance"&&(e instanceof WebGL2RenderingContext?e.vertexAttribDivisor(r,1):e.getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(r,1)),a=a||0,o=o||0;const m=W(n.data,"ARRAY_BUFFER","STATIC_DRAW");m.target??(m.target="ARRAY_BUFFER");const _=D(e,m);e.bindBuffer(e.ARRAY_BUFFER,_),e instanceof WebGL2RenderingContext&&(d==="INT"||d==="UNSIGNED_INT")?e.vertexAttribIPointer(r,u,e[d],a,o):e.vertexAttribPointer(r,u,e[d],f,a,o)}runTransformFeedback(e,r,n){if(e instanceof WebGL2RenderingContext)if(r){const s=mt(e,r);e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,s),e.beginTransformFeedback(e[n])}else e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null);else r&&console.log("WebGL1 不支持顶点着色器回写数据功能！")}runTransformFeedbackPipeline(e,r){const n=K(e,r);e.useProgram(n)}runRenderPipeline(e,r){this.runProgram(e,r),this.runDepthState(e,r.depthStencil),this.runStencilState(e,r.depthStencil)}runStencilState(e,r){const{stencilFront:n,stencilBack:s}={...r};if(n||s){const i=r.stencilReference??0,a=r.stencilReadMask??4294967295,o=r.stencilWriteMask??4294967295;if(e.enable(e.STENCIL_TEST),n){const c=pe(n.compare??"always"),u=G(n.failOp),f=G(n.depthFailOp),d=G(n.passOp);e.stencilFuncSeparate(e.FRONT,e[c],i,a),e.stencilOpSeparate(e.FRONT,e[u],e[f],e[d]),e.stencilMaskSeparate(e.FRONT,o)}if(s){const c=pe(s.compare??"always"),u=G(s.failOp),f=G(s.depthFailOp),d=G(s.passOp);e.stencilFuncSeparate(e.BACK,e[c],i,a),e.stencilOpSeparate(e.BACK,e[u],e[f],e[d]),e.stencilMaskSeparate(e.BACK,o)}}else e.disable(e.STENCIL_TEST)}runDepthState(e,r){if(r&&(r.depthWriteEnabled||r.depthCompare!=="always")){const n=Pe(r.depthCompare??"less"),s=r.depthWriteEnabled??!0;if(e.enable(e.DEPTH_TEST),e.depthFunc(e[n]),e.depthMask(s),r.depthBias||r.depthBiasSlopeScale){const i=r.depthBiasSlopeScale??0,a=r.depthBias??0;e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(i,a)}else e.disable(e.POLYGON_OFFSET_FILL)}else e.disable(e.DEPTH_TEST)}runPrimitiveState(e,r){const n=(r==null?void 0:r.cullFace)||"none",s=(r==null?void 0:r.frontFace)||"ccw";if(n!=="none"){const i=xe[n];console.assert(!!i,`接收到错误值，请从 ${Object.keys(xe).toString()} 中取值！`);const a=ye[s];console.assert(!!a,`接收到错误 IFrontFace 值，请从 ${Object.keys(ye).toString()} 中取值！`),e.enable(e.CULL_FACE),e.cullFace(e[i]),e.frontFace(e[a])}else e.disable(e.CULL_FACE)}runProgram(e,r){const n=K(e,r);e.useProgram(n),this.runColorTargetStates(e,r.fragment.targets)}runColorTargetStates(e,r){var i,a;const n=((i=r==null?void 0:r[0])==null?void 0:i.writeMask)||[!0,!0,!0,!0];e.colorMask(n[0],n[1],n[2],n[3]);const s=(a=r==null?void 0:r[0])==null?void 0:a.blend;if(s){const o=s.color,c=s.alpha,u=oe(o==null?void 0:o.operation)||"FUNC_ADD",f=$(o==null?void 0:o.srcFactor,o==null?void 0:o.operation)||"SRC_ALPHA",d=$(o==null?void 0:o.dstFactor,o==null?void 0:o.operation)||"ONE_MINUS_SRC_ALPHA",m=oe(c==null?void 0:c.operation)||u,_=$(c==null?void 0:c.srcFactor,o==null?void 0:o.operation)||f,T=$(c==null?void 0:c.dstFactor,o==null?void 0:o.operation)||d;if(Ne.getBlendConstantColor(s)){const A=s.constantColor??[0,0,0,0];e.blendColor(A[0],A[1],A[2],A[3])}e.enable(e.BLEND),e.blendEquationSeparate(e[u],e[m]),e.blendFuncSeparate(e[f],e[d],e[_],e[T])}else e.disable(e.BLEND)}runOcclusionQuery(e,r,n){n._step.begin(),n.renderObjects.forEach(s=>{this.runRenderObject(e,r,s)}),n._step.end()}runViewPort(e,r,n){if(n){const s=n.isYup??!0,i=n.x??0;let a=n.y??0;const o=n.width??r.width,c=n.height??r.height;s||(a=r.height-a-c),e.viewport(i,a,o,c)}else e.viewport(0,0,r.width,r.height)}runScissor(e,r,n){if(n){const s=n.isYup??!0,i=n.x??0;let a=n.y??0;const o=n.width??r.width,c=n.height??r.height;s||(a=r.height-a-c),e.enable(e.SCISSOR_TEST),e.scissor(i,a,o,c)}else e.disable(e.SCISSOR_TEST)}runCopyTextureToTexture(e,r){const n=Oe(r);this.runBlitFramebuffer(e,n)}runBlitFramebuffer(e,r){const{read:n,draw:s,blitFramebuffers:i}=r,a=q(e,n),o=q(e,s);e instanceof WebGL2RenderingContext&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,a),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,o),s.colorAttachments.forEach((c,u)=>{var d;const f=(d=s.colorAttachments[u])==null?void 0:d.clearValue;f&&e.clearBufferfv(e.COLOR,u,f)}),i.forEach(c=>{const[u,f,d,m,_,T,E,A,b,h]=c;e.blitFramebuffer(u,f,d,m,_,T,E,A,e[b],e[h])}))}runCopyBuffer(e,r){if(e instanceof WebGL2RenderingContext){const{source:n,destination:s,sourceOffset:i,destinationOffset:a,size:o}=r,c=D(e,n),u=D(e,s);e.bindBuffer(e.COPY_READ_BUFFER,c),e.bindBuffer(e.COPY_WRITE_BUFFER,u),e.copyBufferSubData(e.COPY_READ_BUFFER,e.COPY_WRITE_BUFFER,i,a,o),e.bindBuffer(e.COPY_READ_BUFFER,null),e.bindBuffer(e.COPY_WRITE_BUFFER,null)}else console.error("WebGL1 不支持拷贝缓冲区功能！")}}const xe=Object.freeze({FRONT_AND_BACK:"FRONT_AND_BACK",none:"BACK",front:"FRONT",back:"BACK"}),ye=Object.freeze({ccw:"CCW",cw:"CW"});function ht(t,e){var s;if(!e)return{width:t.drawingBufferWidth,height:t.drawingBufferHeight};const r=e.colorAttachments;if(r){const i=(s=r[0])==null?void 0:s.view;return i?{width:i.texture.size[0],height:i.texture.size[1]}:{width:t.drawingBufferWidth,height:t.drawingBufferHeight}}const n=e.depthStencilAttachment;if(n){const i=n.view;return i?{width:i.texture.size[0],height:i.texture.size[1]}:{width:t.drawingBufferWidth,height:t.drawingBufferHeight}}return{width:t.drawingBufferWidth,height:t.drawingBufferHeight}}class pt{constructor(e,r="highp"){this._gl=e,this._precision=r}get maxAnisotropy(){return this._maxAnisotropy?this._maxAnisotropy:(this._maxAnisotropy=this._gl.getExtension("EXT_texture_filter_anisotropic")?this._gl.getParameter(this._gl.getExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._maxAnisotropy)}get maxTextures(){return this._maxTextures?this._maxTextures:(this._maxTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._maxTextures)}get maxVertexTextures(){return this._maxVertexTextures?this._maxVertexTextures:(this._maxVertexTextures=this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures)}get maxTextureSize(){return this._maxTextureSize?this._maxTextureSize:(this._maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._maxTextureSize)}get maxCubemapSize(){return this._maxCubemapSize?this._maxCubemapSize:(this._maxCubemapSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxCubemapSize)}get maxAttributes(){return this._maxAttributes?this._maxAttributes:(this._maxAttributes=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),this._maxAttributes)}get maxVertexUniforms(){return this._maxVertexUniforms?this._maxVertexUniforms:(this._maxVertexUniforms=this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),this._maxVertexUniforms)}get maxVaryings(){return this._maxVaryings?this._maxVaryings:(this._maxVaryings=this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),this._maxVaryings)}get maxFragmentUniforms(){return this._maxFragmentUniforms?this._maxFragmentUniforms:(this._maxFragmentUniforms=this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxFragmentUniforms)}get vertexTextures(){return this._vertexTextures?this._vertexTextures:(this._vertexTextures=this.maxVertexTextures>0,this._vertexTextures)}get floatFragmentTextures(){return this._floatFragmentTextures?this._floatFragmentTextures:(this._floatFragmentTextures=this._gl instanceof WebGL2RenderingContext||!!this._gl.getExtension("OES_texture_float"),this._floatFragmentTextures)}get floatVertexTextures(){return this._floatVertexTextures?this._floatVertexTextures:(this._floatVertexTextures=this.vertexTextures&&this.floatFragmentTextures,this._floatVertexTextures)}get maxPrecision(){return this._maxPrecision?this._maxPrecision:(this._maxPrecision=xt(this._gl,this._precision),this._maxPrecision)}get maxSamples(){return this._maxSamples?this._maxSamples:(this._maxSamples=this._gl instanceof WebGL2RenderingContext?this._gl.getParameter(this._gl.MAX_SAMPLES):0,this._maxSamples)}get stencilBits(){return this._stencilBits?this._stencilBits:(this._stencilBits=this._gl.getParameter(this._gl.STENCIL_BITS),this._stencilBits)}get vaoAvailable(){return this._vaoAvailable?this._vaoAvailable:(this._vaoAvailable=this._gl instanceof WebGL2RenderingContext||!!this._gl.getExtension("OES_vertex_array_object"),this._vaoAvailable)}}function xt(t,e="highp"){if(e==="highp"){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}return e==="mediump"&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}function yt(t){let e=t._gl;if(e)return e;const r=typeof t.canvasId=="string"?document.getElementById(t.canvasId):t.canvasId;return e=t._gl=Ft(r,t),t.webGLContextAttributes,e._capabilities=new pt(e),e._bufferMap=new WeakMap,e._textures=new WeakMap,e._renderbuffers=new WeakMap,e._framebuffers=new WeakMap,e._vertexArrays=new Me,e._samplers=new WeakMap,e._transforms=new WeakMap,e._programs={},e._shaders={},r.addEventListener("webglcontextlost",Rt,!1),r.addEventListener("webglcontextrestored",St,!1),r.addEventListener("webglcontextcreationerror",Ct,!1),e}function Rt(t){t.preventDefault(),console.warn("WebGLRenderer: Context Lost.")}function St(){console.warn("WebGLRenderer: Context Restored.")}function Ct(t){console.error("WebGLRenderer: A WebGL context could not be created. Reason: ",t.statusMessage)}function Ft(t,e){const r=Object.assign({},ve,e.webGLContextAttributes);let n=t.getContext(e.webGLcontextId||"webgl2",r);return n||console.warn("无法使用用户提供参数获取指定WebGL上下文",r),n=t.getContext("webgl2",r)||t.getContext("webgl2")||t.getContext("webgl",r)||t.getContext("webgl"),n||console.error("无法获取WebGL上下文。"),n}function Lt(t,e){let r;if(t instanceof WebGL2RenderingContext){const{textureView:n,origin:s,copySize:i}=e,a="COLOR_ATTACHMENT0",[o,c]=i,{format:u,type:f}=Z(n.texture.format),d=ce.getTextureBytesPerPixel(n.texture.format),m=ce.getTextureDataConstructor(n.texture.format),T=o*d*c;r=new m(T/m.BYTES_PER_ELEMENT);const E={colorAttachments:[{view:n}]},A=q(t,E);t.bindFramebuffer(t.FRAMEBUFFER,A),t.readBuffer(t[a]),t.readPixels(s[0],s[1],o,c,t[u],t[f],r,0),J(t,E)}else console.error("WebGL1 不支持 readBuffer/readPixels ！");return r}class Pt{constructor(e){this._runWebGL=new lt,this._renderingContext=e,this._gl=yt(this._renderingContext)}submit(e){this._runWebGL.runSubmit(this._gl,e)}readPixels(e){return e.result=Lt(this._gl,e),e.result}deleteFramebuffer(e){J(this._gl,e)}deleteRenderbuffer(e){Se(this._gl,e)}deleteBuffer(e){ke(this._gl,e)}deleteTexture(e){$e(this._gl,e)}deleteSampler(e){dt(this._gl,e)}deleteProgram(e){rt(this._gl,e)}deleteTransformFeedback(e){Tt(this._gl,e)}}export{Pt as W,W as g,Ie as v};
//# sourceMappingURL=WebGL-b4686ab5.js.map
