var Bt=Object.defineProperty;var Gt=(e,t,r)=>t in e?Bt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var w=(e,t,r)=>Gt(e,typeof t!="symbol"?t+"":t,r);var Dt=Object.defineProperty,gt=(e,t,r)=>t in e?Dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Oe=(e,t,r)=>gt(e,typeof t!="symbol"?t+"":t,r);const zt={uint8x2:{numComponents:2,type:"UNSIGNED_BYTE",normalized:!1,dataType:"unsigned int",byteSize:2,wgslType:"vec2<u32>",typedArrayConstructor:Uint8Array},uint8x4:{numComponents:4,type:"UNSIGNED_BYTE",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"vec4<u32>",typedArrayConstructor:Uint8Array},sint8x2:{numComponents:2,type:"BYTE",normalized:!1,dataType:"signed int",byteSize:2,wgslType:"vec2<i32>",typedArrayConstructor:Int8Array},sint8x4:{numComponents:4,type:"BYTE",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"vec4<i32>",typedArrayConstructor:Int8Array},unorm8x2:{numComponents:2,type:"UNSIGNED_BYTE",normalized:!0,dataType:"unsigned normalized",byteSize:2,wgslType:"vec2<f32>",typedArrayConstructor:Uint8Array},unorm8x4:{numComponents:4,type:"UNSIGNED_BYTE",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Uint8Array},snorm8x2:{numComponents:2,type:"BYTE",normalized:!0,dataType:"signed normalized",byteSize:2,wgslType:"vec2<f32>",typedArrayConstructor:Int8Array},snorm8x4:{numComponents:4,type:"BYTE",normalized:!0,dataType:"signed normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Int8Array},uint16x2:{numComponents:2,type:"UNSIGNED_SHORT",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"vec2<u32>",typedArrayConstructor:Uint16Array},uint16x4:{numComponents:4,type:"UNSIGNED_SHORT",normalized:!1,dataType:"unsigned int",byteSize:8,wgslType:"vec4<u32>",typedArrayConstructor:Uint16Array},sint16x2:{numComponents:2,type:"SHORT",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"vec2<i32>",typedArrayConstructor:Int16Array},sint16x4:{numComponents:4,type:"SHORT",normalized:!1,dataType:"signed int",byteSize:8,wgslType:"vec4<i32>",typedArrayConstructor:Int16Array},unorm16x2:{numComponents:2,type:"UNSIGNED_SHORT",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec2<f32>",typedArrayConstructor:Uint16Array},unorm16x4:{numComponents:4,type:"UNSIGNED_SHORT",normalized:!0,dataType:"unsigned normalized",byteSize:8,wgslType:"vec4<f32>",typedArrayConstructor:Uint16Array},snorm16x2:{numComponents:2,type:"SHORT",normalized:!0,dataType:"signed normalized",byteSize:4,wgslType:"vec2<f32>",typedArrayConstructor:Int16Array},snorm16x4:{numComponents:4,type:"SHORT",normalized:!0,dataType:"signed normalized",byteSize:8,wgslType:"vec4<f32>",typedArrayConstructor:Int16Array},float16x2:{numComponents:2,type:"HALF_FLOAT",normalized:!1,dataType:"float",byteSize:4,wgslType:"vec2<f16>",typedArrayConstructor:Int16Array},float16x4:{numComponents:4,type:"HALF_FLOAT",normalized:!1,dataType:"float",byteSize:8,wgslType:"vec4<f16>",typedArrayConstructor:Int16Array},float32:{numComponents:1,type:"FLOAT",normalized:!1,dataType:"float",byteSize:4,wgslType:"f32",typedArrayConstructor:Float32Array},float32x2:{numComponents:2,type:"FLOAT",normalized:!1,dataType:"float",byteSize:8,wgslType:"vec2<f32>",typedArrayConstructor:Float32Array},float32x3:{numComponents:3,type:"FLOAT",normalized:!1,dataType:"float",byteSize:12,wgslType:"vec3<f32>",typedArrayConstructor:Float32Array},float32x4:{numComponents:4,type:"FLOAT",normalized:!1,dataType:"float",byteSize:16,wgslType:"vec4<f32>",typedArrayConstructor:Float32Array},uint32:{numComponents:1,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:4,wgslType:"u32",typedArrayConstructor:Uint32Array},uint32x2:{numComponents:2,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:8,wgslType:"vec2<u32>",typedArrayConstructor:Uint32Array},uint32x3:{numComponents:3,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:12,wgslType:"vec3<u32>",typedArrayConstructor:Uint32Array},uint32x4:{numComponents:4,type:"UNSIGNED_INT",normalized:!1,dataType:"unsigned int",byteSize:16,wgslType:"vec4<u32>",typedArrayConstructor:Uint32Array},sint32:{numComponents:1,type:"INT",normalized:!1,dataType:"signed int",byteSize:4,wgslType:"i32",typedArrayConstructor:Int32Array},sint32x2:{numComponents:2,type:"INT",normalized:!1,dataType:"signed int",byteSize:8,wgslType:"vec2<i32>",typedArrayConstructor:Int32Array},sint32x3:{numComponents:3,type:"INT",normalized:!1,dataType:"signed int",byteSize:12,wgslType:"vec3<i32>",typedArrayConstructor:Int32Array},sint32x4:{numComponents:4,type:"INT",normalized:!1,dataType:"signed int",byteSize:16,wgslType:"vec4<i32>",typedArrayConstructor:Int32Array},"unorm10-10-10-2":{numComponents:4,type:"UNSIGNED_INT_2_10_10_10_REV",normalized:!0,dataType:"unsigned normalized",byteSize:4,wgslType:"vec4<f32>",typedArrayConstructor:Int32Array}},Ie={operation:"add",srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha"};class Vt{static getBlendConstantColor(t){if(!t)return;const{color:r,alpha:n}=t;if((r==null?void 0:r.srcFactor)==="constant"||(r==null?void 0:r.srcFactor)==="one-minus-constant"||(r==null?void 0:r.dstFactor)==="constant"||(r==null?void 0:r.dstFactor)==="one-minus-constant"||(n==null?void 0:n.srcFactor)==="constant"||(n==null?void 0:n.srcFactor)==="one-minus-constant"||(n==null?void 0:n.dstFactor)==="constant"||(n==null?void 0:n.dstFactor)==="one-minus-constant"){const s=t.constantColor;return s||(s??[0,0,0,0])}}}class H{static getBuffer(t){let r=this.bufferMap.get(t);return r||(r={size:Math.ceil(t.byteLength/4)*4,data:t},this.bufferMap.set(t,r),r)}}Oe(H,"bufferMap",new WeakMap);class Z{static getTextureBytesPerPixel(t="rgba8unorm"){var r;const n=(r=$e[t])==null?void 0:r.bytesPerPixel;return console.assert(!!n,`未处理格式 ${t} ，无法查询到该格式中每个像素占用的字节数量！`),n}static getTextureDataConstructor(t="rgba8unorm"){var r;const n=(r=$e[t])==null?void 0:r.dataConstructor;return console.assert(!!n,`未处理格式 ${t} ，无法查询到该格式的纹理数据构造函数！`),n}}const $e={r8unorm:{bytesPerPixel:1,dataConstructor:Uint8Array},r8snorm:{bytesPerPixel:1,dataConstructor:Int8Array},r8uint:{bytesPerPixel:1,dataConstructor:Uint8Array},r8sint:{bytesPerPixel:1,dataConstructor:Int8Array},r16uint:{bytesPerPixel:2,dataConstructor:Uint16Array},r16sint:{bytesPerPixel:2,dataConstructor:Int16Array},r16float:{bytesPerPixel:2,dataConstructor:Uint16Array},rg8unorm:{bytesPerPixel:2,dataConstructor:Uint8Array},rg8snorm:{bytesPerPixel:2,dataConstructor:Int8Array},rg8uint:{bytesPerPixel:2,dataConstructor:Uint8Array},rg8sint:{bytesPerPixel:2,dataConstructor:Int8Array},r32uint:{bytesPerPixel:4,dataConstructor:Uint32Array},r32sint:{bytesPerPixel:4,dataConstructor:Int32Array},r32float:{bytesPerPixel:4,dataConstructor:Float32Array},rg16uint:{bytesPerPixel:4,dataConstructor:Uint16Array},rg16sint:{bytesPerPixel:4,dataConstructor:Int16Array},rg16float:{bytesPerPixel:4,dataConstructor:Uint16Array},rgba8unorm:{bytesPerPixel:4,dataConstructor:Uint8Array},"rgba8unorm-srgb":{bytesPerPixel:4,dataConstructor:Uint8Array},rgba8snorm:{bytesPerPixel:4,dataConstructor:Int8Array},rgba8uint:{bytesPerPixel:4,dataConstructor:Uint8Array},rgba8sint:{bytesPerPixel:4,dataConstructor:Int8Array},bgra8unorm:{bytesPerPixel:4,dataConstructor:Uint8Array},"bgra8unorm-srgb":{bytesPerPixel:4,dataConstructor:Uint8Array},rgb9e5ufloat:{bytesPerPixel:4,dataConstructor:Uint32Array},rgb10a2uint:{bytesPerPixel:4,dataConstructor:Uint32Array},rgb10a2unorm:{bytesPerPixel:4,dataConstructor:Uint32Array},rg11b10ufloat:{bytesPerPixel:4,dataConstructor:Uint32Array},rg32uint:{bytesPerPixel:8,dataConstructor:Uint32Array},rg32sint:{bytesPerPixel:8,dataConstructor:Int32Array},rg32float:{bytesPerPixel:8,dataConstructor:Float32Array},rgba16uint:{bytesPerPixel:8,dataConstructor:Uint16Array},rgba16sint:{bytesPerPixel:8,dataConstructor:Int16Array},rgba16float:{bytesPerPixel:8,dataConstructor:Uint16Array},rgba32uint:{bytesPerPixel:16,dataConstructor:Uint32Array},rgba32sint:{bytesPerPixel:16,dataConstructor:Int32Array},rgba32float:{bytesPerPixel:16,dataConstructor:Float32Array},stencil8:{bytesPerPixel:1,dataConstructor:Uint8Array},depth16unorm:{bytesPerPixel:2,dataConstructor:Uint16Array},depth24plus:{bytesPerPixel:3,dataConstructor:Uint8Array},"depth24plus-stencil8":{bytesPerPixel:4},depth32float:{bytesPerPixel:4},"depth32float-stencil8":{bytesPerPixel:5},"bc1-rgba-unorm":void 0,"bc1-rgba-unorm-srgb":void 0,"bc2-rgba-unorm":void 0,"bc2-rgba-unorm-srgb":void 0,"bc3-rgba-unorm":void 0,"bc3-rgba-unorm-srgb":void 0,"bc4-r-unorm":void 0,"bc4-r-snorm":void 0,"bc5-rg-unorm":void 0,"bc5-rg-snorm":void 0,"bc6h-rgb-ufloat":void 0,"bc6h-rgb-float":void 0,"bc7-rgba-unorm":void 0,"bc7-rgba-unorm-srgb":void 0,"etc2-rgb8unorm":void 0,"etc2-rgb8unorm-srgb":void 0,"etc2-rgb8a1unorm":void 0,"etc2-rgb8a1unorm-srgb":void 0,"etc2-rgba8unorm":void 0,"etc2-rgba8unorm-srgb":void 0,"eac-r11unorm":void 0,"eac-r11snorm":void 0,"eac-rg11unorm":void 0,"eac-rg11snorm":void 0,"astc-4x4-unorm":void 0,"astc-4x4-unorm-srgb":void 0,"astc-5x4-unorm":void 0,"astc-5x4-unorm-srgb":void 0,"astc-5x5-unorm":void 0,"astc-5x5-unorm-srgb":void 0,"astc-6x5-unorm":void 0,"astc-6x5-unorm-srgb":void 0,"astc-6x6-unorm":void 0,"astc-6x6-unorm-srgb":void 0,"astc-8x5-unorm":void 0,"astc-8x5-unorm-srgb":void 0,"astc-8x6-unorm":void 0,"astc-8x6-unorm-srgb":void 0,"astc-8x8-unorm":void 0,"astc-8x8-unorm-srgb":void 0,"astc-10x5-unorm":void 0,"astc-10x5-unorm-srgb":void 0,"astc-10x6-unorm":void 0,"astc-10x6-unorm-srgb":void 0,"astc-10x8-unorm":void 0,"astc-10x8-unorm-srgb":void 0,"astc-10x10-unorm":void 0,"astc-10x10-unorm-srgb":void 0,"astc-12x10-unorm":void 0,"astc-12x10-unorm-srgb":void 0,"astc-12x12-unorm":void 0,"astc-12x12-unorm-srgb":void 0};class Wt{constructor(){Oe(this,"_map",new WeakMap),Oe(this,"_size",0)}get size(){return this._size}get(t){const r=t.length;let n=this._map,s;for(let o=0,i=r-1;o<i;o++)if(s=J(t[o]),n=n.get(s),n===void 0)return;return s=J(t[r-1]),n.get(s)}set(t,r){const n=t.length;let s=this._map,o;for(let i=0;i<n-1;i++)o=J(t[i]),s.has(o)||s.set(o,new WeakMap),s=s.get(o);return o=J(t[n-1]),s.has(o)||(s.set(o,r),this._size++),r}delete(t){const r=t.length;let n=this._map,s;for(let i=0;i<r-1;i++)if(s=J(t[i]),n=n.get(s),n===void 0)return!1;s=J(t[r-1]);const o=n.delete(s);return o&&this._size--,o}}const we=new Map;let kt=0;function J(e){if(typeof e=="object"&&e!==null)return e;if(we.has(e))return we.get(e);const r={__id:kt++,__value:e};return we.set(e,r),r}console.log("@feng3d/render-api v0.1.0");const Xt={depth:!0,stencil:!0,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};var Yt=Object.defineProperty,Ht=(e,t,r)=>t in e?Yt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,G=(e,t,r)=>Ht(e,typeof t!="symbol"?t+"":t,r),Qe,qe;const pt=class Be{constructor(){G(this,"_value"),G(this,"_parents",new Map)}get value(){return this.track(),this._value}track(){if(!Be.activeReactivity||!$)return;const t=Be.activeReactivity;t&&this._parents.set(t,t._version)}trigger(){this._parents.forEach((t,r)=>{r._version===t&&(r.trigger(),r._children.set(this,this._value))}),this._parents.clear()}};G(pt,"activeReactivity");let M=pt;function Kt(e){const t=$;$=!0;const r=e();return $=t,r}function $t(e){const t=$;$=!1;const r=e();return $=t,r}let $=!0;function bt(e,t){if(t){if(le.indexOf(e)!==-1)return;le.push(e)}else{if(me.indexOf(e)!==-1)return;me.push(e)}}function ve(e){Ze++;const t=e();if(!(--Ze>0))return le.length>0&&(le.forEach(r=>{console.assert(r._isDirty===!1,"dep.dirty === false"),r._children.forEach((n,s)=>{s._parents.set(r,r._version)}),r._children.clear()}),le.length=0),me.length>0&&(me.forEach(r=>{const n=M.activeReactivity;M.activeReactivity=null,r.runIfDirty(),M.activeReactivity=n}),me.length=0),t}let Ze=0;const me=[],le=[];class Qt extends M{constructor(t){super(),G(this,"__v_isRef",!0),G(this,"_func"),G(this,"_children",new Map),G(this,"_isDirty",!0),G(this,"_version",-1),this._func=t}get value(){return this.runIfDirty(),this.track(),this._value}trigger(){M.activeReactivity===this&&bt(this,M.activeReactivity===this),super.trigger()}run(){Kt(()=>{const t=M.activeReactivity;M.activeReactivity=this,this._version++,this._value=this._func(this._value),M.activeReactivity=t})}runIfDirty(){this._isDirty=this._isDirty||this.isChildrenChanged(),this._isDirty&&(this._isDirty=!1,this.run())}isChildrenChanged(){if(this._children.size===0)return!1;let t=!1;const r=M.activeReactivity;return M.activeReactivity=null,this._children.forEach((n,s)=>{if(!t&&s.value!==n){t=!0;return}}),M.activeReactivity=r,t||this._children.forEach((n,s)=>{s._parents.set(this,this._version)}),this._children.clear(),t}}var D=(e=>(e.IS_REACTIVE="__v_isReactive",e.RAW="__v_raw",e.IS_REF="__v_isRef",e))(D||{}),Q=(e=>(e[e.INVALID=0]="INVALID",e[e.COMMON=1]="COMMON",e[e.COLLECTION=2]="COLLECTION",e))(Q||{}),O=(e=>(e.GET="get",e.HAS="has",e.ITERATE="iterate",e))(O||{}),g=(e=>(e.SET="set",e.ADD="add",e.DELETE="delete",e.CLEAR="clear",e))(g||{});const q=Symbol("Object iterate"),Ge=Symbol("Map keys iterate"),be=Symbol("Array iterate");globalThis.__DEV__??(globalThis.__DEV__=!0);const ke=e=>e!==null&&typeof e=="object",se=Array.isArray,oe=e=>typeof e=="symbol",qt=e=>typeof e=="string",Xe=e=>qt(e)&&e!=="NaN"&&e[0]!=="-"&&`${parseInt(e,10)}`===e,Ee=e=>At(e)==="[object Map]",De=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),he=(e,t)=>!Object.is(e,t);function Zt(e){switch(e){case"Object":case"Array":return Q.COMMON;case"Map":case"Set":case"WeakMap":case"WeakSet":return Q.COLLECTION;default:return Q.COMMON}}function Jt(e){return Object.isExtensible(e)?Zt(xt(e)):Q.INVALID}const At=e=>Object.prototype.toString.call(e),xt=e=>At(e).slice(8,-1);function x(e){const t=e&&e[D.RAW];return t?x(t):e}function jt(e,...t){console.warn(`[警告] ${e}`,...t)}function er(e){const t=Object.create(null);for(const r of e.split(","))t[r]=1;return r=>r in t}function ge(e){return new tr(e)}const Rt=class _e extends Qt{constructor(t){super(t),G(this,"_isEnable",!0),this.runIfDirty()}pause(){this._isEnable=!1}resume(){this._isEnable||(this._isEnable=!0,_e.pausedQueueEffects.has(this)&&(_e.pausedQueueEffects.delete(this),this.trigger()))}stop(){this._isEnable=!1,_e.pausedQueueEffects.delete(this)}trigger(){ve(()=>{super.trigger(),this._isEnable?bt(this,M.activeReactivity===this):_e.pausedQueueEffects.add(this)})}run(){this._isEnable?super.run():this._func(this._value)}};G(Rt,"pausedQueueEffects",new WeakSet);let tr=Rt;function rr(e,t){let r=S._targetMap.get(e);r||(r=new Map,S._targetMap.set(e,r));let n=r.get(t);return n||(n=new S(e,t),r.set(t,n)),n}class S extends M{constructor(t,r){super(),G(this,"_target"),G(this,"_key"),this._target=t,this._key=r,t instanceof Map||t instanceof WeakMap?this._value=t.get(r):t instanceof Set||t instanceof WeakSet?this._value=t.has(r):this._value=t[r]}get value(){return this.track(),this._value}set value(t){this._key==="length"?t=this._target.length:oe(this._key)&&(t=~~this._value+1),t!==this._value&&(this.trigger(),this._value=t)}triggerIfChanged(){}static track(t,r,n){if(!M.activeReactivity)return;rr(t,n).track()}static trigger(t,r,n,s,o){const i=this._targetMap.get(t);if(!i)return;const a=c=>{c&&(c.value=s)};ve(()=>{if(r===g.CLEAR)i.forEach(a);else{const c=se(t),u=c&&Xe(n);if(c&&n==="length"){const f=Number(s);i.forEach((_,d)=>{(d==="length"||d===be||!oe(d)&&d>=f)&&a(_)})}else switch((n!==void 0||i.has(void 0))&&a(i.get(n)),u&&a(i.get(be)),r){case g.ADD:c?u&&a(i.get("length")):(a(i.get(q)),Ee(t)&&a(i.get(Ge)));break;case g.DELETE:c||(a(i.get(q)),Ee(t)&&a(i.get(Ge)));break;case g.SET:Ee(t)&&a(i.get(q));break}}})}}G(S,"_targetMap",new WeakMap);const nr={__proto__:null,[Symbol.iterator](){return Pe(this,Symbol.iterator,B)},concat(...e){return j(this).concat(...e.map(t=>se(t)?j(t):t))},entries(){return Pe(this,"entries",e=>(e[1]=B(e[1]),e))},every(e,t){return W(this,"every",e,t,void 0,arguments)},filter(e,t){return W(this,"filter",e,t,r=>r.map(B),arguments)},find(e,t){return W(this,"find",e,t,B,arguments)},findIndex(e,t){return W(this,"findIndex",e,t,void 0,arguments)},findLast(e,t){return W(this,"findLast",e,t,B,arguments)},findLastIndex(e,t){return W(this,"findLastIndex",e,t,void 0,arguments)},forEach(e,t){return W(this,"forEach",e,t,void 0,arguments)},includes(...e){return Ue(this,"includes",e)},indexOf(...e){return Ue(this,"indexOf",e)},join(e){return j(this).join(e)},lastIndexOf(...e){return Ue(this,"lastIndexOf",e)},map(e,t){return W(this,"map",e,t,void 0,arguments)},pop(){return fe(this,"pop")},push(...e){return fe(this,"push",e)},reduce(e,...t){return Je(this,"reduce",e,t)},reduceRight(e,...t){return Je(this,"reduceRight",e,t)},shift(){return fe(this,"shift")},some(e,t){return W(this,"some",e,t,void 0,arguments)},splice(...e){return fe(this,"splice",e)},toReversed(){return j(this).toReversed()},toSorted(e){return j(this).toSorted(e)},toSpliced(...e){return j(this).toSpliced(...e)},unshift(...e){return fe(this,"unshift",e)},values(){return Pe(this,"values",B)}};function Pe(e,t,r){const n=Ye(e),s=n[t]();return n!==e&&(s._next=s.next,s.next=()=>{const o=s._next();return o.value&&(o.value=r(o.value)),o}),s}function Ye(e){return S.track(e=x(e),O.ITERATE,be),e}function j(e){const t=x(e);return t===e?t:(S.track(t,O.ITERATE,be),t.map(B))}function W(e,t,r,n,s,o){const i=Ye(e),a=i!==e,c=i[t];if(c!==Array.prototype[t]){const _=c.apply(e,o);return a?B(_):_}let u=r;i!==e&&(a?u=function(_,d){return r.call(this,B(_),d,e)}:r.length>2&&(u=function(_,d){return r.call(this,_,d,e)}));const f=c.call(i,u,n);return a&&s?s(f):f}function Je(e,t,r,n){const s=Ye(e);let o=r;return s!==e&&(o=function(i,a,c){return r.call(this,i,B(a),c,e)}),s[t](o,...n)}function Ue(e,t,r){const n=x(e);S.track(n,O.ITERATE,be);const s=n[t](...r);return(s===-1||s===!1)&&mr(r[0])?(r[0]=x(r[0]),n[t](...r)):s}function fe(e,t,r=[]){return ve(()=>$t(()=>x(e)[t].apply(e,r)))}function Te(e){return e?e[D.IS_REF]===!0:!1}class Dn extends(qe=M,Qe=D.IS_REF,qe){constructor(t){super(),G(this,Qe,!0),G(this,"_rawValue"),this._rawValue=x(t),this._value=B(t)}get value(){return this.track(),this._value}set value(t){const r=this._rawValue,n=x(t);he(r,n)&&ve(()=>{this.trigger(),this._rawValue=n,this._value=B(n)})}}class sr{get(t,r,n){if(r===D.IS_REACTIVE)return!0;if(r===D.RAW)return n===ze.get(t)||Object.getPrototypeOf(t)===Object.getPrototypeOf(n)?t:void 0;const s=se(t);let o;if(s&&(o=nr[r]))return o;if(r==="hasOwnProperty")return ar;const i=Reflect.get(t,r,Te(t)?t:n);return(oe(r)?yt.has(r):cr(r))?i:(S.track(t,O.GET,r),Te(i)?s&&Xe(r)?i:i.value:ke(i)?K(i):i)}}class ir extends sr{set(t,r,n,s){let o=t[r];if(o=x(o),n=x(n),!se(t)&&Te(o)&&!Te(n))return o.value=n,!0;const i=se(t)&&Xe(r)?Number(r)<t.length:De(t,r),a=Reflect.set(t,r,n,Te(t)?t:s);return console.assert(t===x(s)),t===x(s)&&(i?he(n,o)&&S.trigger(t,g.SET,r,n,o):S.trigger(t,g.ADD,r,n)),a}deleteProperty(t,r){const n=De(t,r),s=t[r],o=Reflect.deleteProperty(t,r);return o&&n&&S.trigger(t,g.DELETE,r,void 0,s),o}has(t,r){const n=Reflect.has(t,r);return(!oe(r)||!yt.has(r))&&S.track(t,O.HAS,r),n}ownKeys(t){return S.track(t,O.ITERATE,se(t)?"length":q),Reflect.ownKeys(t)}}const or=new ir;function ar(e){oe(e)||(e=String(e));const t=x(this);return S.track(t,O.HAS,e),t.hasOwnProperty(e)}const yt=new Set(Object.getOwnPropertyNames(Symbol).filter(e=>e!=="arguments"&&e!=="caller").map(e=>Symbol[e]).filter(oe)),cr=er("__proto__,__v_isRef,__isVue"),ur={get:fr()};function fr(){const e=dr();return(t,r,n)=>r===D.IS_REACTIVE?!0:r===D.RAW?t:Reflect.get(De(e,r)&&r in t?e:t,r,n)}function dr(){const e={get(r){const n=this[D.RAW],s=x(n),o=x(r);he(r,o)&&S.track(s,O.GET,r),S.track(s,O.GET,o);const{has:i}=Re(s),a=B;if(i.call(s,r))return a(n.get(r));if(i.call(s,o))return a(n.get(o));n!==s&&n.get(r)},get size(){const r=this[D.RAW];return S.track(x(r),O.ITERATE,q),Reflect.get(r,"size",r)},has(r){const n=this[D.RAW],s=x(n),o=x(r);return he(r,o)&&S.track(s,O.HAS,r),S.track(s,O.HAS,o),r===o?n.has(r):n.has(r)||n.has(o)},forEach(r,n){const s=this,o=s[D.RAW],i=x(o),a=B;return S.track(i,O.ITERATE,q),o.forEach((c,u)=>r.call(n,a(c),a(u),s))},add(r){r=x(r);const n=x(this);return Re(n).has.call(n,r)||(n.add(r),S.trigger(n,g.ADD,r,r)),this},set(r,n){n=x(n);const s=x(this),{has:o,get:i}=Re(s);let a=o.call(s,r);a?je(s,o,r):(r=x(r),a=o.call(s,r));const c=i.call(s,r);return s.set(r,n),a?he(n,c)&&S.trigger(s,g.SET,r,n,c):S.trigger(s,g.ADD,r,n),this},delete(r){const n=x(this),{has:s,get:o}=Re(n);let i=s.call(n,r);i?je(n,s,r):(r=x(r),i=s.call(n,r));const a=o?o.call(n,r):void 0,c=n.delete(r);return i&&S.trigger(n,g.DELETE,r,void 0,a),c},clear(){const r=x(this),n=r.size!==0,s=Ee(r)?new Map(r):new Set(r),o=r.clear();return n&&S.trigger(r,g.CLEAR,void 0,void 0,s),o}};return["keys","values","entries",Symbol.iterator].forEach(r=>{e[r]=_r(r)}),e}function _r(e){return function(...t){const r=this[D.RAW],n=x(r),s=Ee(n),o=e==="entries"||e===Symbol.iterator&&s,i=e==="keys"&&s,a=r[e](...t),c=B;return S.track(n,O.ITERATE,i?Ge:q),{next(){const{value:u,done:f}=a.next();return f?{value:u,done:f}:{value:o?[c(u[0]),c(u[1])]:c(u),done:f}},[Symbol.iterator](){return this}}}}function je(e,t,r){const n=x(r);if(n!==r&&t.call(e,n)){const s=xt(e);jt(`响应式 ${s} 同时包含同一对象的原始版本和响应式版本${s==="Map"?"作为键":""}，这可能导致不一致。建议仅使用响应式版本。`)}}const Re=e=>Reflect.getPrototypeOf(e);function K(e){if(!ke(e)||e[D.RAW])return e;const t=Jt(e);if(t===Q.INVALID)return e;const r=ze.get(e);if(r)return r;const n=new Proxy(e,t===Q.COLLECTION?ur:or);return ze.set(e,n),n}const ze=new WeakMap,B=e=>ke(e)?K(e):e;function mr(e){return e?!!e[D.RAW]:!1}console.log("@feng3d/reactivity v1.0.12");function ae(e,t,r,n="STATIC_DRAW"){let s=e._bufferMap.get(t);if(s)return s;s=e.createBuffer(),e._bufferMap.set(t,s);const o=t.size;e.bindBuffer(e[r],s),e.bufferData(e[r],o,e[n]);const i=u=>{const f=u.bufferOffset??0;let _=u.data;u.size&&(_=new Uint8Array(_.buffer,_.byteOffset,u.size*_.BYTES_PER_ELEMENT)),e.bufferSubData(e[r],f,_)},a=K(t),c=[];return c.push(ge(()=>{a.data,t.data&&(e.bindBuffer(e[r],s),i({data:new Uint8Array(t.data)}))})),c.push(ge(()=>{var f;(f=a.writeBuffers)==null||f.forEach(()=>{});const u=t.writeBuffers;u&&(e.bindBuffer(e[r],s),u.forEach(i),K(t).writeBuffers=null)})),s.destroy=()=>{c.forEach(u=>u.stop())},s}function lr(e,t){const r=e._bufferMap.get(t);r&&(e._bufferMap.delete(t),r.destroy(),delete r.destroy,e.deleteBuffer(r))}class Er{constructor(t,r="highp"){w(this,"_maxAnisotropy");w(this,"_maxTextures");w(this,"_maxVertexTextures");w(this,"_maxTextureSize");w(this,"_maxCubemapSize");w(this,"_maxAttributes");w(this,"_maxVertexUniforms");w(this,"_maxVaryings");w(this,"_maxFragmentUniforms");w(this,"_vertexTextures");w(this,"_floatFragmentTextures");w(this,"_floatVertexTextures");w(this,"_maxPrecision");w(this,"_maxSamples");w(this,"_stencilBits");w(this,"_vaoAvailable");this._gl=t,this._precision=r}get maxAnisotropy(){return this._maxAnisotropy?this._maxAnisotropy:(this._maxAnisotropy=this._gl.getExtension("EXT_texture_filter_anisotropic")?this._gl.getParameter(this._gl.getExtension("EXT_texture_filter_anisotropic").MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._maxAnisotropy)}get maxTextures(){return this._maxTextures?this._maxTextures:(this._maxTextures=this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),this._maxTextures)}get maxVertexTextures(){return this._maxVertexTextures?this._maxVertexTextures:(this._maxVertexTextures=this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxVertexTextures)}get maxTextureSize(){return this._maxTextureSize?this._maxTextureSize:(this._maxTextureSize=this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),this._maxTextureSize)}get maxCubemapSize(){return this._maxCubemapSize?this._maxCubemapSize:(this._maxCubemapSize=this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),this._maxCubemapSize)}get maxAttributes(){return this._maxAttributes?this._maxAttributes:(this._maxAttributes=this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),this._maxAttributes)}get maxVertexUniforms(){return this._maxVertexUniforms?this._maxVertexUniforms:(this._maxVertexUniforms=this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),this._maxVertexUniforms)}get maxVaryings(){return this._maxVaryings?this._maxVaryings:(this._maxVaryings=this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),this._maxVaryings)}get maxFragmentUniforms(){return this._maxFragmentUniforms?this._maxFragmentUniforms:(this._maxFragmentUniforms=this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxFragmentUniforms)}get vertexTextures(){return this._vertexTextures?this._vertexTextures:(this._vertexTextures=this.maxVertexTextures>0,this._vertexTextures)}get floatFragmentTextures(){return this._floatFragmentTextures?this._floatFragmentTextures:(this._floatFragmentTextures=this._gl instanceof WebGL2RenderingContext||!!this._gl.getExtension("OES_texture_float"),this._floatFragmentTextures)}get floatVertexTextures(){return this._floatVertexTextures?this._floatVertexTextures:(this._floatVertexTextures=this.vertexTextures&&this.floatFragmentTextures,this._floatVertexTextures)}get maxPrecision(){return this._maxPrecision?this._maxPrecision:(this._maxPrecision=hr(this._gl,this._precision),this._maxPrecision)}get maxSamples(){return this._maxSamples?this._maxSamples:(this._maxSamples=this._gl instanceof WebGL2RenderingContext?this._gl.getParameter(this._gl.MAX_SAMPLES):0,this._maxSamples)}get stencilBits(){return this._stencilBits?this._stencilBits:(this._stencilBits=this._gl.getParameter(this._gl.STENCIL_BITS),this._stencilBits)}get vaoAvailable(){return this._vaoAvailable?this._vaoAvailable:(this._vaoAvailable=this._gl instanceof WebGL2RenderingContext||!!this._gl.getExtension("OES_vertex_array_object"),this._vaoAvailable)}}function hr(e,t="highp"){if(t==="highp"){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return t==="mediump"&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}function Tr(e){let t=e._gl;if(t)return t;const r=typeof e.canvasId=="string"?document.getElementById(e.canvasId):e.canvasId;return t=e._gl=xr(r,e),e.webGLContextAttributes,t._capabilities=new Er(t),t._bufferMap=new WeakMap,t._textures=new WeakMap,t._renderbuffers=new WeakMap,t._framebuffers=new WeakMap,t._vertexArrays=new Wt,t._samplers=new WeakMap,t._transforms=new WeakMap,t._programs={},t._shaders={},r.addEventListener("webglcontextlost",pr,!1),r.addEventListener("webglcontextrestored",br,!1),r.addEventListener("webglcontextcreationerror",Ar,!1),t}function pr(e){e.preventDefault(),console.warn("WebGLRenderer: Context Lost.")}function br(){console.warn("WebGLRenderer: Context Restored.")}function Ar(e){console.error("WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function xr(e,t){const r=Object.assign({},Xt,t.webGLContextAttributes);let n=e.getContext(t.webGLcontextId||"webgl2",r);return n||console.warn("无法使用用户提供参数获取指定WebGL上下文",r),n=e.getContext("webgl2",r)||e.getContext("webgl2")||e.getContext("webgl",r)||e.getContext("webgl"),n||console.error("无法获取WebGL上下文。"),n}function Rr(e,t,r){let n=e._renderbuffers.get(t);if(n)return n;n=e.createRenderbuffer(),e._renderbuffers.set(t,n);const{internalformat:s,width:o,height:i}=t;return e.bindRenderbuffer(e.RENDERBUFFER,n),r===4&&e instanceof WebGL2RenderingContext?e.renderbufferStorageMultisample(e.RENDERBUFFER,r,e[s],o,i):e.renderbufferStorage(e.RENDERBUFFER,e[s],o,i),n}function St(e,t){const r=e._renderbuffers.get(t);e._renderbuffers.delete(t),e.deleteRenderbuffer(r)}function ie(e="rgba8unorm"){const t=yr[e];return console.assert(!!t,`未处理格式 ${e}；或者WebGL不支持纹理， 该格式只在WebGPU中支持！`),t}const yr={r8unorm:{internalformat:"R8",format:"RED",type:"UNSIGNED_BYTE"},r8snorm:void 0,r8uint:{internalformat:"R8",format:"RED",type:"UNSIGNED_BYTE"},r8sint:void 0,r16uint:void 0,r16sint:void 0,r16float:{internalformat:"R16F",format:"RED",type:"HALF_FLOAT"},rg8unorm:{internalformat:"RG8",format:"RG",type:"UNSIGNED_BYTE"},rg8snorm:void 0,rg8uint:{internalformat:"RG8UI",format:"RG_INTEGER",type:"UNSIGNED_BYTE"},rg8sint:void 0,r32uint:void 0,r32sint:void 0,r32float:{internalformat:"R32F",format:"RED",type:"FLOAT"},rg16uint:void 0,rg16sint:void 0,rg16float:{internalformat:"RG16F",format:"RG",type:"HALF_FLOAT"},rgba8unorm:{internalformat:"RGBA8",format:"RGBA",type:"UNSIGNED_BYTE"},"rgba8unorm-srgb":{internalformat:"SRGB8_ALPHA8",format:"RGBA",type:"UNSIGNED_BYTE"},rgba8snorm:void 0,rgba8uint:{internalformat:"RGBA8UI",format:"RGBA_INTEGER",type:"UNSIGNED_BYTE"},rgba8sint:void 0,bgra8unorm:{internalformat:"RGBA8",format:"RGBA",type:"UNSIGNED_BYTE"},"bgra8unorm-srgb":void 0,rgb9e5ufloat:{internalformat:"RGB9_E5",format:"RGB",type:"HALF_FLOAT"},rgb10a2uint:void 0,rgb10a2unorm:{internalformat:"RGB10_A2",format:"RGBA",type:"UNSIGNED_INT_2_10_10_10_REV"},rg11b10ufloat:{internalformat:"R11F_G11F_B10F",format:"RGB",type:"UNSIGNED_INT_10F_11F_11F_REV"},rg32uint:void 0,rg32sint:void 0,rg32float:{internalformat:"RG32F",format:"RG",type:"FLOAT"},rgba16uint:void 0,rgba16sint:void 0,rgba16float:{internalformat:"RGBA16F",format:"RGBA",type:"HALF_FLOAT"},rgba32uint:void 0,rgba32sint:void 0,rgba32float:{internalformat:"RGBA32F",format:"RGBA",type:"FLOAT"},stencil8:void 0,depth16unorm:{internalformat:"DEPTH_COMPONENT16",format:"DEPTH_COMPONENT",type:"UNSIGNED_SHORT"},depth24plus:void 0,"depth24plus-stencil8":void 0,depth32float:void 0,"depth32float-stencil8":void 0,"bc1-rgba-unorm":void 0,"bc1-rgba-unorm-srgb":void 0,"bc2-rgba-unorm":void 0,"bc2-rgba-unorm-srgb":void 0,"bc3-rgba-unorm":void 0,"bc3-rgba-unorm-srgb":void 0,"bc4-r-unorm":void 0,"bc4-r-snorm":void 0,"bc5-rg-unorm":void 0,"bc5-rg-snorm":void 0,"bc6h-rgb-ufloat":void 0,"bc6h-rgb-float":void 0,"bc7-rgba-unorm":void 0,"bc7-rgba-unorm-srgb":void 0,"etc2-rgb8unorm":void 0,"etc2-rgb8unorm-srgb":void 0,"etc2-rgb8a1unorm":void 0,"etc2-rgb8a1unorm-srgb":void 0,"etc2-rgba8unorm":void 0,"etc2-rgba8unorm-srgb":void 0,"eac-r11unorm":void 0,"eac-r11snorm":void 0,"eac-rg11unorm":void 0,"eac-rg11snorm":void 0,"astc-4x4-unorm":void 0,"astc-4x4-unorm-srgb":void 0,"astc-5x4-unorm":void 0,"astc-5x4-unorm-srgb":void 0,"astc-5x5-unorm":void 0,"astc-5x5-unorm-srgb":void 0,"astc-6x5-unorm":void 0,"astc-6x5-unorm-srgb":void 0,"astc-6x6-unorm":void 0,"astc-6x6-unorm-srgb":void 0,"astc-8x5-unorm":void 0,"astc-8x5-unorm-srgb":void 0,"astc-8x6-unorm":void 0,"astc-8x6-unorm-srgb":void 0,"astc-8x8-unorm":void 0,"astc-8x8-unorm-srgb":void 0,"astc-10x5-unorm":void 0,"astc-10x5-unorm-srgb":void 0,"astc-10x6-unorm":void 0,"astc-10x6-unorm-srgb":void 0,"astc-10x8-unorm":void 0,"astc-10x8-unorm-srgb":void 0,"astc-10x10-unorm":void 0,"astc-10x10-unorm-srgb":void 0,"astc-12x10-unorm":void 0,"astc-12x10-unorm-srgb":void 0,"astc-12x12-unorm":void 0,"astc-12x12-unorm-srgb":void 0};function Sr(e){if(e[ne])return e[ne];const r=e.colorAttachments[0].view.texture.descriptor.size,n=[],s={colorAttachments:e.colorAttachments.map(i=>{const a=i.view.texture,c={internalformat:Cr(a.descriptor.format),width:r[0],height:r[1]};return n.push(c),{...i,view:c}}),depthStencilAttachment:e.depthStencilAttachment,sampleCount:e.sampleCount},o={__type__:"BlitFramebuffer",read:s,draw:e,blitFramebuffers:[[0,0,r[0],r[1],0,0,r[0],r[1],"COLOR_BUFFER_BIT","NEAREST"]]};return e[ne]={passDescriptor:s,blitFramebuffer:o,renderbuffers:n},e[ne]}function Cr(e){const{internalformat:t}=ie(e);return t}const ne="_IGLRenderPassDescriptorWithMultisample";class Fr{constructor(){this._binds=[]}on(){const t=[],r={watch:(n,s,o,i,a=!0,c,u)=>(this.watch(n,s,o,i,a,c,u),t.push(()=>this.unwatch(n,s,o,i)),r),watchs:(n,s,o,i,a)=>(this.watchs(n,s,o,i,a),t.push(()=>this.unwatchs(n,s,o,i)),r),bind:(n,s,o,i)=>(this.bind(n,s,o,i),t.push(()=>this.unbind(n,s,o,i)),r),watchchain:(n,s,o,i,a=!0,c,u)=>(this.watchchain(n,s,o,i,a,c,u),t.push(()=>this.unwatchchain(n,s,o,i)),r),watchobject:(n,s,o,i,a=!0)=>(this.watchobject(n,s,o,i,a),t.push(()=>this.unwatchobject(n,s,o,i)),r),off:()=>{t.forEach(n=>n()),t.length=0}};return r}watch(t,r,n,s,o=!0,i,a){i=i||t,a=a||r,Object.getOwnPropertyDescriptor(t,k)||Object.defineProperty(t,k,{value:{},enumerable:!1,configurable:!0,writable:!1});const c=r,u=t[k];if(!u[c]){const d=Object.getOwnPropertyDescriptor(t,c);u[c]={value:t[c],oldPropertyDescriptor:d,handlers:[]};let m=Ct(t,c);if(m&&m.set&&m.get){m={enumerable:m.enumerable,configurable:!0,get:m.get,set:m.set};const l=m.set;m.set=function(E){const h=this[c];l&&l.call(this,E),et(E,h,this,c,i,a)}}else if(!m||!m.get&&!m.set)m={enumerable:!0,configurable:!0},m.get=function(){return this[k][c].value},m.set=function(l){const E=this[k][c].value;this[k][c].value=l,et(l,E,this,c,i,a)};else{console.warn("无法修改监听属性的描述，监听失败！",t,c,n,s);return}Object.defineProperty(t,c,m)}const f=u[c];f.handlers.reduce((d,m)=>d||m.handler===n&&m.thisObject===s,!1)?console.warn("重复监听， 监听失败！",t,c,n,s):f.handlers.push({handler:n,thisObject:s,onlyChanged:o})}unwatch(t,r,n,s){const o=t[k];if(!o)return;const i=r;if(o[i]){const a=o[i].handlers;n===void 0&&(a.length=0);for(let c=a.length-1;c>=0;c--)a[c].handler===n&&(a[c].thisObject===s||s===void 0)&&a.splice(c,1);if(a.length===0){const c=t[i];delete t[i],o[i].oldPropertyDescriptor&&Object.defineProperty(t,i,o[i].oldPropertyDescriptor),t[i]=c,delete o[i]}Object.keys(o).length===0&&delete t[k]}}watchs(t,r,n,s,o=!0){r.forEach(i=>{this.watch(t,i,n,s,o)})}unwatchs(t,r,n,s){r.forEach(o=>{this.unwatch(t,o,n,s)})}bind(t,r,n,s){const o=()=>{n[s]=t[r]},i=()=>{t[r]=n[s]};this.watch(t,r,o),this.watch(n,s,i),this._binds.push([t,r,o,n,s,i])}unbind(t,r,n,s){const o=this._binds;for(let i=o.length-1;i>=0;i--){const a=o[i];if((a[1]===r&&a[4]===s||a[1]===s&&a[4]===r)&&(a[0]===t&&a[3]===n||a[0]===n&&a[3]===t)){this.unwatch(a[0],a[1],a[2]),this.unwatch(a[3],a[4],a[5]),o.splice(i,1);break}}}watchchain(t,r,n,s,o=!0,i,a){i=i||t,a=a||r;const c=r.indexOf(".");if(c===-1){this.watch(t,r,n,s,o,i,a);return}Object.getOwnPropertyDescriptor(t,de)||Object.defineProperty(t,de,{value:{},enumerable:!1,writable:!1,configurable:!0});const u=t[de];u[r]||(u[r]=[]);const f=u[r];if(!f.reduce((d,m)=>d||m.handler===n&&m.thisObject===s,!1)){const d=r.substr(0,c),m=r.substr(c+1);t[d]&&this.watchchain(t[d],m,n,s,o,i,a);const l=(E,h)=>{h&&this.unwatchchain(h,m,n,s),E&&this.watchchain(E,m,n,s,o,i,a);const T=tt(h,m),R=tt(E,m);(!o||T!==R)&&n.call(s,R,T,i,a)};this.watch(t,d,l,void 0,o),f.push({handler:n,thisObject:s,watchchainFun:l})}}unwatchchain(t,r,n,s){const o=r.indexOf(".");if(o===-1){this.unwatch(t,r,n,s);return}const i=r.substr(0,o),a=r.substr(o+1),c=t[de];if(!c||!c[r])return;const u=c[r];for(let f=u.length-1;f>=0;f--){const _=u[f];(He(n)||n===_.handler&&s===_.thisObject)&&(t[i]&&this.unwatchchain(t[i],a,_.handler,_.thisObject),this.unwatch(t,i,_.watchchainFun),u.splice(f,1))}u.length===0&&delete c[r],Object.keys(c).length===0&&delete t[de]}watchobject(t,r,n,s,o=!0){rt(r).forEach(a=>{this.watchchain(t,a,n,s,o)})}unwatchobject(t,r,n,s){rt(r).forEach(i=>{this.unwatchchain(t,i,n,s)})}}const X=new Fr,k="__watchs__",de="__watchchains__";function et(e,t,r,n,s,o){s=s||r,o=o||n,r[k][n].handlers.concat().forEach(c=>{(!c.onlyChanged||e!==t)&&c.handler.call(c.thisObject,e,t,s,o)})}function Ct(e,t){const r=Object.getOwnPropertyDescriptor(e,t);if(r)return r;const n=Object.getPrototypeOf(e);if(n)return Ct(n,t)}function He(e){return e==null}function tt(e,t){typeof t=="string"&&(t=t.split("."));let r=e;for(let n=0;n<t.length;n++){if(He(r))return;r=r[t[n]]}return r}function rt(e){const t=[],r=Object.keys(e),n=new Array(r.length).fill(e),s=new Array(r.length).fill(-1);let o=0;for(;o<r.length;){const i=n[o],a=r[o],c=i[a];let u;if(He(c)||vr(c)||(u=Object.keys(c)).length===0){const f=[a];let _=o;for(;(_=s[_])!==-1;)f.push(r[_]);f.reverse(),t.push(f.join("."))}else u.forEach(f=>{r.push(f),n.push(c),s.push(o)});o++}return t}function vr(e){return e==null||typeof e=="boolean"||typeof e=="string"||typeof e=="number"}function Ae(e="2d"){const t=Lr[e];return console.assert(!!t,`WebGL 不支持纹理维度 ${e} , 该维度只在WebGPU中支持！`),t}const Lr={"1d":void 0,"2d":"TEXTURE_2D","2d-array":"TEXTURE_2D_ARRAY",cube:"TEXTURE_CUBE_MAP","cube-array":void 0,"3d":"TEXTURE_3D"},Ir={packAlignment:4,unpackAlignment:4,unpackFlipY:!1,unpackPremulAlpha:!1,unpackColorSpaceConversion:"BROWSER_DEFAULT_WEBGL",packRowLength:0,packSkipPixels:0,packSkipRows:0,unpackRowLength:0,unpackImageHeight:0,unpackSkipPixels:0,unpackSkipRows:0,unpackSkipImages:0};function Ve(e,t){let r=e._textures.get(t);if(r)return r;(()=>{const c=t.descriptor,u=Ae(c.dimension),{internalformat:f,format:_,type:d}=ie(c.format);r=e.createTexture(),e._textures.set(t,r),e.bindTexture(e[u],r);const{sources:m}=t,l=c.generateMipmap,[E,h,T]=c.size,R=c.mipLevelCount||1;if(m)m.forEach(y=>{const{textureOrigin:b,size:C}=y,N=y.mipLevel??0,P=C==null?void 0:C[0],z=C==null?void 0:C[1];C==null||C[2],b==null||b[0],b==null||b[1];const V=b==null?void 0:b[2];if(e instanceof WebGL2RenderingContext){const U=y;if(U.image){const{image:I,imageOrigin:v,flipY:A,premultipliedAlpha:p}=U,F={};if(F.unpackSkipPixels=(v==null?void 0:v[0])||0,F.unpackSkipRows=(v==null?void 0:v[1])||0,F.unpackFlipY=A||!1,F.unpackPremulAlpha=p||!1,ee(e,F),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const L=u==="TEXTURE_CUBE_MAP"?Y(V):u;P&&z?e.texImage2D(e[L],N,e[f],P,z,0,e[_],e[d],I):e.texImage2D(e[L],N,e[f],e[_],e[d],I)}else u==="TEXTURE_3D"||u==="TEXTURE_2D_ARRAY"?e.texImage3D(e[u],N,e[f],P,z,T,0,e[_],e[d],I):console.error(`未处理 ${u} 纹理初始化存储！`)}else{const I=y,{data:v,dataLayout:A,dataImageOrigin:p}=I,F=(A==null?void 0:A.offset)||0,L={};if(L.unpackSkipPixels=(p==null?void 0:p[0])||0,L.unpackSkipRows=(p==null?void 0:p[1])||0,L.unpackSkipImages=(p==null?void 0:p[2])||0,L.unpackRowLength=A==null?void 0:A.width,L.unpackImageHeight=A==null?void 0:A.height,ee(e,L),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const ce=u==="TEXTURE_CUBE_MAP"?Y(V):u;e.texImage2D(e[ce],N,e[f],P,z,0,e[_],e[d],v,F)}else u==="TEXTURE_3D"||u==="TEXTURE_2D_ARRAY"?e.texImage3D(e[u],N,e[f],P,z,T,0,e[_],e[d],v,F):console.error(`未处理 ${u} 纹理初始化存储！`)}}else{const U=y;if(U.image){const{image:I,imageOrigin:v,flipY:A,premultipliedAlpha:p}=U,F={};if(F.unpackSkipPixels=(v==null?void 0:v[0])||0,F.unpackSkipRows=(v==null?void 0:v[1])||0,F.unpackFlipY=A||!1,F.unpackPremulAlpha=p||!1,ee(e,F),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const L=u==="TEXTURE_CUBE_MAP"?Y(V):u;e.texImage2D(e[L],N,e[_],e[_],e[d],I)}else console.error(`未处理 ${u} 纹理初始化存储！`)}else{const I=y,{data:v,dataLayout:A,dataImageOrigin:p}=I,F=(A==null?void 0:A.offset)||0,L={};if(L.unpackSkipPixels=(p==null?void 0:p[0])||0,L.unpackSkipRows=(p==null?void 0:p[1])||0,L.unpackSkipImages=(p==null?void 0:p[2])||0,L.unpackRowLength=A==null?void 0:A.width,L.unpackImageHeight=A==null?void 0:A.height,ee(e,L),u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"){const ce=u==="TEXTURE_CUBE_MAP"?Y(V):u;console.assert(F===0,"WebGL1中ITextureDataLayout.offset必须为0"),e.texImage2D(e[ce],N,e[_],P,z,0,e[_],e[d],v)}else console.error(`未处理 ${u} 纹理初始化存储！`)}}}),l&&e.generateMipmap(e[u]);else if(e instanceof WebGL2RenderingContext)u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP"?e.texStorage2D(e[u],R,e[f],E,h):u==="TEXTURE_3D"||u==="TEXTURE_2D_ARRAY"?e.texStorage3D(e[u],R,e[f],E,h,T):console.error(`未处理 ${u} 纹理初始化存储！`);else if(u==="TEXTURE_2D"||u==="TEXTURE_CUBE_MAP")for(let y=0;y<R;y++)e.texImage2D(e[u],y,e[_],E,h,0,e[_],e[d],null);else console.error(`未处理 ${u} 纹理初始化存储！`)})();const s=()=>{r.destroy()};X.watch(t,"sources",s);const o=()=>{const{writeTextures:c}=t;if(!c||c.length===0)return;const u=t.descriptor,f=Ae(u.dimension),{format:_,type:d}=ie(u.format);e.bindTexture(e[f],r),c.forEach(m=>{const{mipLevel:l,textureOrigin:E,size:h}=m,T=h==null?void 0:h[0],R=h==null?void 0:h[1],y=h==null?void 0:h[2],b=E==null?void 0:E[0],C=E==null?void 0:E[1],N=E==null?void 0:E[2],P=m;if(P.image){const{image:p,imageOrigin:F,flipY:L,premultipliedAlpha:ce}=P,ue={};if(ue.unpackSkipPixels=(F==null?void 0:F[0])||0,ue.unpackSkipRows=(F==null?void 0:F[1])||0,ue.unpackFlipY=L||!1,ue.unpackPremulAlpha=ce||!1,ee(e,ue),e instanceof WebGL2RenderingContext)if(f==="TEXTURE_2D"||f==="TEXTURE_CUBE_MAP"){const xe=f==="TEXTURE_CUBE_MAP"?Y(y):f;T&&R?e.texSubImage2D(e[xe],l,b,C,T,R,e[_],e[d],p):e.texSubImage2D(e[xe],l,b,C,e[_],e[d],p)}else f==="TEXTURE_3D"||f==="TEXTURE_2D_ARRAY"?e.texSubImage3D(e[f],l,b,C,N,T,R,y,e[_],e[d],p):console.error(`未处理 WebGL1 中 ${f} 纹理类型的图片资源上传！`);else if(f==="TEXTURE_2D"||f==="TEXTURE_CUBE_MAP"){const xe=f==="TEXTURE_CUBE_MAP"?Y(y):f;e.texSubImage2D(e[xe],l,b,C,e[_],e[d],p)}else console.error(`WebGL1 中 不支持 ${f} 纹理类型！`);return}const z=m,{data:V,dataLayout:U,dataImageOrigin:I}=z,v=(U==null?void 0:U.offset)||0,A={};if(A.unpackSkipPixels=(I==null?void 0:I[0])||0,A.unpackSkipRows=(I==null?void 0:I[1])||0,A.unpackSkipImages=(I==null?void 0:I[2])||0,A.unpackRowLength=U==null?void 0:U.width,A.unpackImageHeight=U==null?void 0:U.height,ee(e,A),e instanceof WebGL2RenderingContext)if(f==="TEXTURE_2D"||f==="TEXTURE_CUBE_MAP"){const p=f==="TEXTURE_CUBE_MAP"?Y(y):f;e.texSubImage2D(e[p],l,b,C,T,R,e[_],e[d],V,v)}else f==="TEXTURE_3D"||f==="TEXTURE_2D_ARRAY"?e.texSubImage3D(e[f],l,b,C,N,T,R,y,e[_],e[d],V,v):console.error(`未处理 WebGL1 中 ${f} 纹理类型的像素资源上传。`);else if(f==="TEXTURE_2D"||f==="TEXTURE_CUBE_MAP"){const p=f==="TEXTURE_CUBE_MAP"?Y(y):f;e.texSubImage2D(e[p],l,b,C,T,R,e[_],e[d],V),console.assert(!v,"WebGL1 不支持 IGLTextureDataSource.dataLayout.offset ！")}else console.error(`WebGL1 中 不支持 ${f} 纹理类型！`)})};o();const i=t.descriptor;X.watchs(i,["generateMipmap"],o),X.watch(t,"writeTextures",o);const a=(c,u)=>{c&&u&&c[0]===u[0]&&c[1]===u[1]&&(c[2]||1)===(u[2]||1)||r.destroy()};return X.watch(i,"size",a),r.destroy=()=>{e.deleteTexture(r),e._textures.delete(t),X.unwatchs(i,["generateMipmap"],o),X.unwatch(t,"sources",s),X.unwatch(t,"writeTextures",o),X.unwatch(i,"size",a),delete r.destroy},r}function wr(e,t){const r=e._textures.get(t);r&&r.destroy()}function ee(e,t){const{packAlignment:r,unpackAlignment:n,unpackFlipY:s,unpackPremulAlpha:o,unpackColorSpaceConversion:i,packRowLength:a,packSkipPixels:c,packSkipRows:u,unpackRowLength:f,unpackImageHeight:_,unpackSkipPixels:d,unpackSkipRows:m,unpackSkipImages:l}={...Ir,...t};e.pixelStorei(e.PACK_ALIGNMENT,r),e.pixelStorei(e.UNPACK_ALIGNMENT,n),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,s),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e[i]),e instanceof WebGL2RenderingContext&&(e.pixelStorei(e.PACK_ROW_LENGTH,a),e.pixelStorei(e.PACK_SKIP_PIXELS,c),e.pixelStorei(e.PACK_SKIP_ROWS,u),e.pixelStorei(e.UNPACK_ROW_LENGTH,f),e.pixelStorei(e.UNPACK_IMAGE_HEIGHT,_),e.pixelStorei(e.UNPACK_SKIP_PIXELS,d),e.pixelStorei(e.UNPACK_SKIP_ROWS,m),e.pixelStorei(e.UNPACK_SKIP_IMAGES,l))}function Y(e){const t=Pr[e];return console.assert(!!t,"CubeMap的depthOrArrayLayers值应在[0-5]之间！"),t}const Pr=["TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_CUBE_MAP_NEGATIVE_Z"];function Ce(e,t){var a,c,u,f,_;const r=((c=(a=t==null?void 0:t.colorAttachments)==null?void 0:a[0])==null?void 0:c.view)||((u=t==null?void 0:t.depthStencilAttachment)==null?void 0:u.view);if(!r||"texture"in r&&"context"in r.texture)return null;let n=e._framebuffers.get(t);if(n)return n;const s=t.sampleCount;n=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,n),e._framebuffers.set(t,n);const o=[];(f=t.colorAttachments)==null||f.forEach((d,m)=>{const l=d.view,E=e[`COLOR_ATTACHMENT${m}`];if(o.push(E),"texture"in l){const h=l.texture,T=l.baseMipLevel||0,R=l.baseArrayLayer||0;if("context"in h){o.pop();return}const y=Ve(e,h),b=Ae(h.descriptor.dimension);b==="TEXTURE_2D"?e.framebufferTexture2D(e.FRAMEBUFFER,E,e[b],y,T):b==="TEXTURE_2D_ARRAY"?e instanceof WebGL2RenderingContext&&e.framebufferTextureLayer(e.DRAW_FRAMEBUFFER,E,y,T,R):console.error(`未处理 ${b} 的颜色附件纹理设置！`)}else{const h=Rr(e,l,s);e.framebufferRenderbuffer(e.FRAMEBUFFER,E,e.RENDERBUFFER,h)}}),e instanceof WebGL2RenderingContext?e.drawBuffers(o):console.error("WebGL1 不支持 drawBuffers 。");const i=t.depthStencilAttachment;if(i){if(i.view){const d=i.view,m=d.texture,l=d.baseMipLevel||0,E=d.baseArrayLayer||0;if(!("context"in m)){const h=Ve(e,m),T=Ae(m.descriptor.dimension);T==="TEXTURE_2D"?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e[T],h,l):T==="TEXTURE_2D_ARRAY"?e instanceof WebGL2RenderingContext&&e.framebufferTextureLayer(e.DRAW_FRAMEBUFFER,e.DEPTH_ATTACHMENT,h,l,E):console.error(`未处理 ${T} 的深度模板附件纹理设置！`)}}else if(n){const d=(_=t.colorAttachments)==null?void 0:_[0];let m=e.drawingBufferWidth,l=e.drawingBufferHeight;if(d!=null&&d.view){const T=d.view;if("texture"in T){const R=T.texture;"descriptor"in R&&(m=R.descriptor.size[0],l=R.descriptor.size[1])}}const E=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,E),e instanceof WebGL2RenderingContext?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH24_STENCIL8,m,l),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,E)):(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,m,l),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,E));const h=e;h._framebufferDepthRenderbuffers||(h._framebufferDepthRenderbuffers=new Map),h._framebufferDepthRenderbuffers.set(n,E)}}return n}function Fe(e,t,r=!0){if(r&&(t!=null&&t[ne])){Ur(e,t[ne]);return}const n=e._framebuffers.get(t);e._framebuffers.delete(t);const s=e;if(s._framebufferDepthRenderbuffers&&n){const o=s._framebufferDepthRenderbuffers.get(n);o&&(e.deleteRenderbuffer(o),s._framebufferDepthRenderbuffers.delete(n))}e.deleteFramebuffer(n)}function Ur(e,t){Fe(e,t.blitFramebuffer.read,!1),Fe(e,t.blitFramebuffer.draw,!1),t.renderbuffers.forEach(r=>{St(e,r)})}function Nr(e){const t=Dr[e];return console.assert(!!t),t}function Mr(e){return Gr[e]!==void 0}const Or={FLOAT:5126,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT:5124,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676},Ft={SAMPLER_2D:35678,SAMPLER_CUBE:35680},Br={UNSIGNED_INT:5125,UNSIGNED_INT_VEC2:36294,UNSIGNED_INT_VEC3:36295,UNSIGNED_INT_VEC4:36296,FLOAT_MAT2x3:35685,FLOAT_MAT2x4:35686,FLOAT_MAT3x2:35687,FLOAT_MAT3x4:35688,FLOAT_MAT4x2:35689,FLOAT_MAT4x3:35690},vt={SAMPLER_3D:35679,SAMPLER_2D_SHADOW:35682,SAMPLER_2D_ARRAY:36289,SAMPLER_2D_ARRAY_SHADOW:36292,SAMPLER_CUBE_SHADOW:36293,INT_SAMPLER_2D:36298,INT_SAMPLER_3D:36299,INT_SAMPLER_CUBE:36300,INT_SAMPLER_2D_ARRAY:36303,UNSIGNED_INT_SAMPLER_2D:36306,UNSIGNED_INT_SAMPLER_3D:36307,UNSIGNED_INT_SAMPLER_CUBE:36308,UNSIGNED_INT_SAMPLER_2D_ARRAY:36311},nt={...Or,...Ft,...Br,...vt},Gr={...Ft,...vt},Dr=Object.keys(nt).reduce((e,t)=>(e[nt[t]]=t,e),{});function Le(e,t){const r=Lt(t);let n=e._programs[r];if(n)return n;const s=t.vertex.glsl||t.vertex.code;let o;const i=t.fragment;i&&(o=i.glsl||i.code),o=o||`#version 300 es
        precision highp float;
        precision highp int;

        void main()
        {
        }
    `;const a=t.transformFeedbackVaryings;return n=zr(e,s,o,a),e._programs[r]=n,n}function gr(e,t){const r=Lt(t),n=e._programs[r];n&&(delete e._programs[r],e.deleteProgram(n))}function Lt(e){const t=e.vertex.glsl||e.vertex.code;let r;const n=e.fragment;n&&(r=n.glsl||n.code);const s=e.transformFeedbackVaryings;return`---vertexShader---
${t}
---fragment---
${r}
---feedback---${s==null?void 0:s.varyings.toString()} ${s==null?void 0:s.bufferMode}`}function zr(e,t,r,n){const s=st(e,"VERTEX_SHADER",t),o=st(e,"FRAGMENT_SHADER",r),i=Vr(e,s,o,n),a=e.getProgramParameter(i,e.ACTIVE_ATTRIBUTES),c=[];for(let d=0;d<a;d++){const m=e.getActiveAttrib(i,d),{name:l,size:E,type:h}=m,T=e.getAttribLocation(i,l),R=Xr(h);c.push({name:l,size:E,type:R,location:T})}const u=e.getProgramParameter(i,e.ACTIVE_UNIFORMS),f=[];let _=0;for(let d=0;d<u;d++){const m=e.getActiveUniform(i,d),{name:l,size:E,type:h}=m,T=Nr(h),R=Mr(T),y=/(\w+)/g,b=[l];if(E>1){console.assert(l.substring(l.length-3)==="[0]");const N=l.substring(0,l.length-3);for(let P=1;P<E;P++)b[P]=`${N}[${P}]`}const C=[];for(let N=0;N<b.length;N++){const P=b[N];let z=y.exec(P);const V=[];for(;z;)V.push(z[1]),z=y.exec(P);const U=e.getUniformLocation(i,P);R?(C.push({location:U,paths:V,textureID:_}),_++):C.push({location:U,paths:V,textureID:-1})}f[d]={name:l,type:T,isTexture:R,items:C}}if(e instanceof WebGL2RenderingContext){const d=e.getProgramParameter(i,e.ACTIVE_UNIFORM_BLOCKS),m=new Array(d).fill(0).map((l,E)=>{e.uniformBlockBinding(i,E,E);const h=e.getActiveUniformBlockParameter(i,E,e.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),T=[];for(let b=0;b<h.length;b++){const C=f[h[b]];C.inBlock=!0,T.push(C)}const y={name:e.getActiveUniformBlockName(i,E),index:E,dataSize:e.getActiveUniformBlockParameter(i,E,e.UNIFORM_BLOCK_DATA_SIZE),uniforms:T,bufferBindingInfo:void 0};return y.bufferBindingInfo=Wr(y),y});i.uniformBlocks=m}return i.vertex=t,i.fragment=r,i.attributes=c,i.uniforms=f,i}function st(e,t,r){let n=e._shaders[r];if(n)return n;if(n=e.createShader(e[t]),e._shaders[r]=n,e.shaderSource(n,r),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS)){const o=e.getShaderInfoLog(n);throw e.deleteShader(n),`Failed to compile shader: ${o}`}return n}function Vr(e,t,r,n){const s=e.createProgram();if(e.attachShader(s,t),e.attachShader(s,r),n&&(e instanceof WebGL2RenderingContext?e.transformFeedbackVaryings(s,n.varyings,e[n.bufferMode]):console.error("WebGL1 不支持 transformFeedbackVaryings 功能！")),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS)){const i=e.getProgramInfoLog(s);throw e.deleteProgram(s),e.deleteShader(r),e.deleteShader(t),`Failed to link program: ${i}`}return s}function Wr(e){const t=e.dataSize;let r=0,n;const s=[];return e.uniforms.forEach(i=>{const a=i.type,c=kr[a];console.assert(!!c,`没有找到 ${a} 统一缓冲类型对应的对齐与尺寸。`);const u=i.name.substring(0,i.name.lastIndexOf("."));n!==u&&(r=Ne(16,r),n=u),i.items.forEach(f=>{r=Ne(c.align,r);const _=r,d=c.size;r+=c.size;const m=c.clsType,l=f.paths.slice(1);s.push({paths:l,offset:_,size:d,Cls:m})})}),r=Ne(16,r),console.assert(t===r,`uniformBlock映射尺寸出现错误( ${t}  ${r} )！`),{size:e.dataSize,items:s}}function Ne(e,t){return Math.ceil(t/e)*e}const kr={FLOAT:{align:4,size:4,clsType:Float32Array},FLOAT_VEC2:{align:8,size:8,clsType:Float32Array},FLOAT_VEC3:{align:16,size:12,clsType:Float32Array},FLOAT_VEC4:{align:16,size:16,clsType:Float32Array},INT:{align:4,size:4,clsType:Int32Array},INT_VEC2:{align:8,size:8,clsType:Int32Array},INT_VEC3:{align:16,size:12,clsType:Int32Array},INT_VEC4:{align:16,size:16,clsType:Int32Array},BOOL:{align:4,size:4,clsType:Int32Array},BOOL_VEC2:{align:8,size:8,clsType:Int32Array},BOOL_VEC3:{align:16,size:12,clsType:Int32Array},BOOL_VEC4:{align:16,size:16,clsType:Int32Array},FLOAT_MAT2:{align:8,size:16,clsType:Float32Array},FLOAT_MAT3:{align:16,size:48,clsType:Float32Array},FLOAT_MAT4:{align:16,size:64,clsType:Float32Array},UNSIGNED_INT:{align:4,size:4,clsType:Uint32Array},UNSIGNED_INT_VEC2:{align:8,size:8,clsType:Uint32Array},UNSIGNED_INT_VEC3:{align:16,size:12,clsType:Uint32Array},UNSIGNED_INT_VEC4:{align:16,size:16,clsType:Uint32Array},FLOAT_MAT2x3:{align:16,size:32,clsType:Float32Array},FLOAT_MAT2x4:{align:16,size:32,clsType:Float32Array},FLOAT_MAT3x2:{align:8,size:24,clsType:Float32Array},FLOAT_MAT3x4:{align:16,size:48,clsType:Float32Array},FLOAT_MAT4x2:{align:8,size:32,clsType:Float32Array},FLOAT_MAT4x3:{align:16,size:64,clsType:Float32Array}};function Xr(e){return Yr[e]}const Yr=Object.freeze({5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5124:"INT",5125:"UNSIGNED_INT",5126:"FLOAT",5131:"HALF_FLOAT"});function It(e){const t=it[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(it).toString()} 中取值！`),t}const it={never:"NEVER",less:"LESS",equal:"EQUAL","less-equal":"LEQUAL",greater:"GREATER","not-equal":"NOTEQUAL","greater-equal":"GEQUAL",always:"ALWAYS"};function Hr(e,t){let r=e._samplers.get(t);if(r)return r;if(e instanceof WebGL2RenderingContext){r=e.createSampler(),e._samplers.set(t,r);const n=wt(t.minFilter,t.mipmapFilter),s=Pt(t.magFilter),o=pe(t.addressModeU),i=pe(t.addressModeV),a=pe(t.addressModeW),c=t.lodMinClamp||0,u=t.lodMaxClamp||16,f=t.compare?"COMPARE_REF_TO_TEXTURE":"NONE",_=It(t.compare??"less-equal");e.samplerParameteri(r,e.TEXTURE_MIN_FILTER,e[n]),e.samplerParameteri(r,e.TEXTURE_MAG_FILTER,e[s]),e.samplerParameteri(r,e.TEXTURE_WRAP_S,e[o]),e.samplerParameteri(r,e.TEXTURE_WRAP_T,e[i]),e.samplerParameteri(r,e.TEXTURE_WRAP_R,e[a]),e.samplerParameterf(r,e.TEXTURE_MIN_LOD,c),e.samplerParameterf(r,e.TEXTURE_MAX_LOD,u),e.samplerParameteri(r,e.TEXTURE_COMPARE_MODE,e[f]),e.samplerParameteri(r,e.TEXTURE_COMPARE_FUNC,e[_])}return r}function Kr(e,t){if(e instanceof WebGL2RenderingContext){const r=e._samplers.get(t);e._samplers.delete(t),e.deleteSampler(r)}}function pe(e="repeat"){const t=ot[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(ot).toString()} 中取值！`),t}const ot={"clamp-to-edge":"CLAMP_TO_EDGE",repeat:"REPEAT","mirror-repeat":"MIRRORED_REPEAT"};function wt(e="nearest",t){let r;return e==="linear"?t==="linear"?r="LINEAR_MIPMAP_LINEAR":t==="nearest"?r="LINEAR_MIPMAP_NEAREST":r="LINEAR":t==="linear"?r="NEAREST_MIPMAP_LINEAR":t==="nearest"?r="NEAREST_MIPMAP_NEAREST":r="NEAREST",r}function Pt(e="nearest"){const t=at[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(at).toString()} 中取值！`),t}const at={nearest:"NEAREST",linear:"LINEAR"};function $r(e,t){let r=e._transforms.get(t);return r||(e instanceof WebGL2RenderingContext&&(r=e.createTransformFeedback(),e._transforms.set(t,r),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,r),t.bindBuffers.forEach(n=>{const{index:s,data:o}=n,i=H.getBuffer(o.buffer),a=ae(e,i,"TRANSFORM_FEEDBACK_BUFFER","STREAM_COPY");e.bindBufferBase(e.TRANSFORM_FEEDBACK_BUFFER,s,a)}),e.bindBuffer(e.ARRAY_BUFFER,null)),r)}function Qr(e,t){const r=e._transforms.get(t);r&&(e._transforms.delete(t),e instanceof WebGL2RenderingContext&&e.deleteTransformFeedback(r))}const ct="_GL_Submit_Times";function qr(e,t){if(!t||!(e instanceof WebGL2RenderingContext))return ye;let r=t._GLRenderOcclusionQuery;if(r)return r;const n=t.filter(i=>i.__type__==="OcclusionQuery");if(n.length===0)return t._GLRenderOcclusionQuery=ye,ye;const s=()=>{n.forEach((i,a)=>{i._step=Zr(e,i)})},o=i=>{const a=n.map(c=>c._step.resolve());Promise.all(a).then(c=>{var u;(u=i.onOcclusionQuery)==null||u.call(i,n,c)})};return t._GLRenderOcclusionQuery=r={init:s,resolve:o},r}const ye={init:()=>{},resolve:()=>{}};function Zr(e,t){const r={};let n;return{begin:()=>{n=e.createQuery(),e.beginQuery(e.ANY_SAMPLES_PASSED,n)},end:()=>{e.endQuery(e.ANY_SAMPLES_PASSED)},resolve:async()=>{if(r.result!==void 0)return r.result;if(e instanceof WebGL2RenderingContext)return await new Promise((c,u)=>{(function f(){if(!e.getQueryParameter(n,e.QUERY_RESULT_AVAILABLE)){requestAnimationFrame(f);return}const _=r.result=e.getQueryParameter(n,e.QUERY_RESULT);t.onQuery(_),c(_),e.deleteQuery(n)})()})}}}function Ut(e){let t=Jr[e];return console.assert(!!t,`WebGL 不支持参数 IPrimitiveTopology ${e} !`),t=t||e,t}const Jr={"point-list":"POINTS","line-list":"LINES","line-strip":"LINE_STRIP","triangle-list":"TRIANGLES","triangle-strip":"TRIANGLE_STRIP",LINE_LOOP:"LINE_LOOP",TRIANGLE_FAN:"TRIANGLE_FAN"};function jr(e,t,r,n){const s=r.BYTES_PER_ELEMENT===2?e.UNSIGNED_SHORT:e.UNSIGNED_INT,o=n.indexCount,i=n.firstIndex||0,a=n.instanceCount||1,c=i*r.BYTES_PER_ELEMENT+r.byteOffset;a>1?e instanceof WebGL2RenderingContext?e.drawElementsInstanced(e[t],o,s,c,a):e.getExtension("ANGLE_instanced_arrays").drawElementsInstancedANGLE(e[t],o,s,c,a):e.drawElements(e[t],o,s,c)}function Nt(e,t,r){const n=r.vertexCount,s=r.firstVertex||0,o=r.instanceCount||1;o>1?e instanceof WebGL2RenderingContext?e.drawArraysInstanced(e[t],s,n,o):e.getExtension("ANGLE_instanced_arrays").drawArraysInstancedANGLE(e[t],s,n,o):e.drawArrays(e[t],s,n)}const ut=Object.freeze({FRONT_AND_BACK:"FRONT_AND_BACK",none:"BACK",front:"FRONT",back:"BACK"}),ft=Object.freeze({ccw:"CCW",cw:"CW"});function en(e,t){const r=(t==null?void 0:t.cullFace)||"none",n=(t==null?void 0:t.frontFace)||"ccw";if(r!=="none"){const s=ut[r];console.assert(!!s,`接收到错误值，请从 ${Object.keys(ut).toString()} 中取值！`);const o=ft[n];console.assert(!!o,`接收到错误 IFrontFace 值，请从 ${Object.keys(ft).toString()} 中取值！`),e.enable(e.CULL_FACE),e.cullFace(e[s]),e.frontFace(e[o])}else e.disable(e.CULL_FACE)}function tn(e,t,r=!0){if(!r){e.disable(e.DEPTH_TEST);return}if(t&&(t.depthWriteEnabled||t.depthCompare!=="always")){const n=It(t.depthCompare??"less"),s=t.depthWriteEnabled??!0;if(e.enable(e.DEPTH_TEST),e.depthFunc(e[n]),e.depthMask(s),t.depthBias||t.depthBiasSlopeScale){const o=t.depthBiasSlopeScale??0,i=t.depthBias??0;e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(o,i)}else e.disable(e.POLYGON_OFFSET_FILL)}else e.disable(e.DEPTH_TEST)}function rn(e,t){var s,o;const r=((s=t==null?void 0:t[0])==null?void 0:s.writeMask)||[!0,!0,!0,!0];e.colorMask(r[0],r[1],r[2],r[3]);const n=(o=t==null?void 0:t[0])==null?void 0:o.blend;if(n){const i=n.color,a=n.alpha,c=dt((i==null?void 0:i.operation)??Ie.operation),u=Se((i==null?void 0:i.srcFactor)??Ie.srcFactor,i==null?void 0:i.operation),f=Se((i==null?void 0:i.dstFactor)??Ie.dstFactor,i==null?void 0:i.operation),_=dt(a==null?void 0:a.operation)||c,d=Se(a==null?void 0:a.srcFactor,i==null?void 0:i.operation)||u,m=Se(a==null?void 0:a.dstFactor,i==null?void 0:i.operation)||f;if(Vt.getBlendConstantColor(n)){const E=n.constantColor??[0,0,0,0];e.blendColor(E[0],E[1],E[2],E[3])}e.enable(e.BLEND),e.blendEquationSeparate(e[c],e[_]),e.blendFuncSeparate(e[u],e[f],e[d],e[m])}else e.disable(e.BLEND)}function dt(e){if(!e)return;const t=_t[e];return console.assert(!!t,`接收到错误值，请从 ${Object.keys(_t).toString()} 中取值！`),t}const _t={add:"FUNC_ADD",subtract:"FUNC_SUBTRACT","reverse-subtract":"FUNC_REVERSE_SUBTRACT",min:"MIN",max:"MAX"};function Se(e,t){if(!e)return;(t==="max"||t==="min")&&(e="one");const r=mt[e];return console.assert(!!r,`接收到错误值，请从 ${Object.keys(mt).toString()} 中取值！`),r}const mt={zero:"ZERO",one:"ONE",src:"SRC_COLOR","one-minus-src":"ONE_MINUS_SRC_COLOR","src-alpha":"SRC_ALPHA","one-minus-src-alpha":"ONE_MINUS_SRC_ALPHA",dst:"DST_COLOR","one-minus-dst":"ONE_MINUS_DST_COLOR","dst-alpha":"DST_ALPHA","one-minus-dst-alpha":"ONE_MINUS_DST_ALPHA","src-alpha-saturated":"SRC_ALPHA_SATURATE",constant:"CONSTANT_COLOR","one-minus-constant":"ONE_MINUS_CONSTANT_COLOR"};function nn(e,t){const r=Le(e,t);e.useProgram(r),rn(e,t.fragment.targets)}function sn(e,t){const{stencilFront:r,stencilBack:n}={...t};if(r||n){const s=t.stencilReference??0,o=t.stencilReadMask??4294967295,i=t.stencilWriteMask??4294967295;if(e.enable(e.STENCIL_TEST),r){const a=lt(r.compare??"always"),c=te(r.failOp),u=te(r.depthFailOp),f=te(r.passOp);e.stencilFuncSeparate(e.FRONT,e[a],s,o),e.stencilOpSeparate(e.FRONT,e[c],e[u],e[f]),e.stencilMaskSeparate(e.FRONT,i)}if(n){const a=lt(n.compare??"always"),c=te(n.failOp),u=te(n.depthFailOp),f=te(n.passOp);e.stencilFuncSeparate(e.BACK,e[a],s,o),e.stencilOpSeparate(e.BACK,e[c],e[u],e[f]),e.stencilMaskSeparate(e.BACK,i)}}else e.disable(e.STENCIL_TEST)}function lt(e){return on[e]}const on={never:"NEVER",less:"LESS",equal:"EQUAL","less-equal":"LEQUAL",greater:"GREATER","not-equal":"NOTEQUAL","greater-equal":"GEQUAL",always:"ALWAYS"};function te(e){return an[e]}const an={keep:"KEEP",zero:"ZERO",replace:"REPLACE",invert:"INVERT","increment-clamp":"INCR","decrement-clamp":"DECR","increment-wrap":"INCR_WRAP","decrement-wrap":"DECR_WRAP"};function cn(e,t,r=!0){nn(e,t),tn(e,t.depthStencil,r),sn(e,t.depthStencil)}function un(e,t,r){if(r){const n=r.isYup??!0,s=r.x??0;let o=r.y??0;const i=r.width??t.width,a=r.height??t.height;n||(o=t.height-o-a),e.enable(e.SCISSOR_TEST),e.scissor(s,o,i,a)}else e.disable(e.SCISSOR_TEST)}const Me=new WeakMap;function fn(e,t){if(Me.has(t)){const a=Me.get(t);a.size!==e.size&&console.warn("updateBufferBinding 出现一份数据对应多个 variableInfo",{uniformData:t,bufferBindingInfo:e,preVariableInfo:a});return}Me.set(t,e);const r=e.size,n=!!t.bufferView;n?console.assert(t.bufferView.byteLength>=r,"uniformData.bufferView 统一块数据提供数据尺寸不能小于实际尺寸！"):t.bufferView=new Uint8Array(r);const s=H.getBuffer(t.bufferView.buffer),o=t.bufferView.byteOffset,i=K(t);e.items.forEach(a=>{const{paths:c,offset:u,size:f,Cls:_}=a;ge(()=>{let d=t.value,m=i.value;if(d===void 0)return;for(let h=0;h<c.length;h++)if(d=d[c[h]],m=m[c[h]],d===void 0){n||console.warn(`没有找到 统一块变量属性 ${c.join(".")} 的值！`);return}let l;typeof d=="number"?l=new _([d]):d.constructor.name!==_.name?l=new _(d):l=d;const E=s.writeBuffers??[];E.push({data:l,bufferOffset:o+u,size:Math.min(f,l.byteLength)/l.BYTES_PER_ELEMENT}),K(s).writeBuffers=E})})}function dn(e,t,r,n,s){if(e instanceof WebGL2RenderingContext){const i=Hr(e,n);e.bindSampler(s,i)}else{const i=wt(n.minFilter,n.mipmapFilter),a=Pt(n.magFilter),c=pe(n.addressModeU),u=pe(n.addressModeV);r.minFilter!==i&&(e.texParameteri(e[t],e.TEXTURE_MIN_FILTER,e[i]),r.minFilter=i),r.magFilter!==a&&(e.texParameteri(e[t],e.TEXTURE_MAG_FILTER,e[a]),r.magFilter=a),r.wrapS!==c&&(e.texParameteri(e[t],e.TEXTURE_WRAP_S,e[c]),r.wrapS=c),r.wrapT!==u&&(e.texParameteri(e[t],e.TEXTURE_WRAP_T,e[u]),r.wrapT=u)}const o=(n==null?void 0:n.maxAnisotropy)||1;if(r.maxAnisotropy!==o){const i=e.getExtension("EXT_texture_filter_anisotropic");i&&e.texParameterf(e[t],i.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o,e._capabilities.maxAnisotropy)),r.maxAnisotropy=o}}function _n(e,t,r){const{texture:n,sampler:s}=r,{location:o,textureID:i}=t,a=Ae(n.descriptor.dimension);e.uniform1i(o,i);const c=Ve(e,n);e.activeTexture(e[`TEXTURE${i}`]),e.bindTexture(e[a],c);const u=mn(n,s);return dn(e,a,c,u,i),c}const Et=new WeakSet;function mn(e,t){const r=e.descriptor;return!(r.generateMipmap||r.mipLevelCount&&r.mipLevelCount>1)&&t.mipmapFilter?(Et.has(e)||(Et.add(e),console.warn(`[WebGL] 纹理没有 mipmap（generateMipmap: false），但采样器设置了 mipmapFilter: '${t.mipmapFilter}'。 已自动忽略 mipmapFilter 并将 lodMaxClamp 设为 0，以避免黑屏。 建议：设置 generateMipmap: true 或移除 mipmapFilter 配置。`)),{...t,mipmapFilter:void 0,lodMaxClamp:0}):t}function ln(e,t,r,n){let s=n.value;typeof s=="number"?s=[s]:s.toArray&&(s=s.toArray());const o=r.location;switch(t){case"BOOL":case"INT":e.uniform1iv(o,s);break;case"BOOL_VEC2":case"INT_VEC2":e.uniform2iv(o,s);break;case"BOOL_VEC3":case"INT_VEC3":e.uniform3iv(o,s);break;case"BOOL_VEC4":case"INT_VEC4":e.uniform4iv(o,s);break;case"FLOAT":e.uniform1fv(o,[s]);break;case"FLOAT_VEC2":e.uniform2fv(o,s);break;case"FLOAT_VEC3":e.uniform3fv(o,s);break;case"FLOAT_VEC4":e.uniform4fv(o,s);break;case"FLOAT_MAT2":e.uniformMatrix2fv(o,!1,s);break;case"FLOAT_MAT3":e.uniformMatrix3fv(o,!1,s);break;case"FLOAT_MAT4":e.uniformMatrix4fv(o,!1,s);break;case"UNSIGNED_INT":e.uniform1uiv(o,s);break;case"UNSIGNED_INT_VEC2":e.uniform2uiv(o,s);break;case"UNSIGNED_INT_VEC3":e.uniform3uiv(o,s);break;case"UNSIGNED_INT_VEC4":e.uniform4uiv(o,s);break;case"FLOAT_MAT2x3":e.uniformMatrix2x3fv(o,!1,s);break;case"FLOAT_MAT2x4":e.uniformMatrix2x4fv(o,!1,s);break;case"FLOAT_MAT3x2":e.uniformMatrix3x2fv(o,!1,s);break;case"FLOAT_MAT3x4":e.uniformMatrix3x4fv(o,!1,s);break;case"FLOAT_MAT4x2":e.uniformMatrix4x2fv(o,!1,s);break;case"FLOAT_MAT4x3":e.uniformMatrix4x3fv(o,!1,s);break;default:console.error(`无法识别的uniform类型 ${r.paths} ${t}`)}}function En(e){return e&&typeof e=="object"&&"texture"in e}function hn(e){return e&&typeof e=="object"&&!("texture"in e)&&!("value"in e)&&!("buffer"in e)}function Tn(e){return e&&typeof e=="object"&&"descriptor"in e}function pn(e,t){const r=`${t}_texture`,n=t,s=e[r],o=e[n];if(s&&o&&En(s)&&hn(o)&&Tn(s.texture))return{texture:s.texture,sampler:o}}function Mt(e,t,r){const n=Le(e,t);n.uniforms.forEach(s=>{const{name:o,type:i,items:a,isTexture:c,inBlock:u}=s;u||a.forEach(f=>{const{paths:_}=f;let d=r[_[0]];for(let m=1;m<_.length;m++)d=d[_[m]];if(c&&!(d&&typeof d=="object"&&"texture"in d)){const l=pn(r,_[0]);l&&(d=l)}d===void 0&&console.error(`沒有找到Uniform ${o} 數據！`),c?_n(e,f,d):ln(e,i,f,d)})}),e instanceof WebGL2RenderingContext&&n.uniformBlocks.forEach(s=>{const{name:o,index:i}=s;let a=r[o];if(a===void 0){const m=o.charAt(0).toLowerCase()+o.slice(1);a=r[m]}if(a===void 0)throw new Error(`没有找到 UniformBlock "${o}" 的数据，请检查 bindingResources 中是否包含 "${o}" 或 "${o.charAt(0).toLowerCase()+o.slice(1)}" 键。`);let c=a;if(!(c.buffer&&c.BYTES_PER_ELEMENT)){const m=a;fn(s.bufferBindingInfo,m),c=m.bufferView}const u=H.getBuffer(c.buffer);u.label=u.label||`UniformBuffer ${o}`;const f=c.byteOffset,_=s.bufferBindingInfo.size,d=ae(e,u,"UNIFORM_BUFFER","DYNAMIC_DRAW");e.bindBufferRange(e.UNIFORM_BUFFER,i,d,f,_)})}function bn(e,t){if(!t)return;const r=H.getBuffer(t.buffer);r.label||(K(r).label=`顶点索引 ${An++}`);const n=ae(e,r,"ELEMENT_ARRAY_BUFFER","STATIC_DRAW");e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n)}let An=0;function xn(e,t,r){const{stepMode:n,format:s,data:o}=r;let{arrayStride:i,offset:a}=r;const c=zt[s],{numComponents:u,normalized:f,type:_}=c;e.enableVertexAttribArray(t),n==="instance"&&(e instanceof WebGL2RenderingContext?e.vertexAttribDivisor(t,1):e.getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(t,1)),i=i||c.byteSize,a=o.byteOffset+(a||0);const d=H.getBuffer(o.buffer);d.label||(K(d).label=`顶点数据 ${Rn++}`);const m=ae(e,d,"ARRAY_BUFFER","STATIC_DRAW");e.bindBuffer(e.ARRAY_BUFFER,m),e instanceof WebGL2RenderingContext&&(_==="INT"||_==="UNSIGNED_INT")?e.vertexAttribIPointer(t,u,e[_],i,a):e.vertexAttribPointer(t,u,e[_],f,i,a)}let Rn=0;function Ot(e,t,r,n){if(!r&&!n)return;let s;if(e instanceof WebGL2RenderingContext){if(s=e._vertexArrays.get([t,r,n]),s){e.bindVertexArray(s);return}s=e.createVertexArray(),e.bindVertexArray(s),e._vertexArrays.set([t,r,n],s)}Le(e,t).attributes.forEach(i=>{const{name:a,location:c}=i;if(c<0)return;const u=r[a];u||console.error(`缺少顶点 ${a} 数据！`),xn(e,c,u)}),bn(e,n)}function yn(e,t,r){if(r){const n=r.isYup??!0,s=r.x??0;let o=r.y??0;const i=r.width??t.width,a=r.height??t.height;n||(o=t.height-o-a),e.viewport(s,o,i,a)}else e.viewport(0,0,t.width,t.height)}function We(e,t,r,n=!0){const{viewport:s,scissorRect:o,pipeline:i,vertices:a,indices:c,draw:u,bindingResources:f}=r,_=i==null?void 0:i.primitive;yn(e,t,s),un(e,t,o),cn(e,i,n),Mt(e,i,f),Ot(e,i,a,c),en(e,_);const d=(_==null?void 0:_.topology)||"triangle-list",m=Ut(d);u.__type__==="DrawVertex"?Nt(e,m,u):jr(e,m,c,u)}function Ke(e,t){const{read:r,draw:n,blitFramebuffers:s}=t,o=Ce(e,r),i=Ce(e,n);e instanceof WebGL2RenderingContext&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,o),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,i),n.colorAttachments.forEach((a,c)=>{var f;const u=(f=n.colorAttachments[c])==null?void 0:f.clearValue;u&&e.clearBufferfv(e.COLOR,c,u)}),s.forEach(a=>{const[c,u,f,_,d,m,l,E,h,T]=a;e.blitFramebuffer(c,u,f,_,d,m,l,E,e[h],e[T])}))}function ht(e,t,r,n=!0){r._step.begin(),r.renderObjects.forEach(s=>{We(e,t,s,n)}),r._step.end()}function Tt(e,t){var a;t=t||{};const r=Ce(e,t);e.bindFramebuffer(e.FRAMEBUFFER,r);const n=(a=t.colorAttachments)==null?void 0:a[0],s=(n==null?void 0:n.clearValue)??[0,0,0,0],o=(n==null?void 0:n.loadOp)??"clear";e.clearColor(s[0],s[1],s[2],s[3]);const i=t.depthStencilAttachment;if(i){const c=i.depthClearValue??1,u=i.depthLoadOp??"clear",f=i.stencilClearValue??0,_=i.stencilLoadOp??"load";e.clearDepth(c),e.clearStencil(f),e.clear((o==="clear"?e.COLOR_BUFFER_BIT:0)|(u==="clear"?e.DEPTH_BUFFER_BIT:0)|(_==="clear"?e.STENCIL_BUFFER_BIT:0))}else e.clear(o==="clear"?e.COLOR_BUFFER_BIT:0)}function Sn(e,t,r){var a,c;const n=t.descriptor||r,s=Cn(e,n),o=!!(n!=null&&n.depthStencilAttachment),i=qr(e,t.renderPassObjects);if(i.init(),n!=null&&n.sampleCount&&n.colorAttachments[0].view.texture){const{passDescriptor:u,blitFramebuffer:f}=Sr(n);Tt(e,u),(a=t.renderPassObjects)==null||a.forEach(_=>{_.__type__==="OcclusionQuery"?ht(e,s,_,o):We(e,s,_,o)}),Ke(e,f)}else Tt(e,n),(c=t.renderPassObjects)==null||c.forEach(u=>{u.__type__==="OcclusionQuery"?ht(e,s,u,o):We(e,s,u,o)});i.resolve(t)}function Cn(e,t){var s;if(!t)return{width:e.drawingBufferWidth,height:e.drawingBufferHeight};const r=t.colorAttachments;if(r){const o=(s=r[0])==null?void 0:s.view;if(o){const i=o.texture;if("context"in i){const a=i,c=typeof a.context.canvasId=="string"?document.getElementById(a.context.canvasId):a.context.canvasId;if(c)return{width:c.width,height:c.height}}else if("descriptor"in i){const a=i;return{width:a.descriptor.size[0],height:a.descriptor.size[1]}}}return{width:e.drawingBufferWidth,height:e.drawingBufferHeight}}const n=t.depthStencilAttachment;if(n){const o=n.view;if(o){const i=o.texture;if("context"in i){const a=i,c=typeof a.context.canvasId=="string"?document.getElementById(a.context.canvasId):a.context.canvasId;if(c)return{width:c.width,height:c.height}}else if("descriptor"in i){const a=i;return{width:a.descriptor.size[0],height:a.descriptor.size[1]}}}return{width:e.drawingBufferWidth,height:e.drawingBufferHeight}}return{width:e.drawingBufferWidth,height:e.drawingBufferHeight}}function Fn(e,t){const r=Le(e,t);e.useProgram(r)}function vn(e,t,r){if(e instanceof WebGL2RenderingContext)if(t){const n=$r(e,t);e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,n),e.beginTransformFeedback(e[r])}else e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null);else t&&console.log("WebGL1 不支持顶点着色器回写数据功能！")}function Ln(e,t){t&&e instanceof WebGL2RenderingContext&&(e.endTransformFeedback(),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.TRANSFORM_FEEDBACK_BUFFER,null))}function In(e,t){const{pipeline:r,vertices:n,uniforms:s,transformFeedback:o,draw:i}=t,a=Ut("point-list");Fn(e,r),Ot(e,r,n,void 0),Mt(e,r,s),vn(e,o,a),Nt(e,a,i),Ln(e,o)}function wn(e,t){e instanceof WebGL2RenderingContext&&e.enable(e.RASTERIZER_DISCARD),t.transformFeedbackObjects.forEach(r=>{In(e,r)}),e instanceof WebGL2RenderingContext&&e.disable(e.RASTERIZER_DISCARD)}function Pn(e){const{source:t,destination:r,copySize:n}=e,s=t.aspect||"all",o=r.aspect||"all";console.assert(s===o,"拷贝纹理时两个纹理的 aspect 必须相同！");const i=[];let a;const c=[];let u,f;s==="all"?(f="COLOR_BUFFER_BIT",i.push({view:re(t)}),c.push({view:re(r)})):s==="depth-only"?(f="DEPTH_BUFFER_BIT",a={view:re(t)},u={view:re(r)}):s==="stencil-only"&&(f="STENCIL_BUFFER_BIT",a={view:re(t)},u={view:re(r)});const _=t.origin||[0,0],d=r.origin||[0,0],m=[_[0],_[1],_[0]+n[0],_[1]+n[1],d[0],d[1],d[0]+n[0],d[1]+n[1],f,"NEAREST"];return{__type__:"BlitFramebuffer",read:{colorAttachments:i,depthStencilAttachment:a},draw:{colorAttachments:c,depthStencilAttachment:u},blitFramebuffers:[m]}}function re(e){var r;return e.texture?{texture:e.texture,baseMipLevel:e.mipLevel,baseArrayLayer:(r=e.origin)==null?void 0:r[2]}:void 0}function Un(e,t){const r=Pn(t);Ke(e,r)}function Nn(e,t){if(e instanceof WebGL2RenderingContext){const r=ae(e,H.getBuffer(t.source.buffer),"COPY_READ_BUFFER"),n=ae(e,H.getBuffer(t.destination.buffer),"COPY_WRITE_BUFFER"),s=t.source.byteOffset,o=t.destination.byteOffset,i=t.size??Math.min(t.source.byteLength,t.destination.byteLength);e.bindBuffer(e.COPY_READ_BUFFER,r),e.bindBuffer(e.COPY_WRITE_BUFFER,n),e.copyBufferSubData(e.COPY_READ_BUFFER,e.COPY_WRITE_BUFFER,s,o,i),e.bindBuffer(e.COPY_READ_BUFFER,null),e.bindBuffer(e.COPY_WRITE_BUFFER,null)}else console.error("WebGL1 不支持拷贝缓冲区功能！")}function Mn(e,t,r){t.passEncoders.forEach(n=>{if(!n.__type__||n.__type__==="RenderPass"){Sn(e,n,r);return}if(n.__type__==="TransformFeedbackPass"){wn(e,n);return}if(n.__type__==="BlitFramebuffer"){Ke(e,n);return}if(n.__type__==="CopyTextureToTexture"){Un(e,n);return}if(n.__type__==="CopyBufferToBuffer"){Nn(e,n);return}console.error(`未处理 passEncoder ${n}`)})}function On(e,t,r){t.commandEncoders.map(n=>Mn(e,n,r)),e[ct]=~~e[ct]+1}function Bn(e,t){let r;if(e instanceof WebGL2RenderingContext){const{textureView:n,origin:s,copySize:o}=t,[i,a]=o;if(n)if("context"in n.texture){n.texture;const c="rgba8unorm",{format:u,type:f}=ie(c),_=Z.getTextureBytesPerPixel(c),d=Z.getTextureDataConstructor(c),l=i*_*a;r=new d(l/d.BYTES_PER_ELEMENT),e.bindFramebuffer(e.FRAMEBUFFER,null),e.readBuffer(e.BACK);const E=a===1?e.drawingBufferHeight-s[1]-1:e.drawingBufferHeight-s[1]-a;e.readPixels(s[0],E,i,a,e[u],e[f],r,0)}else{const c="COLOR_ATTACHMENT0",f=n.texture.descriptor,{format:_,type:d}=ie(f.format),m=Z.getTextureBytesPerPixel(f.format),l=Z.getTextureDataConstructor(f.format),h=i*m*a;r=new l(h/l.BYTES_PER_ELEMENT);const T={colorAttachments:[{view:n}]},R=Ce(e,T);e.bindFramebuffer(e.FRAMEBUFFER,R),e.readBuffer(e[c]),e.readPixels(s[0],s[1],i,a,e[_],e[d],r,0),Fe(e,T)}else{const c="rgba8unorm",{format:u,type:f}=ie(c),_=Z.getTextureBytesPerPixel(c),d=Z.getTextureDataConstructor(c),l=i*_*a;r=new d(l/d.BYTES_PER_ELEMENT),e.bindFramebuffer(e.FRAMEBUFFER,null),e.readBuffer(e.BACK);const E=a===1?e.drawingBufferHeight-s[1]-1:e.drawingBufferHeight-s[1]-a;e.readPixels(s[0],E,i,a,e[u],e[f],r,0)}}else console.error("WebGL1 不支持 readBuffer/readPixels ！");return r}class gn{constructor(t){w(this,"_renderingContext");w(this,"_gl");this._renderingContext=t,this._gl=Tr(this._renderingContext)}submit(t){On(this._gl,t)}readPixels(t){const r=Bn(this._gl,t),n=t.textureView;if(n){const s=n.texture;"context"in s?t.format="rgba8unorm":"descriptor"in s&&(t.format=s.descriptor.format||"rgba8unorm")}else t.format="rgba8unorm";return t.result=r,r}deleteFramebuffer(t){Fe(this._gl,t)}deleteRenderbuffer(t){St(this._gl,t)}deleteBuffer(t){lr(this._gl,t)}deleteTexture(t){wr(this._gl,t)}deleteSampler(t){Kr(this._gl,t)}deleteProgram(t){gr(this._gl,t)}deleteTransformFeedback(t){Qr(this._gl,t)}}export{H as B,gn as W,ge as e,K as r,zt as v};
//# sourceMappingURL=WebGL-lLSa4FVc.js.map
