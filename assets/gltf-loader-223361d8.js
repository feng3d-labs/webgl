var $=Object.defineProperty;var G=(e,s,t)=>s in e?$(e,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[s]=t;var c=(e,s,t)=>(G(e,typeof s!="symbol"?s+"":s,t),t);import{c as N,f as V,d as I,e as w,l as O,n as U,s as D}from"./vec3-5d562fd8.js";import{A as y,E as q}from"./common-d8a29b8a.js";import{c as m,m as L,f as z,s as P,e as H}from"./mat4-90bd9af0.js";function Y(){var e=new y(9);return y!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function J(){var e=new y(4);return y!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function X(e,s,t,n,i){return e[0]=s,e[1]=t,e[2]=n,e[3]=i,e}function Q(e,s){var t=s[0],n=s[1],i=s[2],r=s[3],a=t*t+n*n+i*i+r*r;return a>0&&(a=1/Math.sqrt(a)),e[0]=t*a,e[1]=n*a,e[2]=i*a,e[3]=r*a,e}(function(){var e=J();return function(s,t,n,i,r,a){var f,l;for(t||(t=4),n||(n=0),i?l=Math.min(i*t+n,s.length):l=s.length,f=n;f<l;f+=t)e[0]=s[f],e[1]=s[f+1],e[2]=s[f+2],e[3]=s[f+3],r(e,e,a),s[f]=e[0],s[f+1]=e[1],s[f+2]=e[2],s[f+3]=e[3];return s}})();function M(){var e=new y(4);return y!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function K(e,s,t){t=t*.5;var n=Math.sin(t);return e[0]=n*s[0],e[1]=n*s[1],e[2]=n*s[2],e[3]=Math.cos(t),e}function A(e,s,t,n){var i=s[0],r=s[1],a=s[2],f=s[3],l=t[0],o=t[1],h=t[2],d=t[3],_,u,b,T,p;return u=i*l+r*o+a*h+f*d,u<0&&(u=-u,l=-l,o=-o,h=-h,d=-d),1-u>q?(_=Math.acos(u),b=Math.sin(_),T=Math.sin((1-n)*_)/b,p=Math.sin(n*_)/b):(T=1-n,p=n),e[0]=T*i+p*l,e[1]=T*r+p*o,e[2]=T*a+p*h,e[3]=T*f+p*d,e}function W(e,s){var t=s[0]+s[4]+s[8],n;if(t>0)n=Math.sqrt(t+1),e[3]=.5*n,n=.5/n,e[0]=(s[5]-s[7])*n,e[1]=(s[6]-s[2])*n,e[2]=(s[1]-s[3])*n;else{var i=0;s[4]>s[0]&&(i=1),s[8]>s[i*3+i]&&(i=2);var r=(i+1)%3,a=(i+2)%3;n=Math.sqrt(s[i*3+i]-s[r*3+r]-s[a*3+a]+1),e[i]=.5*n,n=.5/n,e[3]=(s[r*3+a]-s[a*3+r])*n,e[r]=(s[r*3+i]+s[i*3+r])*n,e[a]=(s[a*3+i]+s[i*3+a])*n}return e}var Z=X,C=Q;(function(){var e=N(),s=V(1,0,0),t=V(0,1,0);return function(n,i,r){var a=I(i,r);return a<-.999999?(w(e,s,i),O(e)<1e-6&&w(e,t,i),U(e,e),K(n,e,Math.PI),n):a>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(w(e,i,r),n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=1+a,C(n,n))}})();(function(){var e=M(),s=M();return function(t,n,i,r,a,f){return A(e,n,a,f),A(s,i,r,f),A(t,e,s,2*f*(1-f)),t}})();(function(){var e=Y();return function(s,t,n,i){return e[0]=n[0],e[3]=n[1],e[6]=n[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-t[0],e[5]=-t[1],e[8]=-t[2],C(s,W(s,e))}})();class j{constructor(){c(this,"meshes");this.meshes=[]}}class ee{constructor(){c(this,"meshID");c(this,"primitives");this.meshID="",this.primitives=[]}}class se{constructor(){c(this,"mode");c(this,"indices");c(this,"indicesComponentType");c(this,"vertexBuffer");c(this,"matrix");c(this,"attributes");this.mode=4,this.indices=null,this.indicesComponentType=5123,this.vertexBuffer=null,this.matrix=m(),this.attributes={}}}class te{constructor(){c(this,"defaultScene");c(this,"scenes");c(this,"json");this.defaultScene="",this.scenes={},this.json=null}}class ue{constructor(){c(this,"glTF");c(this,"_parseDone");c(this,"_loadDone");c(this,"_bufferRequested");c(this,"_bufferLoaded");c(this,"_buffers");c(this,"_bufferTasks");c(this,"_bufferViews");c(this,"_pendingTasks");c(this,"_finishedPendingTasks");c(this,"onload");c(this,"baseUri");this._init(),this.glTF=null}_init(){this._parseDone=!1,this._loadDone=!1,this._bufferRequested=0,this._bufferLoaded=0,this._buffers={},this._bufferTasks={},this._bufferViews={},this._pendingTasks=0,this._finishedPendingTasks=0,this.onload=null}_getBufferViewData(s,t,n){const i=this._bufferViews[t];if(i)n(i);else{const r=s.bufferViews[t],a=this._buffers[r.buffer];if(a)this._bufferViews[t]=a.slice(r.byteOffset,r.byteOffset+r.byteLength),n(i);else{this._pendingTasks++;let f=this._bufferTasks[r.buffer];f||(this._bufferTasks[r.buffer]=[],f=this._bufferTasks[r.buffer]);const l=this;f.push(function(o){let h=l._bufferViews[t];h||(console.log(`create new BufferView Data for ${t}`),h=l._bufferViews[t]=o.slice(r.byteOffset,r.byteOffset+r.byteLength)),l._finishedPendingTasks++,n(h)})}}}_checkComplete(){this._bufferRequested===this._bufferLoaded&&(this._loadDone=!0),this._loadDone&&this._parseDone&&this._pendingTasks===this._finishedPendingTasks&&this.onload(this.glTF)}_parseGLTF(s){this.glTF.json=s,this.glTF.defaultScene=s.scene;for(const t in s.scenes){const n=new j;this.glTF.scenes[t]=n;const r=s.scenes[t].nodes,a=r.length;for(let f=0;f<a;++f){const l=r[f],o=s.nodes[l];this._parseNode(s,o,n)}}this._parseDone=!0,this._checkComplete()}_parseNode(s,t,n,i){i===void 0&&(i=m());const r=m();if(t.hasOwnProperty("matrix")){for(let o=0;o<16;++o)r[o]=t.matrix[o];L(r,i,r)}else D(S,t.translation[0],t.translation[1],t.translation[2]),Z(x,t.rotation[0],t.rotation[1],t.rotation[2],t.rotation[3]),z(F,x,S),L(r,r,F),D(B,t.scale[0],t.scale[1],t.scale[2]),P(r,r,B);const a=t.meshes;if(a){const o=a.length;for(let h=0;h<o;++h){const d=new ee;n.meshes.push(d);const _=a[h],u=s.meshes[_];d.meshID=_;const b=u.primitives,T=b.length;for(let p=0;p<T;++p){const g=new se;d.primitives.push(g);const v=b[p];v.indices&&this._parseIndices(s,v,g),this._parseAttributes(s,v,g,r)}}}const f=t.children,l=f.length;for(let o=0;o<l;++o){const h=f[o],d=s.nodes[h];this._parseNode(s,d,n,r)}}_parseIndices(s,t,n){const i=t.indices,r=s.accessors[i];n.mode=t.mode||4,n.indicesComponentType=ne[r.componentType];const a=this;this._getBufferViewData(s,r.bufferView,function(f){n.indices=re(f,r),a._checkComplete()})}_parseAttributes(s,t,n,i){const r=Object.keys(t.attributes)[0],a=s.accessors[t.attributes[r]],f=a.bufferView,l=s.bufferViews[f],o=this;this._getBufferViewData(s,f,function(h){n.vertexBuffer=R(h,0,l.byteLength/k[a.componentType],a.componentType);for(const d in t.attributes){const _=t.attributes[d],u=s.accessors[_],b=k[u.componentType];u.byteStride/b,u.byteOffset/b,u.count,H(n.matrix,i),n.attributes[d]={size:E[u.type],type:u.componentType,stride:u.byteStride,offset:u.byteOffset}}o._checkComplete()})}loadGLTF(s,t){this._init(),this.onload=t||(i=>{console.log("glTF model loaded."),console.log(i)}),this.glTF=new te,this.baseUri=ie(s);const n=this;ae(s,function(i){const r=JSON.parse(i);let a;const f=l=>{if(n._buffers[a]=l,n._bufferLoaded++,n._bufferTasks[a]){let o,h;for(o=0,h=n._bufferTasks[a].length;o<h;++o)n._bufferTasks[a][o](l)}n._checkComplete()};if(r.buffers)for(a in r.buffers)n._bufferRequested++,fe(`${n.baseUri}/${r.buffers[a].uri}`,f);n._parseGLTF(r)})}}const S=N(),x=M(),B=N(),F=m(),k={5120:1,5121:1,5122:2,5123:2,5126:4},E={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ne={5121:"UNSIGNED_BYTE",5123:"UNSIGNED_SHORT",5124:"UNSIGNED_INT"};function R(e,s,t,n){switch(n){case 5122:return new Int16Array(e,s,t);case 5123:return new Uint16Array(e,s,t);case 5126:return new Float32Array(e,s,t);default:return null}}function re(e,s){return R(e,s.byteOffset,s.count*E[s.type],s.componentType)}function ie(e){let s="";const t=e.lastIndexOf("/");return t!==-1&&(s=e.substring(0,t+1)),s}function ae(e,s){const t=new XMLHttpRequest;t.overrideMimeType("application/json"),t.open("GET",e,!0),t.onreadystatechange=function(){t.readyState===4&&t.status===200&&s(t.responseText,this)},t.send(null)}function fe(e,s){const t=new XMLHttpRequest;t.responseType="arraybuffer",t.open("GET",e,!0),t.onreadystatechange=function(){if(t.readyState===4&&t.status===200){const n=t.response;n&&s&&s(n)}},t.send(null)}export{ue as G};
//# sourceMappingURL=gltf-loader-223361d8.js.map
