{"version":3,"file":"fbo_read_pixels.html-afd284fc.js","sources":["../../../../examples/src/WebGL2Samples/fbo_read_pixels.ts"],"sourcesContent":["import { CanvasContext, RenderObject, RenderPass, RenderPassDescriptor, RenderPassObject, RenderPipeline, Sampler, Texture, VertexAttributes } from \"@feng3d/render-api\";\nimport { WebGL } from \"@feng3d/webgl\";\nimport { getShaderSource } from \"./utility\";\n\nconst canvas = document.createElement(\"canvas\");\ncanvas.id = \"glcanvas\";\ncanvas.width = Math.min(window.innerWidth, window.innerHeight);\ncanvas.height = canvas.width;\ndocument.body.appendChild(canvas);\n\nconst renderingContext: CanvasContext = { canvasId: \"glcanvas\", webGLcontextId: \"webgl2\" };\nconst webgl = new WebGL(renderingContext);\n\n// -- Divide viewport\n\nconst windowSize = {\n    x: canvas.width,\n    y: canvas.height\n};\n\nconst Textures = {\n    RED: 0,\n    GREEN: 1,\n    BLUE: 2,\n    MAX: 3\n};\n\nconst viewport = new Array(Textures.MAX);\n\nviewport[Textures.RED] = {\n    x: windowSize.x / 2,\n    y: 0,\n    z: windowSize.x / 2,\n    w: windowSize.y / 2\n};\n\nviewport[Textures.GREEN] = {\n    x: windowSize.x / 2,\n    y: windowSize.y / 2,\n    z: windowSize.x / 2,\n    w: windowSize.y / 2\n};\n\nviewport[Textures.BLUE] = {\n    x: 0,\n    y: windowSize.y / 2,\n    z: windowSize.x / 2,\n    w: windowSize.y / 2\n};\n\n// -- Initialize program\n\n// Multiple out shaders\nconst multipleOutputProgram: RenderPipeline = {\n    vertex: { code: getShaderSource(\"vs-multiple-output\") }, fragment: { code: getShaderSource(\"fs-multiple-output\") },\n    primitive: { topology: \"triangle-list\" },\n};\n\n// Layer shaders\nconst layerProgram: RenderPipeline = {\n    vertex: { code: getShaderSource(\"vs-layer\") }, fragment: { code: getShaderSource(\"fs-layer\") },\n};\n\n// -- Initialize buffer\n\nconst positions = new Float32Array([\n    -1.0, -1.0,\n    1.0, -1.0,\n    1.0, 1.0,\n    1.0, 1.0,\n    -1.0, 1.0,\n    -1.0, -1.0\n]);\n\nconst texcoords = new Float32Array([\n    0.0, 0.0,\n    1.0, 0.0,\n    1.0, 1.0,\n    1.0, 1.0,\n    0.0, 1.0,\n    0.0, 0.0\n]);\n\n// -- Initialize vertex array\n\nconst multipleOutputVertexArray: { vertices?: VertexAttributes } = {\n    vertices: {\n        position: { data: positions, format: \"float32x2\" },\n    }\n};\n\nconst layerVertexArray: { vertices?: VertexAttributes } = {\n    vertices: {\n        position: { data: positions, format: \"float32x2\" },\n        textureCoordinates: { data: texcoords, format: \"float32x2\" },\n    }\n};\n\n// -- Initialize texture\n\nconst w = 16;\nconst h = 16;\n\nconst texture: Texture = {\n    dimension: \"2d-array\",\n    size: [w, h, 3],\n    format: \"rgba8unorm\",\n};\nconst sampler: Sampler = { lodMinClamp: 0, lodMaxClamp: 0, minFilter: \"nearest\", magFilter: \"nearest\" };\n\n// -- Initialize frame buffer\n\nconst frameBuffer: RenderPassDescriptor = {\n    colorAttachments: [\n        { view: { texture, baseMipLevel: 0, baseArrayLayer: Textures.RED } },\n        { view: { texture, baseMipLevel: 0, baseArrayLayer: Textures.GREEN } },\n        { view: { texture, baseMipLevel: 0, baseArrayLayer: Textures.BLUE } },\n    ]\n};\n\n// -- Render\n\n// Pass 1\nconst matrix = new Float32Array([\n    1.0, 0.0, 0.0, 0.0,\n    0.0, 1.0, 0.0, 0.0,\n    0.0, 0.0, 1.0, 0.0,\n    0.0, 0.0, 0.0, 1.0\n]);\nconst rp1: RenderPass = {\n    descriptor: frameBuffer,\n    renderPassObjects: [\n        {\n            viewport: { x: 0, y: 0, width: w, height: h },\n            pipeline: multipleOutputProgram,\n            bindingResources: { mvp: matrix },\n            vertices: multipleOutputVertexArray.vertices,\n            draw: { __type__: \"DrawVertex\", vertexCount: 6 },\n        }],\n};\n\nconst renderObjects: RenderPassObject[] = [];\n// Pass 2\nconst rp: RenderPass = {\n    descriptor: { colorAttachments: [{ clearValue: [0.0, 0.0, 0.0, 1.0], loadOp: \"clear\" }] },\n    renderPassObjects: renderObjects\n};\n\nconst ro: RenderObject = {\n    pipeline: layerProgram,\n    bindingResources: {\n        mvp: matrix,\n        diffuse: { texture, sampler },\n        layer: 0,\n    },\n    vertices: layerVertexArray.vertices,\n    draw: { __type__: \"DrawVertex\", vertexCount: 6 },\n};\n\nfor (let i = 0; i < Textures.MAX; ++i)\n{\n    renderObjects.push(\n        {\n            ...ro,\n            viewport: { x: viewport[i].x, y: viewport[i].y, width: viewport[i].z, height: viewport[i].w },\n            bindingResources: { ...ro.bindingResources, layer: i },\n        });\n}\n\nwebgl.submit({ commandEncoders: [{ passEncoders: [rp1, rp] }] });\n\nconst data = new Uint8Array(w * h * 4 * 3);\n\nlet result = webgl.readPixels({\n    textureView: frameBuffer.colorAttachments[0].view,\n    origin: [0, 0],\n    copySize: [w, h],\n});\ndata.set(new Uint8Array(result.buffer), 0);\nresult = webgl.readPixels({\n    textureView: frameBuffer.colorAttachments[1].view,\n    origin: [0, 0],\n    copySize: [w, h],\n});\ndata.set(new Uint8Array(result.buffer), w * h * 4);\nresult = webgl.readPixels({\n    textureView: frameBuffer.colorAttachments[2].view,\n    origin: [0, 0],\n    copySize: [w, h],\n});\ndata.set(new Uint8Array(result.buffer), w * h * 4 * 2);\n\nconsole.log(data);\n\n// Clean up\nwebgl.deleteFramebuffer(frameBuffer);\nwebgl.deleteTexture(texture);\nwebgl.deleteProgram(multipleOutputProgram);\nwebgl.deleteProgram(layerProgram);\n\n"],"names":["canvas","renderingContext","webgl","WebGL","windowSize","Textures","viewport","multipleOutputProgram","getShaderSource","layerProgram","positions","texcoords","multipleOutputVertexArray","layerVertexArray","w","h","texture","sampler","frameBuffer","matrix","rp1","renderObjects","rp","ro","data","result"],"mappings":"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"}