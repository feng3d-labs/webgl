{"version":3,"file":"transform_feedback_separated_2.html-a4e093dc.js","sources":["../../../../examples/src/WebGL2Samples/transform_feedback_separated_2.ts"],"sourcesContent":["import { CanvasContext, IndicesDataTypes, RenderObject, RenderPipeline, Submit, VertexAttributes, VertexDataTypes } from \"@feng3d/render-api\";\nimport { TransformFeedback, TransformFeedbackObject, TransformFeedbackPipeline, WebGL } from \"@feng3d/webgl\";\nimport { reactive } from \"@feng3d/reactivity\";\n\nimport { getShaderSource } from \"./utility\";\n\n(function ()\n{\n    // -- Init Canvas\n    const canvas = document.createElement(\"canvas\");\n    canvas.id = \"glcanvas\";\n    canvas.width = Math.min(window.innerWidth, window.innerHeight);\n    canvas.height = canvas.width;\n    document.body.appendChild(canvas);\n\n    // -- Init WebGL Context\n    const rc: CanvasContext = { canvasId: \"glcanvas\", webGLcontextId: \"webgl2\", webGLContextAttributes: { antialias: false } };\n    const webgl = new WebGL(rc);\n\n    canvas.addEventListener(\"webglcontextlost\", function (event)\n    {\n        event.preventDefault();\n    }, false);\n\n    // -- Declare variables for the particle system\n\n    const NUM_PARTICLES = 1000;\n    const ACCELERATION = -1.0;\n\n    const appStartTime = Date.now();\n    let currentSourceIdx = 0;\n\n    const [transformFeedbackPipeline, program] = initProgram();\n\n    // -- Initialize particle data\n\n    const particlePositions = new Float32Array(NUM_PARTICLES * 2);\n    const particleVelocities = new Float32Array(NUM_PARTICLES * 2);\n    const particleSpawntime = new Float32Array(NUM_PARTICLES);\n    const particleLifetime = new Float32Array(NUM_PARTICLES);\n    const particleIDs = new Float32Array(NUM_PARTICLES);\n\n    for (let p = 0; p < NUM_PARTICLES; ++p)\n    {\n        particlePositions[p * 2] = 0.0;\n        particlePositions[p * 2 + 1] = 0.0;\n        particleVelocities[p * 2] = 0.0;\n        particleVelocities[p * 2 + 1] = 0.0;\n        particleSpawntime[p] = 0.0;\n        particleLifetime[p] = 0.0;\n        particleIDs[p] = p;\n    }\n\n    const POSITION_LOCATION = 0;\n    const VELOCITY_LOCATION = 1;\n    const SPAWNTIME_LOCATION = 2;\n    const LIFETIME_LOCATION = 3;\n    const ID_LOCATION = 4;\n    const NUM_LOCATIONS = 5;\n\n    // -- Init Vertex Arrays and Buffers\n    const vertexArrays: { vertices?: VertexAttributes, indices?: IndicesDataTypes }[][] = [];\n\n    // Transform feedback objects track output buffer state\n    const transformFeedbacks: TransformFeedback[] = [];\n\n    const vertexBuffers: VertexDataTypes[][] = new Array(vertexArrays.length);\n\n    for (let i = 0; i < 2; ++i)\n    {\n        vertexBuffers[i] = new Array(NUM_LOCATIONS);\n\n        // Set up input\n        vertexBuffers[i][POSITION_LOCATION] = particlePositions.slice();\n\n        vertexBuffers[i][VELOCITY_LOCATION] = particleVelocities.slice();\n\n        vertexBuffers[i][SPAWNTIME_LOCATION] = particleSpawntime.slice();\n\n        vertexBuffers[i][LIFETIME_LOCATION] = particleLifetime.slice();\n\n        vertexBuffers[i][ID_LOCATION] = particleIDs;\n\n        vertexArrays[i] = [];\n        vertexArrays[i][0] = {\n            vertices: {\n                a_position: { data: vertexBuffers[i][POSITION_LOCATION], format: \"float32x2\" },\n                a_velocity: { data: vertexBuffers[i][VELOCITY_LOCATION], format: \"float32x2\" },\n                a_spawntime: { data: vertexBuffers[i][SPAWNTIME_LOCATION], format: \"float32\" },\n                a_lifetime: { data: vertexBuffers[i][LIFETIME_LOCATION], format: \"float32\" },\n                a_ID: { data: vertexBuffers[i][ID_LOCATION], format: \"float32\" },\n            }\n        };\n\n        vertexArrays[i][1] = {\n            vertices: {\n                a_position: { data: vertexBuffers[i][POSITION_LOCATION], format: \"float32x2\" },\n            }\n        };\n\n        // Set up output\n        transformFeedbacks[i] = {\n            bindBuffers: [\n                { index: 0, data: vertexBuffers[i][POSITION_LOCATION] },\n                { index: 1, data: vertexBuffers[i][VELOCITY_LOCATION] },\n                { index: 2, data: vertexBuffers[i][SPAWNTIME_LOCATION] },\n                { index: 3, data: vertexBuffers[i][LIFETIME_LOCATION] },\n            ]\n        };\n    }\n\n    function initProgram(): [TransformFeedbackPipeline, RenderPipeline]\n    {\n        const transformFeedbackPipeline: TransformFeedbackPipeline = {\n            vertex: { code: getShaderSource(\"vs-emit\") },\n            transformFeedbackVaryings: { varyings: [\"v_position\", \"v_velocity\", \"v_spawntime\", \"v_lifetime\"], bufferMode: \"SEPARATE_ATTRIBS\" },\n        };\n\n        const program: RenderPipeline = {\n            vertex: { code: getShaderSource(\"vs-draw\") },\n            fragment: {\n                code: getShaderSource(\"fs-draw\"),\n                targets: [{\n                    blend: {\n                        color: { srcFactor: \"src-alpha\", dstFactor: \"one\" },\n                        alpha: { srcFactor: \"src-alpha\", dstFactor: \"one\" },\n                    }\n                }]\n            },\n            primitive: { topology: \"point-list\" },\n        };\n\n        return [transformFeedbackPipeline, program];\n    }\n\n    const transformRO: TransformFeedbackObject = {\n        pipeline: transformFeedbackPipeline,\n        vertices: null,\n        transformFeedback: null,\n        uniforms: {\n            u_acceleration: [0.0, ACCELERATION],\n        },\n        draw: { __type__: \"DrawVertex\", vertexCount: NUM_PARTICLES },\n    };\n\n    const renderRO: RenderObject = {\n        viewport: { x: 0, y: 0, width: canvas.width, height: canvas.height - 10 },\n        pipeline: program,\n        bindingResources: {\n            u_color: [0.0, 1.0, 1.0, 1.0],\n        },\n        draw: { __type__: \"DrawVertex\", vertexCount: NUM_PARTICLES },\n    };\n\n    const submit: Submit = {\n        commandEncoders: [{\n            passEncoders: [\n                {\n                    __type__: \"TransformFeedbackPass\",\n                    transformFeedbackObjects: [transformRO],\n                },\n                {\n                    descriptor: { colorAttachments: [{ clearValue: [0.0, 0.0, 0.0, 1.0], loadOp: \"clear\" }] },\n                    renderPassObjects: [renderRO],\n                }\n            ]\n        }]\n    };\n\n    function transform()\n    {\n        const time = Date.now() - appStartTime;\n        const destinationIdx = (currentSourceIdx + 1) % 2;\n\n        // Toggle source and destination VBO\n        transformRO.vertices = vertexArrays[currentSourceIdx][0].vertices;\n        transformRO.transformFeedback = transformFeedbacks[destinationIdx];\n\n        reactive(transformRO.uniforms).u_time = time;\n\n        // Ping pong the buffers\n        currentSourceIdx = (currentSourceIdx + 1) % 2;\n    }\n\n    function render()\n    {\n        transform();\n\n        //\n        reactive(renderRO).vertices = vertexArrays[currentSourceIdx][1].vertices;\n        reactive(renderRO).indices = vertexArrays[currentSourceIdx][1].indices;\n\n        webgl.submit(submit);\n\n        requestAnimationFrame(render);\n    }\n\n    requestAnimationFrame(render);\n})();\n"],"names":["canvas","rc","webgl","WebGL","event","NUM_PARTICLES","ACCELERATION","appStartTime","currentSourceIdx","transformFeedbackPipeline","program","initProgram","particlePositions","particleVelocities","particleSpawntime","particleLifetime","particleIDs","p","POSITION_LOCATION","VELOCITY_LOCATION","SPAWNTIME_LOCATION","LIFETIME_LOCATION","ID_LOCATION","NUM_LOCATIONS","vertexArrays","transformFeedbacks","vertexBuffers","i","getShaderSource","transformRO","renderRO","submit","transform","time","destinationIdx","reactive","render"],"mappings":"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"}