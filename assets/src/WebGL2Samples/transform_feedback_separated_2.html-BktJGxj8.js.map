{"version":3,"file":"transform_feedback_separated_2.html-BktJGxj8.js","sources":["../../../../examples/src/WebGL2Samples/transform_feedback_separated_2.ts"],"sourcesContent":["import { reactive } from '@feng3d/reactivity';\nimport { CanvasContext, IndicesDataTypes, RenderObject, RenderPipeline, Submit, TransformFeedback, TransformFeedbackObject, TransformFeedbackPipeline, VertexAttributes, VertexData } from '@feng3d/render-api';\nimport { WebGL } from '@feng3d/webgl';\n\nimport { getShaderSource } from './utility';\n\n(function ()\n{\n    // -- Init Canvas\n    const canvas = document.createElement('canvas');\n\n    canvas.id = 'glcanvas';\n    canvas.width = Math.min(window.innerWidth, window.innerHeight);\n    canvas.height = canvas.width;\n    document.body.appendChild(canvas);\n\n    // -- Init WebGL Context\n    const rc: CanvasContext = { canvasId: 'glcanvas', webGLcontextId: 'webgl2', webGLContextAttributes: { antialias: false } };\n    const webgl = new WebGL(rc);\n\n    canvas.addEventListener('webglcontextlost', function (event)\n    {\n        event.preventDefault();\n    }, false);\n\n    // -- Declare variables for the particle system\n\n    const NUM_PARTICLES = 1000;\n    const ACCELERATION = -1.0;\n\n    const appStartTime = Date.now();\n    let currentSourceIdx = 0;\n\n    const [transformFeedbackPipeline, program] = initProgram();\n\n    // -- Initialize particle data\n\n    const particlePositions = new Float32Array(NUM_PARTICLES * 2);\n    const particleVelocities = new Float32Array(NUM_PARTICLES * 2);\n    const particleSpawntime = new Float32Array(NUM_PARTICLES);\n    const particleLifetime = new Float32Array(NUM_PARTICLES);\n    const particleIDs = new Float32Array(NUM_PARTICLES);\n\n    for (let p = 0; p < NUM_PARTICLES; ++p)\n    {\n        particlePositions[p * 2] = 0.0;\n        particlePositions[p * 2 + 1] = 0.0;\n        particleVelocities[p * 2] = 0.0;\n        particleVelocities[p * 2 + 1] = 0.0;\n        particleSpawntime[p] = 0.0;\n        particleLifetime[p] = 0.0;\n        particleIDs[p] = p;\n    }\n\n    const POSITION_LOCATION = 0;\n    const VELOCITY_LOCATION = 1;\n    const SPAWNTIME_LOCATION = 2;\n    const LIFETIME_LOCATION = 3;\n    const ID_LOCATION = 4;\n    const NUM_LOCATIONS = 5;\n\n    // -- Init Vertex Arrays and Buffers\n    const vertexArrays: { vertices?: VertexAttributes, indices?: IndicesDataTypes }[][] = [];\n\n    // Transform feedback objects track output buffer state\n    const transformFeedbacks: TransformFeedback[] = [];\n\n    const vertexBuffers: VertexData[][] = new Array(vertexArrays.length);\n\n    for (let i = 0; i < 2; ++i)\n    {\n        vertexBuffers[i] = new Array(NUM_LOCATIONS);\n\n        // Set up input\n        vertexBuffers[i][POSITION_LOCATION] = particlePositions.slice();\n\n        vertexBuffers[i][VELOCITY_LOCATION] = particleVelocities.slice();\n\n        vertexBuffers[i][SPAWNTIME_LOCATION] = particleSpawntime.slice();\n\n        vertexBuffers[i][LIFETIME_LOCATION] = particleLifetime.slice();\n\n        vertexBuffers[i][ID_LOCATION] = particleIDs;\n\n        vertexArrays[i] = [];\n        vertexArrays[i][0] = {\n            vertices: {\n                a_position: { data: vertexBuffers[i][POSITION_LOCATION], format: 'float32x2' },\n                a_velocity: { data: vertexBuffers[i][VELOCITY_LOCATION], format: 'float32x2' },\n                a_spawntime: { data: vertexBuffers[i][SPAWNTIME_LOCATION], format: 'float32' },\n                a_lifetime: { data: vertexBuffers[i][LIFETIME_LOCATION], format: 'float32' },\n                a_ID: { data: vertexBuffers[i][ID_LOCATION], format: 'float32' },\n            },\n        };\n\n        vertexArrays[i][1] = {\n            vertices: {\n                a_position: { data: vertexBuffers[i][POSITION_LOCATION], format: 'float32x2' },\n            },\n        };\n\n        // Set up output\n        transformFeedbacks[i] = {\n            bindBuffers: [\n                { index: 0, data: vertexBuffers[i][POSITION_LOCATION] },\n                { index: 1, data: vertexBuffers[i][VELOCITY_LOCATION] },\n                { index: 2, data: vertexBuffers[i][SPAWNTIME_LOCATION] },\n                { index: 3, data: vertexBuffers[i][LIFETIME_LOCATION] },\n            ],\n        };\n    }\n\n    function initProgram(): [TransformFeedbackPipeline, RenderPipeline]\n    {\n        const transformFeedbackPipeline: TransformFeedbackPipeline = {\n            vertex: { code: getShaderSource('vs-emit') },\n            transformFeedbackVaryings: { varyings: ['v_position', 'v_velocity', 'v_spawntime', 'v_lifetime'], bufferMode: 'SEPARATE_ATTRIBS' },\n        };\n\n        const program: RenderPipeline = {\n            vertex: { code: getShaderSource('vs-draw') },\n            fragment: {\n                code: getShaderSource('fs-draw'),\n                targets: [{\n                    blend: {\n                        color: { srcFactor: 'src-alpha', dstFactor: 'one' },\n                        alpha: { srcFactor: 'src-alpha', dstFactor: 'one' },\n                    },\n                }],\n            },\n            primitive: { topology: 'point-list' },\n        };\n\n        return [transformFeedbackPipeline, program];\n    }\n\n    const transformRO: TransformFeedbackObject = {\n        pipeline: transformFeedbackPipeline,\n        vertices: null,\n        transformFeedback: null,\n        uniforms: {\n            u_acceleration: { value: [0.0, ACCELERATION] },\n        },\n        draw: { __type__: 'DrawVertex', vertexCount: NUM_PARTICLES },\n    };\n\n    const renderRO: RenderObject = {\n        viewport: { x: 0, y: 0, width: canvas.width, height: canvas.height - 10 },\n        pipeline: program,\n        bindingResources: {\n            u_color: { value: [0.0, 1.0, 1.0, 1.0] },\n        },\n        draw: { __type__: 'DrawVertex', vertexCount: NUM_PARTICLES },\n    };\n\n    const submit: Submit = {\n        commandEncoders: [{\n            passEncoders: [\n                {\n                    __type__: 'TransformFeedbackPass',\n                    transformFeedbackObjects: [transformRO],\n                },\n                {\n                    descriptor: { colorAttachments: [{ clearValue: [0.0, 0.0, 0.0, 1.0], loadOp: 'clear' }] },\n                    renderPassObjects: [renderRO],\n                },\n            ],\n        }],\n    };\n\n    function transform()\n    {\n        const time = Date.now() - appStartTime;\n        const destinationIdx = (currentSourceIdx + 1) % 2;\n\n        // Toggle source and destination VBO\n        transformRO.vertices = vertexArrays[currentSourceIdx][0].vertices;\n        transformRO.transformFeedback = transformFeedbacks[destinationIdx];\n\n        reactive(transformRO.uniforms).u_time = { value: time };\n\n        // Ping pong the buffers\n        currentSourceIdx = (currentSourceIdx + 1) % 2;\n    }\n\n    function render()\n    {\n        transform();\n\n        //\n        reactive(renderRO).vertices = vertexArrays[currentSourceIdx][1].vertices;\n        reactive(renderRO).indices = vertexArrays[currentSourceIdx][1].indices;\n\n        webgl.submit(submit);\n\n        requestAnimationFrame(render);\n    }\n\n    requestAnimationFrame(render);\n})();\n"],"names":["canvas","rc","webgl","WebGL","event","NUM_PARTICLES","ACCELERATION","appStartTime","currentSourceIdx","transformFeedbackPipeline","program","initProgram","particlePositions","particleVelocities","particleSpawntime","particleLifetime","particleIDs","p","POSITION_LOCATION","VELOCITY_LOCATION","SPAWNTIME_LOCATION","LIFETIME_LOCATION","ID_LOCATION","NUM_LOCATIONS","vertexArrays","transformFeedbacks","vertexBuffers","i","getShaderSource","transformRO","renderRO","submit","transform","time","destinationIdx","reactive","render"],"mappings":"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"}